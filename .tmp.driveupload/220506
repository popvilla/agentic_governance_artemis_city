import React, { useState } from 'react';
import { ReviewResult } from '../types';
import SourceCitations from './SourceCitations';

interface FormattedFeedbackProps {
  reviewResult: ReviewResult;
  onApplySuggestion: (code: string) => void;
  onMakeItRun: (code: string) => Promise<void>;
  isMakingItRun: boolean;
}

const FormattedFeedback: React.FC<FormattedFeedbackProps> = ({ reviewResult, onApplySuggestion, onMakeItRun, isMakingItRun }) => {
  const { text, correctedCode, citations } = reviewResult;
  const [isApplied, setIsApplied] = useState(false);
  const [copiedBlock, setCopiedBlock] = useState<number | null>(null);

  const handleApplyClick = () => {
    if (correctedCode) {
      onApplySuggestion(correctedCode);
      setIsApplied(true);
      setTimeout(() => setIsApplied(false), 2000); // Reset after 2 seconds
    }
  };

  const handleMakeItRunClick = () => {
    if (correctedCode) {
      onMakeItRun(correctedCode);
    }
  };

  const handleCopy = (code: string, index: number) => {
    navigator.clipboard.writeText(code);
    setCopiedBlock(index);
    setTimeout(() => setCopiedBlock(null), 2000);
  };

  const renderMarkdown = (markdownText: string) => {
    const lines = markdownText.split('\n');
    const elements: React.ReactElement[] = [];
    let inCodeBlock = false;
    let codeBlockContent = '';
    let codeBlockLang = '';
    let codeBlockIndex = 0;

    const flushCodeBlock = () => {
      if (codeBlockContent) {
        const currentIndex = codeBlockIndex++;
        const blockContentForClipboard = codeBlockContent;
        const blockContentForDisplay = codeBlockContent.trimEnd();
        
        elements.push(
          <div key={`code-block-${currentIndex}`} className="my-4 rounded-md bg-slate-200 dark:bg-slate-900 overflow-hidden relative group">
            <div className="flex justify-between items-center px-4 py-1 bg-slate-300 dark:bg-slate-950">
              <span className="text-xs font-sans text-slate-500 dark:text-slate-400">{codeBlockLang || 'code'}</span>
               <button
                onClick={() => handleCopy(blockContentForClipboard, currentIndex)}
                className="flex items-center gap-1.5 text-xs bg-slate-400 dark:bg-slate-700 hover:bg-slate-500 dark:hover:bg-slate-600 text-slate-800 dark:text-slate-300 font-semibold py-1 px-2 rounded-md transition-all duration-200 opacity-0 group-hover:opacity-100 focus:opacity-100"
              >
                 {copiedBlock === currentIndex ? (
                    <>
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={3}>
                           <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
                        </svg>
                        Copied!
                    </>
                ) : (
                    <>
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                           <path strokeLinecap="round" strokeLinejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        Copy
                    </>
                )}
              </button>
            </div>
            <pre className="p-4 text-sm text-slate-800 dark:text-slate-200 overflow-x-auto">
              <code>{blockContentForDisplay}</code>
            </pre>
          </div>
        );
        codeBlockContent = '';
        codeBlockLang = '';
      }
    };

    lines.forEach((line, index) => {
      if (line.startsWith('```')) {
        if (inCodeBlock) {
          flushCodeBlock();
          inCodeBlock = false;
        } else {
          inCodeBlock = true;
          codeBlockLang = line.substring(3).trim();
        }
        return;
      }

      if (inCodeBlock) {
        codeBlockContent += line + '\n';
        return;
      }

       if (line.startsWith('### ')) {
        elements.push(<h3 key={index} className="text-lg font-bold mt-6 mb-2 text-cyan-600 dark:text-cyan-400">{line.substring(4)}</h3>);
      } else if (line.startsWith('## ')) {
        elements.push(<h2 key={index} className="text-xl font-bold mt-8 mb-3 border-b border-slate-300 dark:border-slate-600 pb-2 text-cyan-700 dark:text-cyan-300">{line.substring(3)}</h2>);
      } else if (line.startsWith('# ')) {
        elements.push(<h1 key={index} className="text-2xl font-bold mt-8 mb-4 border-b-2 border-slate-400 dark:border-slate-500 pb-2 text-cyan-800 dark:text-cyan-200">{line.substring(2)}</h1>);
      } else if (line.match(/^(\*|-)\s/)) {
        // Sanitize before processing to prevent XSS
        const sanitizedLine = line.substring(2).replace(/</g, "&lt;").replace(/>/g, "&gt;");
        const formattedLine = sanitizedLine.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-slate-900 dark:text-slate-100">$1</strong>');
        elements.push(
          <li key={index} className="ml-6 list-disc text-slate-700 dark:text-slate-300 my-1" dangerouslySetInnerHTML={{ __html: formattedLine }}>
          </li>
        );
      } else {
        // Sanitize before processing to prevent XSS
        const sanitizedLine = line.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        const formattedLine = sanitizedLine.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-slate-900 dark:text-slate-100">$1</strong>');
        elements.push(<p key={index} className="my-2 text-slate-700 dark:text-slate-300 leading-relaxed" dangerouslySetInnerHTML={{ __html: formattedLine }} />);
      }
    });

    flushCodeBlock();

    return elements;
  };

  return (
    <div className="prose prose-sm max-w-none prose-invert dark:prose-invert font-sans break-words">
      {renderMarkdown(text)}
      {correctedCode && (
        <div className="mt-8 pt-4 border-t border-slate-300 dark:border-slate-700">
            <h3 className="text-lg font-bold mt-6 mb-2 text-cyan-600 dark:text-cyan-400">Suggested Code</h3>
            <div className="my-4 rounded-md bg-slate-200 dark:bg-slate-900 overflow-hidden">
                <div className="flex justify-between items-center px-4 py-2 bg-slate-300 dark:bg-slate-950">
                <span className="text-xs font-sans text-slate-500 dark:text-slate-400">Corrected Snippet</span>
                <button
                    onClick={handleApplyClick}
                    className="flex items-center text-xs bg-cyan-600 dark:bg-cyan-700 hover:bg-cyan-700 dark:hover:bg-cyan-600 text-white font-semibold py-1 px-3 rounded-md transition-colors duration-200"
                >
                    {isApplied ? (
                        <>
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                            </svg>
                            Applied!
                        </>
                    ) : (
                        <>
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Apply Suggestion
                        </>
                    )}
                </button>
                </div>
                <pre className="p-4 text-sm text-slate-800 dark:text-slate-200 overflow-x-auto">
                <code>{correctedCode}</code>
                </pre>
            </div>
             <div className="mt-4">
                <button
                  onClick={handleMakeItRunClick}
                  disabled={isMakingItRun}
                  className="w-full flex items-center justify-center bg-teal-600 hover:bg-teal-500 disabled:bg-slate-400 dark:disabled:bg-slate-600 disabled:cursor-not-allowed disabled:opacity-75 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200"
                >
                  {isMakingItRun ? (
                    <>
                      <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      Making it Run...
                    </>
                  ) : (
                    <>
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                           <path strokeLinecap="round" strokeLinejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        Make it Run
                    </>
                  )}
                </button>
            </div>
        </div>
      )}
      {citations && citations.length > 0 && <SourceCitations citations={citations} />}
    </div>
  );
};

export default FormattedFeedback;
