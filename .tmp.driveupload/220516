import React from 'react';
import { marked } from 'marked';
import hljs from 'highlight.js';
import { ChatMessage, MessageSender } from '../types';

marked.setOptions({
  highlight: function(code, lang) {
    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
    return hljs.highlight(code, { language }).value;
  },
  langPrefix: 'hljs language-',
});

interface MessageItemProps {
  message: ChatMessage;
}

const SenderAvatar: React.FC<{ sender: MessageSender }> = ({ sender }) => {
  let avatarChar = '';
  let bgColorClass = '';
  let textColorClass = '';

  if (sender === MessageSender.USER) {
    avatarChar = 'U';
    bgColorClass = 'bg-slate-500 dark:bg-white/[.12]';
    textColorClass = 'text-white dark:text-white';
  } else if (sender === MessageSender.MODEL) {
    avatarChar = 'AI';
    bgColorClass = 'bg-gradient-to-br from-purple-500 to-indigo-600'; 
    textColorClass = 'text-white';
  } else { // SYSTEM
    avatarChar = 'S';
    bgColorClass = 'bg-slate-400 dark:bg-slate-600';
    textColorClass = 'text-slate-800 dark:text-slate-200';
  }

  return (
    <div className={`w-8 h-8 rounded-full ${bgColorClass} ${textColorClass} flex items-center justify-center text-sm font-semibold flex-shrink-0`}>
      {avatarChar}
    </div>
  );
};

const MessageItem: React.FC<MessageItemProps> = ({ message }) => {
  const isUser = message.sender === MessageSender.USER;
  const isModel = message.sender === MessageSender.MODEL;
  const isSystem = message.sender === MessageSender.SYSTEM;

  const renderMessageContent = () => {
    if ((isModel || isSystem) && !message.isLoading) {
      const proseClasses = "prose prose-sm prose-invert max-w-none dark:prose-invert"; 
      // Basic sanitization to prevent XSS. For production apps, a more robust library like DOMPurify is recommended.
      const sanitizedText = (message.text || "").replace(/<script\b[^>]*>([\s\S]*?)<\/script>/gim, '');
      const rawMarkup = marked.parse(sanitizedText) as string;
      return <div className={proseClasses} dangerouslySetInnerHTML={{ __html: rawMarkup }} />;
    }
    
    return <div className="whitespace-pre-wrap text-sm">{message.text}</div>;
  };
  
  let bubbleClasses = "p-3 rounded-lg shadow-md w-full ";

  if (isUser) {
    bubbleClasses += "bg-slate-700/90 dark:bg-slate-700/80 text-white dark:text-white rounded-br-none";
  } else if (isModel) {
    bubbleClasses += `bg-white dark:bg-slate-800/60 border border-slate-200 dark:border-slate-700/50 rounded-bl-none text-slate-800 dark:text-slate-200`;
  } else { // System message
    bubbleClasses += "bg-transparent dark:bg-slate-900 border border-slate-300 dark:border-slate-700 text-slate-500 dark:text-slate-400 text-xs italic rounded-bl-none rounded-br-none";
  }

  return (
    <div className={`flex mb-4 ${isUser ? 'justify-end' : 'justify-start'} ${isSystem ? 'justify-center' : ''}`}>
      {isSystem ? (
         <div className={bubbleClasses + ' max-w-[95%]'}>
           {renderMessageContent()}
        </div>
      ) : (
        <div className={`flex items-start gap-2.5 max-w-[85%]`}>
            {!isUser && <SenderAvatar sender={message.sender} />}
            <div className={bubbleClasses}>
            {message.isLoading ? (
                <div className="flex items-center space-x-2 text-slate-500 dark:text-slate-400">
                <div className="flex items-center space-x-1.5">
                    <div className="w-1.5 h-1.5 bg-current rounded-full animate-bounce [animation-delay:-0.3s]"></div>
                    <div className="w-1.5 h-1.5 bg-current rounded-full animate-bounce [animation-delay:-0.15s]"></div>
                    <div className="w-1.5 h-1.5 bg-current rounded-full animate-bounce"></div>
                </div>
                <span className="text-sm animate-pulse">{message.text}</span>
                </div>
            ) : (
                renderMessageContent()
            )}
            </div>
            {isUser && <SenderAvatar sender={message.sender} />}
        </div>
      )}
    </div>
  );
};

export default MessageItem;
