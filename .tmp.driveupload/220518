import React, { useState } from 'react';
import { Plus, Trash2, ChevronDown, X } from 'lucide-react';
import { URLGroup } from '../types';

interface KnowledgeBaseManagerProps {
  urls: string[];
  onAddUrl: (url: string) => void;
  onRemoveUrl: (url: string) => void;
  maxUrls?: number;
  urlGroups: URLGroup[];
  activeUrlGroupId: string;
  onSetGroupId: (id: string) => void;
  onCreateUrlGroup: (name: string) => void;
  onCloseSidebar?: () => void;
}

const KnowledgeBaseManager: React.FC<KnowledgeBaseManagerProps> = ({
  urls,
  onAddUrl,
  onRemoveUrl,
  maxUrls = 20,
  urlGroups,
  activeUrlGroupId,
  onSetGroupId,
  onCreateUrlGroup,
  onCloseSidebar,
}) => {
  const [currentUrlInput, setCurrentUrlInput] = useState('');
  const [error, setError] = useState<string | null>(null);
  const [isCreatingGroup, setIsCreatingGroup] = useState(false);
  const [newGroupName, setNewGroupName] = useState('');

  const isValidUrl = (urlString: string): boolean => {
    try {
      new URL(urlString);
      return true;
    } catch (e) {
      return false;
    }
  };

  const handleAddUrl = () => {
    if (!currentUrlInput.trim()) {
      setError('URL cannot be empty.');
      return;
    }
    if (!isValidUrl(currentUrlInput)) {
      setError('Invalid URL format. Please include http:// or https://');
      return;
    }
    if (urls.length >= maxUrls) {
      setError(`You can add a maximum of ${maxUrls} URLs to the current group.`);
      return;
    }
    if (urls.includes(currentUrlInput)) {
      setError('This URL has already been added to the current group.');
      return;
    }
    onAddUrl(currentUrlInput);
    setCurrentUrlInput('');
    setError(null);
  };

  const handleCreateGroup = () => {
    const trimmedName = newGroupName.trim();
    if (!trimmedName) {
      setError("Group name cannot be empty.");
      return;
    }
    const isDuplicate = urlGroups.some(g => g.name.toLowerCase() === trimmedName.toLowerCase());
    if (isDuplicate) {
      setError("A group with this name already exists.");
      return;
    }
    onCreateUrlGroup(trimmedName);
    setNewGroupName('');
    setIsCreatingGroup(false);
    setError(null);
  };

  const activeGroupName = urlGroups.find(g => g.id === activeUrlGroupId)?.name || "Unknown Group";

  return (
    <div className="p-4 h-full flex flex-col">
      {/* --- Group Management --- */}
      <div className="mb-3">
        <label htmlFor="url-group-select-kb" className="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">
          Active URL Group
        </label>
        <div className="relative w-full">
          <select
            id="url-group-select-kb"
            value={activeUrlGroupId}
            onChange={(e) => onSetGroupId(e.target.value)}
            className="w-full py-2 pl-3 pr-8 appearance-none border border-slate-300 dark:border-slate-700 bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-slate-200 rounded-md focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 text-sm"
          >
            {urlGroups.map(group => (
              <option key={group.id} value={group.id}>
                {group.name}
              </option>
            ))}
          </select>
          <ChevronDown
            className="absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400 pointer-events-none"
            aria-hidden="true"
          />
        </div>
      </div>
      
      {!isCreatingGroup ? (
        <button
          onClick={() => { setIsCreatingGroup(true); setError(null); }}
          className="w-full flex items-center justify-center text-sm p-2 rounded-md bg-slate-200/50 dark:bg-slate-700/50 hover:bg-slate-300/70 dark:hover:bg-slate-700 transition-colors mb-3 text-slate-600 dark:text-slate-300"
        >
          <Plus size={16} className="mr-1.5" />
          Create New Group
        </button>
      ) : (
        <div className="p-3 mb-3 border border-slate-300 dark:border-slate-700 rounded-lg bg-slate-100 dark:bg-slate-800">
          <p className="text-sm font-medium mb-2 text-slate-800 dark:text-slate-200">New Group Name</p>
          <input
            type="text"
            value={newGroupName}
            onChange={(e) => setNewGroupName(e.target.value)}
            placeholder="e.g., 'React Docs'"
            className="w-full h-8 py-1 px-2.5 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-500 rounded-lg focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 transition-shadow text-sm"
            onKeyPress={(e) => e.key === 'Enter' && handleCreateGroup()}
          />
          <div className="flex items-center gap-2 mt-2">
            <button onClick={handleCreateGroup} className="flex-1 text-sm py-1.5 px-3 bg-slate-600 hover:bg-slate-700 text-white dark:bg-slate-600 dark:hover:bg-slate-500 rounded-md transition-colors">
              Create
            </button>
            <button onClick={() => { setIsCreatingGroup(false); setNewGroupName(''); setError(null); }} className="flex-1 text-sm py-1.5 px-3 bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-white rounded-md transition-colors">
              Cancel
            </button>
          </div>
        </div>
      )}
      
      {/* --- URL Management --- */}
      <h3 className="text-base font-semibold text-slate-800 dark:text-slate-200 mb-2 border-t border-slate-300 dark:border-slate-700 pt-3">Add URLs to Group</h3>
      <div className="flex items-center gap-2 mb-3">
        <input
          type="url"
          value={currentUrlInput}
          onChange={(e) => setCurrentUrlInput(e.target.value)}
          placeholder="https://docs.example.com"
          className="flex-grow h-8 py-1 px-2.5 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-500 rounded-lg focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 transition-shadow text-sm"
          onKeyPress={(e) => e.key === 'Enter' && handleAddUrl()}
        />
        <button
          onClick={handleAddUrl}
          disabled={urls.length >= maxUrls}
          className="h-8 w-8 p-1.5 bg-slate-600 hover:bg-slate-700 text-white dark:bg-slate-600 dark:hover:bg-slate-500 rounded-lg transition-colors disabled:opacity-50 flex items-center justify-center flex-shrink-0"
          aria-label="Add URL"
        >
          <Plus size={16} />
        </button>
      </div>
      
      {error && <p className="text-xs text-red-500 mb-2">{error}</p>}
      {urls.length >= maxUrls && <p className="text-xs text-yellow-500 mb-2">Maximum {maxUrls} URLs reached for this group.</p>}
            
      <div className="flex-grow overflow-y-auto space-y-2">
        {urls.length === 0 && (
          <p className="text-slate-500 dark:text-slate-500 text-center py-3 text-sm">Add documentation URLs to the group "{activeGroupName}" to start querying.</p>
        )}
        {urls.map((url) => (
          <div key={url} className="flex items-center justify-between p-2.5 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700/50 rounded-lg">
            <a href={url} target="_blank" rel="noopener noreferrer" className="text-xs text-cyan-600 dark:text-cyan-400 hover:underline truncate" title={url}>
              {url}
            </a>
            <button
               onClick={() => onRemoveUrl(url)}
              className="p-1 text-slate-500 dark:text-slate-400 hover:text-red-500 dark:hover:text-red-400 rounded-md hover:bg-red-100 dark:hover:bg-red-500/10 transition-colors flex-shrink-0 ml-2"
              aria-label={`Remove ${url}`}
            >
              <Trash2 size={16} />
            </button>
          </div>
        ))}
      </div>
    </div>
  );
};

export default KnowledgeBaseManager;