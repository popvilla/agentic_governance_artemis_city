<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Artemis City - Living Agent Ecosystem</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes pulse-glow {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.6; }
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin { animation: spin 1s linear infinite; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, sans-serif;
      background: #0f172a;
    }
    .font-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    // Custom SVG Line Chart Component
    const LineChart = ({ data, width = 600, height = 200 }) => {
      const padding = { top: 20, right: 20, bottom: 30, left: 40 };
      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;

      const maxY = 100;
      const minY = 0;
      const maxX = data.length - 1;

      const xScale = (i) => padding.left + (i / maxX) * chartWidth;
      const yScale = (val) => padding.top + chartHeight - ((val - minY) / (maxY - minY)) * chartHeight;

      const pathD = data.map((d, i) => `${i === 0 ? 'M' : 'L'} ${xScale(i)} ${yScale(d.trust)}`).join(' ');
      const areaD = pathD + ` L ${xScale(data.length - 1)} ${yScale(0)} L ${xScale(0)} ${yScale(0)} Z`;

      return (
        <svg width="100%" height={height} viewBox={`0 0 ${width} ${height}`} preserveAspectRatio="xMidYMid meet">
          <defs>
            <linearGradient id="areaGradient" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stopColor="#00ffcc" stopOpacity="0.3"/>
              <stop offset="100%" stopColor="#00ffcc" stopOpacity="0"/>
            </linearGradient>
          </defs>

          {/* Grid lines */}
          {[0, 25, 50, 75, 100].map(val => (
            <g key={val}>
              <line x1={padding.left} y1={yScale(val)} x2={width - padding.right} y2={yScale(val)} stroke="#334155" strokeDasharray="3,3" />
              <text x={padding.left - 8} y={yScale(val) + 4} fill="#64748b" fontSize="10" textAnchor="end">{val}</text>
            </g>
          ))}

          {/* X axis labels */}
          {[0, 10, 20, 30].map(day => (
            <text key={day} x={xScale(day)} y={height - 8} fill="#64748b" fontSize="10" textAnchor="middle">{day}</text>
          ))}

          {/* Area fill */}
          <path d={areaD} fill="url(#areaGradient)" />

          {/* Line */}
          <path d={pathD} fill="none" stroke="#00ffcc" strokeWidth="2" />

          {/* Data points */}
          {data.map((d, i) => (
            <circle key={i} cx={xScale(i)} cy={yScale(d.trust)} r="3" fill="#00ffcc" opacity={d.event ? 1 : 0} />
          ))}

          {/* Axis labels */}
          <text x={width / 2} y={height - 2} fill="#64748b" fontSize="10" textAnchor="middle">Days</text>
          <text x={12} y={height / 2} fill="#64748b" fontSize="10" textAnchor="middle" transform={`rotate(-90, 12, ${height / 2})`}>Trust Score</text>
        </svg>
      );
    };

    // Icon Components
    const Icon = ({ name, size = 20, className = "", style = {} }) => {
      const icons = {
        zap: <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
        cpu: <><rect x="4" y="4" width="16" height="16" rx="2" ry="2" fill="none" stroke="currentColor" strokeWidth="2"/><rect x="9" y="9" width="6" height="6" fill="none" stroke="currentColor" strokeWidth="2"/><line x1="9" y1="1" x2="9" y2="4" stroke="currentColor" strokeWidth="2"/><line x1="15" y1="1" x2="15" y2="4" stroke="currentColor" strokeWidth="2"/><line x1="9" y1="20" x2="9" y2="23" stroke="currentColor" strokeWidth="2"/><line x1="15" y1="20" x2="15" y2="23" stroke="currentColor" strokeWidth="2"/><line x1="20" y1="9" x2="23" y2="9" stroke="currentColor" strokeWidth="2"/><line x1="20" y1="14" x2="23" y2="14" stroke="currentColor" strokeWidth="2"/><line x1="1" y1="9" x2="4" y2="9" stroke="currentColor" strokeWidth="2"/><line x1="1" y1="14" x2="4" y2="14" stroke="currentColor" strokeWidth="2"/></>,
        layers: <><polygon points="12 2 2 7 12 12 22 7 12 2" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><polyline points="2 17 12 22 22 17" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><polyline points="2 12 12 17 22 12" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
        database: <><ellipse cx="12" cy="5" rx="9" ry="3" fill="none" stroke="currentColor" strokeWidth="2"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" fill="none" stroke="currentColor" strokeWidth="2"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" fill="none" stroke="currentColor" strokeWidth="2"/></>,
        arrowDown: <><line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><polyline points="19 12 12 19 5 12" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
        shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
        send: <><path d="M22 2L11 13" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M22 2l-7 20-4-9-9-4 20-7z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
        play: <polygon points="5 3 19 12 5 21 5 3" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
        chevronRight: <path d="M9 18l6-6-6-6" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
        terminal: <><polyline points="4 17 10 11 4 5" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><line x1="12" y1="19" x2="20" y2="19" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
        users: <><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><circle cx="9" cy="7" r="4" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M23 21v-2a4 4 0 0 0-3-3.87" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M16 3.13a4 4 0 0 1 0 7.75" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
        brain: <><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
        package: <><path d="M16.5 9.4l-9-5.19" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><polyline points="3.27 6.96 12 12.01 20.73 6.96" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><line x1="12" y1="22.08" x2="12" y2="12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
        settings: <><circle cx="12" cy="12" r="3" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
        checkCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><polyline points="22 4 12 14.01 9 11.01" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
        alertTriangle: <><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><line x1="12" y1="9" x2="12" y2="13" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><line x1="12" y1="17" x2="12.01" y2="17" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
        clock: <><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><polyline points="12 6 12 12 16 14" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
        sparkles: <><path d="M12 3l1.5 4.5L18 9l-4.5 1.5L12 15l-1.5-4.5L6 9l4.5-1.5L12 3z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M19 13l1 3 3 1-3 1-1 3-1-3-3-1 3-1 1-3z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
        user: <><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><circle cx="12" cy="7" r="4" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
        target: <><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" strokeWidth="2"/><circle cx="12" cy="12" r="6" fill="none" stroke="currentColor" strokeWidth="2"/><circle cx="12" cy="12" r="2" fill="none" stroke="currentColor" strokeWidth="2"/></>,
        // City icons
        building: <><rect x="4" y="2" width="16" height="20" rx="2" ry="2" fill="none" stroke="currentColor" strokeWidth="2"/><line x1="9" y1="22" x2="9" y2="2" stroke="currentColor" strokeWidth="2"/><line x1="15" y1="22" x2="15" y2="2" stroke="currentColor" strokeWidth="2"/><line x1="4" y1="12" x2="20" y2="12" stroke="currentColor" strokeWidth="2"/></>,
        mail: <><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" fill="none" stroke="currentColor" strokeWidth="2"/><polyline points="22,6 12,13 2,6" fill="none" stroke="currentColor" strokeWidth="2"/></>,
        mailOpen: <><path d="M22 10V6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v4l10 6 10-6z" fill="none" stroke="currentColor" strokeWidth="2"/><path d="M2 10v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V10l-10 6-10-6z" fill="none" stroke="currentColor" strokeWidth="2"/></>,
        inbox: <><polyline points="22 12 16 12 14 15 10 15 8 12 2 12" fill="none" stroke="currentColor" strokeWidth="2"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z" fill="none" stroke="currentColor" strokeWidth="2"/></>,
        archive: <><polyline points="21 8 21 21 3 21 3 8" fill="none" stroke="currentColor" strokeWidth="2"/><rect x="1" y="3" width="22" height="5" fill="none" stroke="currentColor" strokeWidth="2"/><line x1="10" y1="12" x2="14" y2="12" stroke="currentColor" strokeWidth="2"/></>,
        helpCircle: <><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" strokeWidth="2"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" fill="none" stroke="currentColor" strokeWidth="2"/><line x1="12" y1="17" x2="12.01" y2="17" stroke="currentColor" strokeWidth="2"/></>,
        mapPin: <><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" fill="none" stroke="currentColor" strokeWidth="2"/><circle cx="12" cy="10" r="3" fill="none" stroke="currentColor" strokeWidth="2"/></>,
        home: <><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" fill="none" stroke="currentColor" strokeWidth="2"/><polyline points="9 22 9 12 15 12 15 22" fill="none" stroke="currentColor" strokeWidth="2"/></>,
        truck: <><rect x="1" y="3" width="15" height="13" fill="none" stroke="currentColor" strokeWidth="2"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8" fill="none" stroke="currentColor" strokeWidth="2"/><circle cx="5.5" cy="18.5" r="2.5" fill="none" stroke="currentColor" strokeWidth="2"/><circle cx="18.5" cy="18.5" r="2.5" fill="none" stroke="currentColor" strokeWidth="2"/></>,
        activity: <><polyline points="22 12 18 12 15 21 9 3 6 12 2 12" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
        globe: <><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" strokeWidth="2"/><line x1="2" y1="12" x2="22" y2="12" stroke="currentColor" strokeWidth="2"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" fill="none" stroke="currentColor" strokeWidth="2"/></>,
        userCircle: <><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" strokeWidth="2"/><circle cx="12" cy="10" r="3" fill="none" stroke="currentColor" strokeWidth="2"/><path d="M6.168 18.849A4 4 0 0 1 10 16h4a4 4 0 0 1 3.834 2.855" fill="none" stroke="currentColor" strokeWidth="2"/></>,
        clipboard: <><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" fill="none" stroke="currentColor" strokeWidth="2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1" fill="none" stroke="currentColor" strokeWidth="2"/></>,
        fileText: <><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" fill="none" stroke="currentColor" strokeWidth="2"/><polyline points="14 2 14 8 20 8" fill="none" stroke="currentColor" strokeWidth="2"/><line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" strokeWidth="2"/><line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" strokeWidth="2"/><polyline points="10 9 9 9 8 9" fill="none" stroke="currentColor" strokeWidth="2"/></>,
        book: <><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" fill="none" stroke="currentColor" strokeWidth="2"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" fill="none" stroke="currentColor" strokeWidth="2"/></>,
      };
      return (
        <svg width={size} height={size} viewBox="0 0 24 24" className={className} style={style}>
          {icons[name]}
        </svg>
      );
    };

    // ATP Constants
    const ATP_MODES = ["Build", "Review", "Organize", "Capture", "Synthesize", "Commit"];
    const ATP_PRIORITIES = ["Critical", "High", "Normal", "Low"];
    const ATP_ACTION_TYPES = ["Summarize", "Scaffold", "Execute", "Reflect"];

    // Global Hebbian Weights (shared state)
    const useHebbianWeights = () => {
      const [weights, setWeights] = React.useState({
        'artemis-copilot': 0.3,
        'artemis-packrat': 0.2,
        'artemis-daemon': 0.5,
        'copilot-packrat': 0.4,
        'copilot-daemon': 0.3,
        'packrat-daemon': 0.6
      });

      const hebbianUpdate = (agent1, agent2, learningRate = 0.15) => {
        const key = [agent1, agent2].sort().join('-');
        setWeights(prev => ({
          ...prev,
          [key]: Math.min(1, prev[key] + learningRate)
        }));
      };

      const decayWeights = (decayRate = 0.05) => {
        setWeights(prev => {
          const newWeights = {...prev};
          Object.keys(newWeights).forEach(key => {
            newWeights[key] = Math.max(0.1, newWeights[key] - decayRate);
          });
          return newWeights;
        });
      };

      const getWeight = (agent1, agent2) => {
        const key = [agent1, agent2].sort().join('-');
        return weights[key] || 0;
      };

      const getAgentStrength = (agentId) => {
        // Sum of all connection weights for this agent
        return Object.entries(weights)
          .filter(([key]) => key.includes(agentId))
          .reduce((sum, [, weight]) => sum + weight, 0);
      };

      return { weights, setWeights, hebbianUpdate, decayWeights, getWeight, getAgentStrength };
    };

    // Agent Definitions
    // ═══════════════════════════════════════════════════════════════════════════
    // ARTEMIS CITY - CITIZENS & LOCATIONS
    // Where agents aren't just code—they're citizens of a thriving ecosystem!
    // ═══════════════════════════════════════════════════════════════════════════

    const AGENTS = {
      artemis: {
        name: "Artemis",
        role: "Mayor",
        title: "City Mayor",
        icon: "shield",
        color: "#00ffcc",
        keywords: ["artemis", "governance", "policy", "audit", "dispute", "review", "mayor"],
        description: "Governance and oversight of Artemis City",
        office: "City Hall",
        clearance: 0.95,
        duties: ["Policy decisions", "Dispute resolution", "City planning"]
      },
      copilot: {
        name: "Copilot",
        role: "Assistant",
        title: "Information Desk",
        icon: "brain",
        color: "#ff6b6b",
        keywords: ["help", "assist", "explain", "augment", "clarify", "suggest", "info"],
        description: "Citizen assistance and information services",
        office: "Information Desk",
        clearance: 0.80,
        duties: ["Help citizens", "Provide context", "Answer queries"]
      },
      packrat: {
        name: "Pack Rat",
        role: "Postmaster",
        title: "Postal Service",
        icon: "package",
        color: "#ffd93d",
        keywords: ["transfer", "send", "receive", "courier", "data", "mail", "postal", "deliver"],
        description: "Secure mail delivery and routing",
        office: "Post Office",
        clearance: 0.85,
        duties: ["Deliver mail", "Maintain postal logs", "Route messages"]
      },
      daemon: {
        name: "Codex Daemon",
        role: "City Manager",
        title: "Operations Center",
        icon: "settings",
        color: "#6c5ce7",
        keywords: ["memory", "system", "daemon", "config", "status", "health", "monitor"],
        description: "System monitoring and city operations",
        office: "Operations Center",
        clearance: 0.85,
        duties: ["Monitor city health", "Manage configuration", "Status reports"]
      }
    };

    // City Locations & Buildings
    const CITY_LOCATIONS = {
      cityHall: { name: "City Hall", icon: "building", color: "#00ffcc", citizen: "artemis" },
      postOffice: { name: "Post Office", icon: "mail", color: "#ffd93d", citizen: "packrat" },
      infoDesk: { name: "Information Desk", icon: "helpCircle", color: "#ff6b6b", citizen: "copilot" },
      opsCenter: { name: "Operations Center", icon: "settings", color: "#6c5ce7", citizen: "daemon" },
      archives: { name: "City Archives", icon: "database", color: "#22c55e", citizen: null },
      trustOffice: { name: "Trust Office", icon: "shield", color: "#f59e0b", citizen: null }
    };

    // Clearance Levels
    const CLEARANCE_LEVELS = {
      FULL: { min: 0.9, max: 1.0, label: "FULL", color: "#00ffcc", permissions: ["read", "write", "search", "tag", "update", "delete", "admin"] },
      HIGH: { min: 0.7, max: 0.9, label: "HIGH", color: "#22c55e", permissions: ["read", "write", "search", "tag", "update"] },
      MEDIUM: { min: 0.5, max: 0.7, label: "MEDIUM", color: "#fbbf24", permissions: ["read", "write", "search", "tag"] },
      LOW: { min: 0.3, max: 0.5, label: "LOW", color: "#f97316", permissions: ["read", "search"] },
      UNTRUSTED: { min: 0.0, max: 0.3, label: "UNTRUSTED", color: "#ef4444", permissions: [] }
    };

    const getClearanceLevel = (score) => {
      for (const [key, level] of Object.entries(CLEARANCE_LEVELS)) {
        if (score >= level.min && score <= level.max) return level;
      }
      return CLEARANCE_LEVELS.UNTRUSTED;
    };

    // Trust Decay Simulation
    const generateTrustData = (initialTrust = 100, events = []) => {
      const data = [];
      let trust = initialTrust;
      const decayRate = 0.02;
      for (let day = 0; day <= 30; day++) {
        trust = Math.max(0, trust * (1 - decayRate));
        const event = events.find(e => e.day === day);
        if (event) trust = Math.min(100, Math.max(0, trust + event.impact));
        data.push({ day, trust: Math.round(trust * 10) / 10, event: event?.label || null });
      }
      return data;
    };

    // Cyber Background
    const CyberBackground = () => (
      <div style={{position:'fixed',inset:0,overflow:'hidden',pointerEvents:'none'}}>
        <div style={{position:'absolute',inset:0,background:'linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%)'}} />
        <div style={{position:'absolute',inset:0,opacity:0.3}}>
          {[...Array(20)].map((_, i) => (
            <div key={i} style={{
              position:'absolute',
              height:'1px',
              background:'linear-gradient(90deg, transparent, rgba(34,211,238,0.5), transparent)',
              top:`${(i * 5) + Math.random() * 5}%`,
              left:0,right:0,
              animation:`pulse-glow ${2 + Math.random() * 3}s ease-in-out infinite`,
              animationDelay:`${Math.random() * 2}s`
            }} />
          ))}
        </div>
        <div style={{position:'absolute',top:0,left:'25%',width:'24rem',height:'24rem',background:'rgba(34,211,238,0.1)',borderRadius:'50%',filter:'blur(48px)'}} />
        <div style={{position:'absolute',bottom:0,right:'25%',width:'24rem',height:'24rem',background:'rgba(168,85,247,0.1)',borderRadius:'50%',filter:'blur(48px)'}} />
      </div>
    );

    // Glow Card
    const GlowCard = ({ children, glowColor = "cyan", style = {} }) => {
      const colors = {
        cyan: { shadow: 'rgba(34,211,238,0.2)', border: 'rgba(34,211,238,0.3)' },
        purple: { shadow: 'rgba(168,85,247,0.2)', border: 'rgba(168,85,247,0.3)' },
        green: { shadow: 'rgba(34,197,94,0.2)', border: 'rgba(34,197,94,0.3)' },
        amber: { shadow: 'rgba(251,191,36,0.2)', border: 'rgba(251,191,36,0.3)' },
        yellow: { shadow: 'rgba(251,191,36,0.2)', border: 'rgba(251,191,36,0.3)' },
        red: { shadow: 'rgba(255,107,107,0.2)', border: 'rgba(255,107,107,0.3)' }
      };
      // Fallback to cyan if color not found
      const colorConfig = colors[glowColor] || colors.cyan;
      return (
        <div style={{
          background:'rgba(15,23,42,0.8)',
          backdropFilter:'blur(12px)',
          border:`1px solid ${colorConfig.border}`,
          borderRadius:'0.5rem',
          boxShadow:`0 4px 20px ${colorConfig.shadow}`,
          transition:'all 0.3s',
          ...style
        }}>
          {children}
        </div>
      );
    };

    // Navigation Tabs
    const NavTabs = ({ activeTab, setActiveTab }) => {
      const tabs = [
        { id: "city", label: "Living City", icon: "globe", highlight: true },
        { id: "builder", label: "Postal Form", icon: "mail" },
        { id: "routing", label: "Citizen Routing", icon: "truck" },
        { id: "hebbian", label: "Neural Paths", icon: "brain" },
        { id: "trust", label: "Clearances", icon: "shield" },
        { id: "memory", label: "Memory Bus", icon: "database", highlight: true },
        { id: "workflow", label: "City Workflow", icon: "play" },
        { id: "architecture", label: "City Map", icon: "mapPin" },
        { id: "costs", label: "Budget Office", icon: "zap" },
        { id: "api", label: "LLM API", icon: "cpu", highlight: true },
        { id: "agents", label: "Agent Registry", icon: "userCircle", highlight: true },
        { id: "setup", label: "Setup Guide", icon: "settings" }
      ];
      return (
        <div style={{display:'flex',gap:'0.5rem',marginBottom:'2rem',flexWrap:'wrap'}}>
          {tabs.map(tab => {
            const isActive = activeTab === tab.id;
            const isHighlight = tab.highlight;
            return (
              <button key={tab.id} onClick={() => setActiveTab(tab.id)} style={{
                display:'flex',alignItems:'center',gap:'0.5rem',
                padding:'0.5rem 1rem',borderRadius:'0.5rem',
                fontFamily:'monospace',fontSize:'0.875rem',
                transition:'all 0.3s',cursor:'pointer',
                background: isActive
                  ? (isHighlight ? 'linear-gradient(90deg, rgba(0,255,204,0.3), rgba(34,211,238,0.2))' : 'rgba(34,211,238,0.2)')
                  : (isHighlight ? 'rgba(0,255,204,0.1)' : 'rgba(30,41,59,0.5)'),
                color: isActive ? '#22d3ee' : (isHighlight ? '#00ffcc' : '#94a3b8'),
                border: isActive
                  ? '1px solid rgba(34,211,238,0.5)'
                  : (isHighlight ? '1px solid rgba(0,255,204,0.3)' : '1px solid rgba(51,65,85,0.5)'),
                boxShadow: isHighlight && !isActive ? '0 0 10px rgba(0,255,204,0.1)' : 'none'
              }}>
                <Icon name={tab.icon} size={16} />
                {tab.label}
                {isHighlight && !isActive && <span style={{fontSize:'0.5rem',padding:'0.125rem 0.25rem',background:'rgba(0,255,204,0.2)',borderRadius:'0.25rem',color:'#00ffcc'}}>NEW</span>}
              </button>
            );
          })}
        </div>
      );
    };

    // Tag Selector
    const TagSelector = ({ label, options, value, onChange, color = "cyan" }) => {
      const colors = {
        cyan: { active: '#22d3ee', border: 'rgba(34,211,238,0.5)' },
        purple: { active: '#a855f7', border: 'rgba(168,85,247,0.5)' },
        green: { active: '#22c55e', border: 'rgba(34,197,94,0.5)' },
        amber: { active: '#fbbf24', border: 'rgba(251,191,36,0.5)' }
      };
      return (
        <div style={{marginBottom:'1rem'}}>
          <label style={{display:'block',fontSize:'0.75rem',fontFamily:'monospace',color:'#64748b',textTransform:'uppercase',letterSpacing:'0.05em',marginBottom:'0.5rem'}}>{label}</label>
          <div style={{display:'flex',flexWrap:'wrap',gap:'0.5rem'}}>
            {options.map(opt => (
              <button key={opt} onClick={() => onChange(opt)} style={{
                padding:'0.375rem 0.75rem',borderRadius:'0.25rem',
                fontSize:'0.75rem',fontFamily:'monospace',
                transition:'all 0.2s',cursor:'pointer',
                background: value === opt ? 'rgba(30,41,59,1)' : 'rgba(30,41,59,0.5)',
                color: value === opt ? colors[color].active : '#64748b',
                border: value === opt ? `1px solid ${colors[color].border}` : '1px solid rgba(51,65,85,0.5)'
              }}>
                {opt}
              </button>
            ))}
          </div>
        </div>
      );
    };

    // Message Builder
    const MessageBuilder = ({ message, setMessage, onSend }) => {
      const isValid = message.mode && message.context.trim().length > 0;
      const agentKeys = Object.keys(AGENTS);

      return (
        <GlowCard glowColor="cyan" style={{padding:'1.5rem'}}>
          <div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginBottom:'1.5rem'}}>
            <div style={{padding:'0.5rem',borderRadius:'0.5rem',background:'rgba(34,211,238,0.1)'}}>
              <Icon name="terminal" size={20} style={{color:'#22d3ee'}} />
            </div>
            <div>
              <h2 style={{fontSize:'1.125rem',fontWeight:'600',color:'#fff',margin:0}}>ATP Message Builder</h2>
              <p style={{fontSize:'0.75rem',color:'#64748b',margin:0}}>Compose structured commands for the Artemis system</p>
            </div>
          </div>

          <div style={{display:'grid',gap:'1.5rem',gridTemplateColumns:'repeat(auto-fit, minmax(300px, 1fr))'}}>
            <div>
              <TagSelector label="#Mode" options={ATP_MODES} value={message.mode} onChange={v => setMessage({...message, mode: v})} color="cyan" />
              <TagSelector label="#Priority" options={ATP_PRIORITIES} value={message.priority} onChange={v => setMessage({...message, priority: v})} color="amber" />
              <TagSelector label="#ActionType" options={ATP_ACTION_TYPES} value={message.actionType} onChange={v => setMessage({...message, actionType: v})} color="purple" />

              <div style={{marginBottom:'1rem'}}>
                <label style={{display:'block',fontSize:'0.75rem',fontFamily:'monospace',color:'#64748b',textTransform:'uppercase',letterSpacing:'0.05em',marginBottom:'0.5rem'}}>#Context</label>
                <input type="text" value={message.context} onChange={e => setMessage({...message, context: e.target.value})}
                  placeholder="Brief mission goal or purpose..."
                  style={{width:'100%',padding:'0.5rem 1rem',borderRadius:'0.5rem',background:'rgba(30,41,59,0.5)',border:'1px solid rgba(51,65,85,0.5)',color:'#fff',fontFamily:'monospace',fontSize:'0.875rem',outline:'none',boxSizing:'border-box'}} />
              </div>

              <div>
                <label style={{display:'block',fontSize:'0.75rem',fontFamily:'monospace',color:'#64748b',textTransform:'uppercase',letterSpacing:'0.05em',marginBottom:'0.5rem'}}>#TargetZone (optional)</label>
                <input type="text" value={message.targetZone} onChange={e => setMessage({...message, targetZone: e.target.value})}
                  placeholder="e.g., /agents/artemis/"
                  style={{width:'100%',padding:'0.5rem 1rem',borderRadius:'0.5rem',background:'rgba(30,41,59,0.5)',border:'1px solid rgba(51,65,85,0.5)',color:'#fff',fontFamily:'monospace',fontSize:'0.875rem',outline:'none',boxSizing:'border-box'}} />
              </div>

              {/* Agent Selection Mode */}
              <div style={{marginTop:'1rem',padding:'1rem',borderRadius:'0.5rem',background:'rgba(251,191,36,0.05)',border:'1px solid rgba(251,191,36,0.2)'}}>
                <label style={{display:'block',fontSize:'0.75rem',fontFamily:'monospace',color:'#fbbf24',textTransform:'uppercase',letterSpacing:'0.05em',marginBottom:'0.75rem'}}>
                  <Icon name="cpu" size={12} style={{marginRight:'0.375rem',verticalAlign:'middle'}} />
                  Agent Selection
                </label>

                {/* Toggle: Auto vs Manual */}
                <div style={{display:'flex',gap:'0.5rem',marginBottom:'0.75rem'}}>
                  <button
                    onClick={() => setMessage({...message, agentMode: 'auto', selectedAgent: null})}
                    style={{
                      flex:1,padding:'0.5rem',borderRadius:'0.375rem',fontSize:'0.75rem',fontFamily:'monospace',
                      background: message.agentMode === 'auto' ? 'linear-gradient(90deg, #fbbf24, #f59e0b)' : 'rgba(30,41,59,0.5)',
                      color: message.agentMode === 'auto' ? '#020617' : '#94a3b8',
                      border: message.agentMode === 'auto' ? 'none' : '1px solid rgba(51,65,85,0.5)',
                      cursor:'pointer',fontWeight: message.agentMode === 'auto' ? 600 : 400,
                      transition:'all 0.2s'
                    }}
                  >
                    <Icon name="brain" size={12} style={{marginRight:'0.25rem',verticalAlign:'middle'}} />
                    Auto (Hebbian)
                  </button>
                  <button
                    onClick={() => setMessage({...message, agentMode: 'manual'})}
                    style={{
                      flex:1,padding:'0.5rem',borderRadius:'0.375rem',fontSize:'0.75rem',fontFamily:'monospace',
                      background: message.agentMode === 'manual' ? 'linear-gradient(90deg, #a855f7, #7c3aed)' : 'rgba(30,41,59,0.5)',
                      color: message.agentMode === 'manual' ? '#fff' : '#94a3b8',
                      border: message.agentMode === 'manual' ? 'none' : '1px solid rgba(51,65,85,0.5)',
                      cursor:'pointer',fontWeight: message.agentMode === 'manual' ? 600 : 400,
                      transition:'all 0.2s'
                    }}
                  >
                    <Icon name="user" size={12} style={{marginRight:'0.25rem',verticalAlign:'middle'}} />
                    Manual Select
                  </button>
                </div>

                {/* Auto mode explanation */}
                {message.agentMode === 'auto' && (
                  <div style={{fontSize:'0.65rem',color:'#64748b',padding:'0.5rem',background:'rgba(0,0,0,0.2)',borderRadius:'0.25rem'}}>
                    <span style={{color:'#fbbf24'}}>Router</span> will choose the best agent using:
                    <div style={{display:'flex',gap:'0.5rem',marginTop:'0.375rem',flexWrap:'wrap'}}>
                      <span style={{padding:'0.125rem 0.375rem',background:'rgba(251,191,36,0.15)',borderRadius:'0.25rem',color:'#fbbf24'}}>40% Keywords</span>
                      <span style={{padding:'0.125rem 0.375rem',background:'rgba(168,85,247,0.15)',borderRadius:'0.25rem',color:'#a855f7'}}>30% Hebbian</span>
                      <span style={{padding:'0.125rem 0.375rem',background:'rgba(34,211,238,0.15)',borderRadius:'0.25rem',color:'#22d3ee'}}>20% Mode</span>
                      <span style={{padding:'0.125rem 0.375rem',background:'rgba(34,197,94,0.15)',borderRadius:'0.25rem',color:'#22c55e'}}>10% Priority</span>
                    </div>
                  </div>
                )}

                {/* Manual mode - Agent grid */}
                {message.agentMode === 'manual' && (
                  <div style={{display:'grid',gridTemplateColumns:'repeat(2, 1fr)',gap:'0.5rem'}}>
                    {agentKeys.map(key => {
                      const agent = AGENTS[key];
                      const isSelected = message.selectedAgent === key;
                      return (
                        <button
                          key={key}
                          onClick={() => setMessage({...message, selectedAgent: key})}
                          style={{
                            padding:'0.5rem',borderRadius:'0.375rem',textAlign:'left',
                            background: isSelected ? `${agent.color}20` : 'rgba(30,41,59,0.5)',
                            border: isSelected ? `2px solid ${agent.color}` : '1px solid rgba(51,65,85,0.5)',
                            cursor:'pointer',transition:'all 0.2s'
                          }}
                        >
                          <div style={{display:'flex',alignItems:'center',gap:'0.375rem',marginBottom:'0.25rem'}}>
                            <div style={{width:'8px',height:'8px',borderRadius:'50%',background:agent.color}} />
                            <span style={{fontSize:'0.75rem',fontWeight:600,color: isSelected ? agent.color : '#fff'}}>{agent.name}</span>
                          </div>
                          <div style={{fontSize:'0.6rem',color:'#64748b',lineHeight:1.3}}>{agent.specialty}</div>
                        </button>
                      );
                    })}
                  </div>
                )}
              </div>
            </div>

            <div>
              <label style={{display:'block',fontSize:'0.75rem',fontFamily:'monospace',color:'#64748b',textTransform:'uppercase',letterSpacing:'0.05em',marginBottom:'0.5rem'}}>Generated ATP Message</label>
              <div style={{padding:'1rem',borderRadius:'0.5rem',background:'#020617',border:'1px solid rgba(51,65,85,0.5)',fontFamily:'monospace',fontSize:'0.875rem',minHeight:'120px',marginBottom:'1rem'}}>
                <span style={{color:'#22d3ee'}}>#Mode:</span> <span style={{color:'#fff'}}>{message.mode || "___"}</span>{" "}
                <span style={{color:'#22c55e'}}>#Context:</span> <span style={{color:'#fff'}}>{message.context || "___"}</span>{" "}
                <span style={{color:'#fbbf24'}}>#Priority:</span> <span style={{color:'#fff'}}>{message.priority || "Normal"}</span>{" "}
                <span style={{color:'#a855f7'}}>#ActionType:</span> <span style={{color:'#fff'}}>{message.actionType || "Execute"}</span>
                {message.targetZone && (<><br/><span style={{color:'#ec4899'}}>#TargetZone:</span> <span style={{color:'#fff'}}>{message.targetZone}</span></>)}
                <br/>
                <span style={{color: message.agentMode === 'manual' ? '#a855f7' : '#fbbf24'}}>#Agent:</span>{" "}
                <span style={{color:'#fff'}}>
                  {message.agentMode === 'manual' && message.selectedAgent
                    ? <><span style={{color:'#a855f7'}}>[Manual]</span> {AGENTS[message.selectedAgent]?.name}</>
                    : <><span style={{color:'#fbbf24'}}>[Auto]</span> Hebbian Router</>
                  }
                </span>
              </div>

              <div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginBottom:'1rem'}}>
                <div style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.375rem 0.75rem',borderRadius:'0.25rem',fontSize:'0.75rem',fontFamily:'monospace',
                  background: isValid ? 'rgba(34,197,94,0.1)' : 'rgba(251,191,36,0.1)',
                  color: isValid ? '#22c55e' : '#fbbf24'
                }}>
                  <Icon name={isValid ? "checkCircle" : "alertTriangle"} size={14} />
                  {isValid ? "Valid ATP Message" : "Incomplete Message"}
                </div>
              </div>

              <button onClick={() => isValid && onSend(message)} disabled={!isValid} style={{
                width:'100%',display:'flex',alignItems:'center',justifyContent:'center',gap:'0.5rem',
                padding:'0.75rem 1.5rem',borderRadius:'0.5rem',fontFamily:'monospace',fontSize:'0.875rem',
                transition:'all 0.3s',cursor: isValid ? 'pointer' : 'not-allowed',border:'none',
                background: isValid ? 'linear-gradient(90deg, #0891b2, #0e7490)' : '#1e293b',
                color: isValid ? '#fff' : '#475569',
                boxShadow: isValid ? '0 4px 20px rgba(34,211,238,0.25)' : 'none'
              }}>
                <Icon name="send" size={16} />
                Send to Artemis System
              </button>

              {/* Hebbian hint */}
              <div style={{marginTop:'0.75rem',display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.5rem 0.75rem',borderRadius:'0.375rem',background:'rgba(168,85,247,0.08)',border:'1px solid rgba(168,85,247,0.2)'}}>
                <Icon name="brain" size={14} style={{color:'#a855f7'}} />
                <span style={{fontSize:'0.65rem',color:'#94a3b8'}}>
                  Routing uses <span style={{color:'#a855f7',fontWeight:600}}>Hebbian learning</span> — agents that successfully work together strengthen their connection pathways
                </span>
              </div>
            </div>
          </div>
        </GlowCard>
      );
    };

    // Agent Routing with Hebbian Influence
    const AgentRouting = ({ message, hebbianState, onRouteComplete }) => {
      const [routedAgent, setRoutedAgent] = useState(null);
      const [secondaryAgent, setSecondaryAgent] = useState(null);
      const [isRouting, setIsRouting] = useState(false);
      const [routingDetails, setRoutingDetails] = useState(null);
      const [routingMode, setRoutingMode] = useState('auto'); // Track how routing was done

      // Safety check for hebbianState
      if (!hebbianState) {
        return <div style={{color:'#94a3b8',padding:'1rem'}}>Loading Hebbian state...</div>;
      }

      const simulateRouting = () => {
        setIsRouting(true);
        setRoutedAgent(null);
        setSecondaryAgent(null);
        setRoutingDetails(null);

        // Check if user manually selected an agent
        const isManualMode = message.agentMode === 'manual' && message.selectedAgent;
        setRoutingMode(isManualMode ? 'manual' : 'auto');

        setTimeout(() => {
          const contextLower = message.context.toLowerCase();

          // Calculate scores for each agent (always calculate for display)
          const scores = {};
          Object.keys(AGENTS).forEach(agentKey => {
            const agent = AGENTS[agentKey];

            // Base score from keyword matching
            const keywordMatch = agent.keywords.filter(kw => contextLower.includes(kw)).length;
            const keywordScore = keywordMatch * 0.4; // 40% weight for keywords

            // Hebbian strength score (neural pathway strength)
            const hebbianStrength = hebbianState.getAgentStrength(agentKey);
            const hebbianScore = (hebbianStrength / 3) * 0.3; // 30% weight for Hebbian (normalized)

            // Mode preference score
            let modeScore = 0;
            if (message.mode === "Review" && agentKey === "artemis") modeScore = 0.2;
            if (message.mode === "Build" && agentKey === "copilot") modeScore = 0.15;
            if (message.mode === "Organize" && agentKey === "daemon") modeScore = 0.15;
            if (message.mode === "Capture" && agentKey === "packrat") modeScore = 0.15;

            // Priority boost
            const priorityBoost = message.priority === "Critical" ? 0.1 : 0;

            // Manual selection override
            const manualBoost = isManualMode && agentKey === message.selectedAgent ? 1.0 : 0;

            scores[agentKey] = {
              keyword: keywordScore,
              hebbian: hebbianScore,
              mode: modeScore,
              priority: priorityBoost,
              manual: manualBoost,
              total: isManualMode && agentKey === message.selectedAgent
                ? 1.0 // Manual selection always wins
                : keywordScore + hebbianScore + modeScore + priorityBoost
            };
          });

          // Sort by total score
          const ranked = Object.entries(scores).sort((a, b) => b[1].total - a[1].total);

          // If manual mode, use selected agent; otherwise use highest scored
          const primaryAgent = isManualMode ? message.selectedAgent : ranked[0][0];
          const secondary = ranked.find(([key]) => key !== primaryAgent)?.[0] || ranked[1][0];

          setRoutedAgent(primaryAgent);
          setSecondaryAgent(secondary);
          setRoutingDetails(scores);
          setIsRouting(false);

          // Callback to strengthen Hebbian connection
          if (onRouteComplete) {
            onRouteComplete(primaryAgent, secondary, isManualMode);
          }
        }, isManualMode ? 800 : 1800); // Faster for manual selection
      };

      return (
        <GlowCard glowColor="purple" style={{padding:'1.5rem'}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'1.5rem',flexWrap:'wrap',gap:'1rem'}}>
            <div style={{display:'flex',alignItems:'center',gap:'0.75rem'}}>
              <div style={{padding:'0.5rem',borderRadius:'0.5rem',background:'rgba(168,85,247,0.1)'}}>
                <Icon name="users" size={20} style={{color:'#a855f7'}} />
              </div>
              <div>
                <h2 style={{fontSize:'1.125rem',fontWeight:'600',color:'#fff',margin:0}}>Hebbian Agent Routing</h2>
                <p style={{fontSize:'0.75rem',color:'#64748b',margin:0}}>Routes informed by learned neural pathways</p>
              </div>
            </div>
            <div style={{display:'flex',gap:'0.5rem',flexWrap:'wrap'}}>
              {/* Routing Mode Indicator */}
              {message.agentMode === 'manual' && message.selectedAgent ? (
                <div style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.375rem 0.75rem',borderRadius:'0.375rem',background:'rgba(168,85,247,0.1)',border:'1px solid rgba(168,85,247,0.3)'}}>
                  <Icon name="user" size={14} style={{color:'#a855f7'}} />
                  <span style={{fontSize:'0.7rem',fontFamily:'monospace',color:'#a855f7'}}>Manual: {AGENTS[message.selectedAgent]?.name}</span>
                </div>
              ) : (
                <div style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.375rem 0.75rem',borderRadius:'0.375rem',background:'rgba(251,191,36,0.1)',border:'1px solid rgba(251,191,36,0.3)'}}>
                  <Icon name="brain" size={14} style={{color:'#fbbf24'}} />
                  <span style={{fontSize:'0.7rem',fontFamily:'monospace',color:'#fbbf24'}}>Auto: Hebbian Routing</span>
                </div>
              )}
              {/* Hebbian Status */}
              <div style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.375rem 0.75rem',borderRadius:'0.375rem',background:'rgba(34,197,94,0.1)',border:'1px solid rgba(34,197,94,0.3)'}}>
                <div style={{width:'6px',height:'6px',borderRadius:'50%',background:'#22c55e',animation:'pulse 2s infinite'}} />
                <span style={{fontSize:'0.7rem',fontFamily:'monospace',color:'#22c55e'}}>Learning Active</span>
              </div>
            </div>
          </div>

          <div style={{display:'grid',gap:'1rem',gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))',marginBottom:'1.5rem'}}>
            {Object.entries(AGENTS).map(([key, agent]) => {
              const isActive = routedAgent === key;
              const isSecondary = secondaryAgent === key;
              const strength = hebbianState.getAgentStrength(key);
              const details = routingDetails?.[key];

              return (
                <div key={key} style={{
                  padding:'1rem',borderRadius:'0.5rem',
                  transition:'all 0.5s',position:'relative',
                  border: isActive ? `2px solid ${agent.color}` : isSecondary ? `1px solid ${agent.color}60` : '1px solid rgba(51,65,85,0.5)',
                  background: isActive ? 'rgba(30,41,59,0.8)' : 'rgba(30,41,59,0.3)',
                  transform: isActive ? 'scale(1.05)' : 'scale(1)',
                  boxShadow: isActive ? `0 0 30px ${agent.color}40` : 'none'
                }}>
                  {/* Hebbian strength indicator */}
                  <div style={{position:'absolute',top:'0.5rem',right:'0.5rem',display:'flex',alignItems:'center',gap:'0.25rem'}}>
                    <div style={{width:'6px',height:'6px',borderRadius:'50%',background:'#a855f7',opacity: 0.3 + (strength / 3) * 0.7}} />
                    <span style={{fontSize:'0.55rem',fontFamily:'monospace',color:'#64748b'}}>{strength.toFixed(1)}</span>
                  </div>

                  <div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginBottom:'0.5rem'}}>
                    <div style={{padding:'0.5rem',borderRadius:'0.5rem',background:`${agent.color}20`}}>
                      <Icon name={agent.icon} size={18} style={{color:agent.color}} />
                    </div>
                    <div>
                      <div style={{fontWeight:'600',color:'#fff',fontSize:'0.875rem'}}>{agent.name}</div>
                      <div style={{fontSize:'0.75rem',color:'#64748b'}}>{agent.role}</div>
                    </div>
                  </div>
                  <p style={{fontSize:'0.75rem',color:'#94a3b8',marginBottom:'0.5rem'}}>{agent.description}</p>

                  {/* Score breakdown when routing is complete */}
                  {details && (
                    <div style={{marginTop:'0.5rem',padding:'0.5rem',background:'rgba(2,6,23,0.5)',borderRadius:'0.25rem'}}>
                      <div style={{display:'flex',justifyContent:'space-between',marginBottom:'0.25rem'}}>
                        <span style={{fontSize:'0.6rem',color:'#64748b'}}>Score:</span>
                        <span style={{fontSize:'0.65rem',fontWeight:600,color: isActive ? agent.color : '#94a3b8'}}>{(details.total * 100).toFixed(0)}%</span>
                      </div>
                      <div style={{display:'flex',gap:'0.25rem',flexWrap:'wrap'}}>
                        {details.keyword > 0 && <span style={{fontSize:'0.5rem',padding:'0.125rem 0.25rem',borderRadius:'0.125rem',background:'rgba(34,211,238,0.2)',color:'#22d3ee'}}>KW:{(details.keyword*100).toFixed(0)}</span>}
                        {details.hebbian > 0 && <span style={{fontSize:'0.5rem',padding:'0.125rem 0.25rem',borderRadius:'0.125rem',background:'rgba(168,85,247,0.2)',color:'#a855f7'}}>HB:{(details.hebbian*100).toFixed(0)}</span>}
                        {details.mode > 0 && <span style={{fontSize:'0.5rem',padding:'0.125rem 0.25rem',borderRadius:'0.125rem',background:'rgba(251,191,36,0.2)',color:'#fbbf24'}}>MD:{(details.mode*100).toFixed(0)}</span>}
                      </div>
                    </div>
                  )}

                  <div style={{display:'flex',flexWrap:'wrap',gap:'0.25rem',marginTop:'0.5rem'}}>
                    {agent.keywords.slice(0,3).map(kw => (
                      <span key={kw} style={{padding:'0.125rem 0.375rem',borderRadius:'0.25rem',fontSize:'0.625rem',background:'rgba(51,65,85,0.5)',color:'#94a3b8',fontFamily:'monospace'}}>{kw}</span>
                    ))}
                  </div>
                </div>
              );
            })}
          </div>

          <div style={{display:'flex',alignItems:'center',gap:'1rem',flexWrap:'wrap'}}>
            <button onClick={simulateRouting} disabled={isRouting || !message.context} style={{
              display:'flex',alignItems:'center',gap:'0.5rem',
              padding:'0.75rem 1.5rem',borderRadius:'0.5rem',fontFamily:'monospace',fontSize:'0.875rem',
              transition:'all 0.3s',cursor: (isRouting || !message.context) ? 'not-allowed' : 'pointer',border:'none',
              background: (isRouting || !message.context) ? '#1e293b' : 'linear-gradient(90deg, #7c3aed, #6d28d9)',
              color: (isRouting || !message.context) ? '#475569' : '#fff',
              boxShadow: (isRouting || !message.context) ? 'none' : '0 4px 20px rgba(168,85,247,0.25)'
            }}>
              {isRouting ? (
                <><div style={{width:'1rem',height:'1rem',border:'2px solid rgba(255,255,255,0.3)',borderTopColor:'#fff',borderRadius:'50%',animation:'spin 1s linear infinite'}} />Routing...</>
              ) : (
                <><Icon name="brain" size={16} /><Icon name="zap" size={16} />Hebbian Route</>
              )}
            </button>
            {routedAgent && (
              <div style={{display:'flex',alignItems:'center',gap:'0.75rem',fontSize:'0.875rem'}}>
                <Icon name="chevronRight" size={16} style={{color:'#475569'}} />
                <div style={{display:'flex',flexDirection:'column',gap:'0.125rem'}}>
                  <div style={{display:'flex',alignItems:'center',gap:'0.375rem'}}>
                    <span style={{fontSize:'0.7rem',color:'#64748b'}}>Primary:</span>
                    <span style={{fontWeight:'600',color:AGENTS[routedAgent].color}}>{AGENTS[routedAgent].name}</span>
                  </div>
                  {secondaryAgent && (
                    <div style={{display:'flex',alignItems:'center',gap:'0.375rem'}}>
                      <span style={{fontSize:'0.65rem',color:'#475569'}}>Secondary:</span>
                      <span style={{fontSize:'0.75rem',color:AGENTS[secondaryAgent].color}}>{AGENTS[secondaryAgent].name}</span>
                    </div>
                  )}
                </div>
                {/* Hebbian learning indicator */}
                {secondaryAgent && (
                  <div style={{
                    display:'flex',alignItems:'center',gap:'0.375rem',
                    padding:'0.25rem 0.5rem',borderRadius:'0.25rem',
                    background:'rgba(168,85,247,0.15)',border:'1px solid rgba(168,85,247,0.3)',
                    animation:'pulse 2s ease-in-out'
                  }}>
                    <Icon name="brain" size={12} style={{color:'#a855f7'}} />
                    <span style={{fontSize:'0.6rem',fontFamily:'monospace',color:'#a855f7'}}>
                      {AGENTS[routedAgent].name.split(' ')[0]}↔{AGENTS[secondaryAgent].name.split(' ')[0]} +0.1
                    </span>
                  </div>
                )}
              </div>
            )}
          </div>

          {/* Scoring legend */}
          <div style={{marginTop:'1rem',padding:'0.75rem',background:'rgba(2,6,23,0.3)',borderRadius:'0.375rem',display:'flex',gap:'1rem',flexWrap:'wrap'}}>
            <div style={{display:'flex',alignItems:'center',gap:'0.375rem'}}>
              <span style={{fontSize:'0.55rem',padding:'0.125rem 0.25rem',borderRadius:'0.125rem',background:'rgba(34,211,238,0.2)',color:'#22d3ee'}}>KW</span>
              <span style={{fontSize:'0.6rem',color:'#64748b'}}>Keyword Match (40%)</span>
            </div>
            <div style={{display:'flex',alignItems:'center',gap:'0.375rem'}}>
              <span style={{fontSize:'0.55rem',padding:'0.125rem 0.25rem',borderRadius:'0.125rem',background:'rgba(168,85,247,0.2)',color:'#a855f7'}}>HB</span>
              <span style={{fontSize:'0.6rem',color:'#64748b'}}>Hebbian Strength (30%)</span>
            </div>
            <div style={{display:'flex',alignItems:'center',gap:'0.375rem'}}>
              <span style={{fontSize:'0.55rem',padding:'0.125rem 0.25rem',borderRadius:'0.125rem',background:'rgba(251,191,36,0.2)',color:'#fbbf24'}}>MD</span>
              <span style={{fontSize:'0.6rem',color:'#64748b'}}>Mode Preference (20%)</span>
            </div>
          </div>
        </GlowCard>
      );
    };

    // Hebbian Learning Network Visualization
    const HebbianLearning = ({ hebbianState, routingHistory = [] }) => {
      const [activations, setActivations] = useState({});
      const [history, setHistory] = useState([]);
      const [isSimulating, setIsSimulating] = useState(false);

      // Safety check for hebbianState
      if (!hebbianState) {
        return <div style={{color:'#94a3b8',padding:'1rem'}}>Loading Hebbian state...</div>;
      }

      const { weights, hebbianUpdate, decayWeights } = hebbianState;

      // Extract live session learning from routing history
      const liveConnections = routingHistory
        .filter(r => r.secondary)
        .map(r => `${r.primary}-${r.secondary}`);

      // Node positions for visualization
      const nodes = [
        { id: 'artemis', x: 300, y: 80, label: 'Artemis', color: '#00ffcc' },
        { id: 'copilot', x: 520, y: 180, label: 'Copilot', color: '#ff6b6b' },
        { id: 'packrat', x: 80, y: 180, label: 'Pack Rat', color: '#ffd93d' },
        { id: 'daemon', x: 300, y: 300, label: 'Daemon', color: '#6c5ce7' }
      ];

      // Connections between nodes
      const connections = [
        { from: 'artemis', to: 'copilot', key: 'artemis-copilot' },
        { from: 'artemis', to: 'packrat', key: 'artemis-packrat' },
        { from: 'artemis', to: 'daemon', key: 'artemis-daemon' },
        { from: 'copilot', to: 'packrat', key: 'copilot-packrat' },
        { from: 'copilot', to: 'daemon', key: 'copilot-daemon' },
        { from: 'packrat', to: 'daemon', key: 'packrat-daemon' }
      ];

      // Simulate co-activation scenarios
      const scenarios = [
        { name: 'Governance Review', agents: ['artemis', 'copilot'], desc: 'Artemis reviews with Copilot assistance' },
        { name: 'Secure Transfer', agents: ['packrat', 'daemon'], desc: 'Pack Rat transfers via Daemon memory' },
        { name: 'Full Audit', agents: ['artemis', 'daemon', 'copilot'], desc: 'Complete system audit' },
        { name: 'Data Courier', agents: ['packrat', 'copilot'], desc: 'Pack Rat delivers to Copilot' }
      ];

      const runScenario = (scenario) => {
        setIsSimulating(true);
        setActivations({});

        // Activate agents sequentially
        scenario.agents.forEach((agent, i) => {
          setTimeout(() => {
            setActivations(prev => ({...prev, [agent]: true}));
          }, i * 400);
        });

        // Apply Hebbian learning after all activated
        setTimeout(() => {
          for (let i = 0; i < scenario.agents.length; i++) {
            for (let j = i + 1; j < scenario.agents.length; j++) {
              hebbianUpdate(scenario.agents[i], scenario.agents[j]);
            }
          }
          setHistory(prev => [...prev.slice(-4), { scenario: scenario.name, agents: scenario.agents }]);
          setIsSimulating(false);
        }, scenario.agents.length * 400 + 500);
      };

      const getNodePos = (id) => nodes.find(n => n.id === id);

      return (
        <GlowCard glowColor="purple" style={{padding:'1.5rem'}}>
          <div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginBottom:'1.5rem'}}>
            <div style={{padding:'0.5rem',borderRadius:'0.5rem',background:'rgba(168,85,247,0.1)'}}>
              <Icon name="brain" size={20} style={{color:'#a855f7'}} />
            </div>
            <div>
              <h2 style={{fontSize:'1.125rem',fontWeight:'600',color:'#fff',margin:0}}>Hebbian Learning Network</h2>
              <p style={{fontSize:'0.75rem',color:'#64748b',margin:0}}>"Neurons that fire together, wire together" — connection weights strengthen with co-activation</p>
            </div>
          </div>

          <div style={{display:'grid',gap:'1.5rem',gridTemplateColumns:'1fr 280px'}}>
            {/* Neural Network Visualization */}
            <div style={{background:'rgba(2,6,23,0.5)',borderRadius:'0.5rem',padding:'1rem',position:'relative'}}>
              <svg width="100%" height="380" viewBox="0 0 600 380" preserveAspectRatio="xMidYMid meet">
                <defs>
                  <filter id="glow">
                    <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                    <feMerge>
                      <feMergeNode in="coloredBlur"/>
                      <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                  </filter>
                </defs>

                {/* Connection lines */}
                {connections.map(conn => {
                  const from = getNodePos(conn.from);
                  const to = getNodePos(conn.to);
                  const weight = weights[conn.key];
                  const isActive = activations[conn.from] && activations[conn.to];
                  return (
                    <g key={conn.key}>
                      <line
                        x1={from.x} y1={from.y}
                        x2={to.x} y2={to.y}
                        stroke={isActive ? '#a855f7' : '#334155'}
                        strokeWidth={1 + weight * 8}
                        opacity={0.3 + weight * 0.7}
                        filter={isActive ? 'url(#glow)' : 'none'}
                        style={{transition:'all 0.5s'}}
                      />
                      {/* Weight label */}
                      <text
                        x={(from.x + to.x) / 2}
                        y={(from.y + to.y) / 2 - 8}
                        fill="#64748b"
                        fontSize="10"
                        textAnchor="middle"
                        fontFamily="monospace"
                      >
                        {weight.toFixed(2)}
                      </text>
                    </g>
                  );
                })}

                {/* Nodes */}
                {nodes.map(node => {
                  const isActive = activations[node.id];
                  return (
                    <g key={node.id}>
                      {/* Outer glow when active */}
                      {isActive && (
                        <circle
                          cx={node.x} cy={node.y} r="45"
                          fill={node.color}
                          opacity="0.2"
                          style={{animation:'pulse-glow 1s ease-in-out infinite'}}
                        />
                      )}
                      {/* Node circle */}
                      <circle
                        cx={node.x} cy={node.y} r="35"
                        fill={isActive ? node.color : 'rgba(30,41,59,0.8)'}
                        stroke={node.color}
                        strokeWidth={isActive ? 3 : 2}
                        filter={isActive ? 'url(#glow)' : 'none'}
                        style={{transition:'all 0.3s'}}
                      />
                      {/* Node label */}
                      <text
                        x={node.x} y={node.y + 5}
                        fill={isActive ? '#020617' : '#fff'}
                        fontSize="11"
                        fontWeight="600"
                        textAnchor="middle"
                        fontFamily="system-ui"
                      >
                        {node.label}
                      </text>
                    </g>
                  );
                })}

                {/* Legend */}
                <text x="10" y="365" fill="#64748b" fontSize="10" fontFamily="monospace">
                  Connection strength: thicker = stronger | Hebbian Δw = η × pre × post
                </text>
              </svg>
            </div>

            {/* Controls Panel */}
            <div style={{display:'flex',flexDirection:'column',gap:'1rem'}}>
              {/* Scenarios */}
              <div>
                <label style={{display:'block',fontSize:'0.75rem',fontFamily:'monospace',color:'#64748b',textTransform:'uppercase',letterSpacing:'0.05em',marginBottom:'0.5rem'}}>
                  Co-Activation Scenarios
                </label>
                <div style={{display:'flex',flexDirection:'column',gap:'0.5rem'}}>
                  {scenarios.map((scenario, i) => (
                    <button
                      key={i}
                      onClick={() => !isSimulating && runScenario(scenario)}
                      disabled={isSimulating}
                      style={{
                        padding:'0.5rem 0.75rem',borderRadius:'0.375rem',
                        background:'rgba(30,41,59,0.5)',border:'1px solid rgba(51,65,85,0.5)',
                        color:'#fff',textAlign:'left',cursor: isSimulating ? 'not-allowed' : 'pointer',
                        transition:'all 0.2s',opacity: isSimulating ? 0.5 : 1
                      }}
                    >
                      <div style={{fontWeight:'600',fontSize:'0.8rem',marginBottom:'0.125rem'}}>{scenario.name}</div>
                      <div style={{fontSize:'0.65rem',color:'#64748b'}}>{scenario.desc}</div>
                    </button>
                  ))}
                </div>
              </div>

              {/* Decay Control */}
              <button
                onClick={() => decayWeights()}
                style={{
                  padding:'0.5rem',borderRadius:'0.375rem',
                  background:'rgba(239,68,68,0.1)',border:'1px solid rgba(239,68,68,0.3)',
                  color:'#ef4444',fontFamily:'monospace',fontSize:'0.75rem',cursor:'pointer'
                }}
              >
                Apply Decay (-0.05)
              </button>

              {/* Live Session Learning - from routing */}
              {routingHistory.length > 0 && (
                <div style={{background:'linear-gradient(135deg, rgba(0,255,136,0.1), rgba(34,211,238,0.1))',border:'1px solid rgba(0,255,136,0.3)',borderRadius:'0.375rem',padding:'0.75rem'}}>
                  <div style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.5rem'}}>
                    <div style={{width:'6px',height:'6px',borderRadius:'50%',background:'#00ff88',animation:'pulse 2s infinite'}} />
                    <span style={{fontSize:'0.7rem',fontFamily:'monospace',color:'#00ff88',fontWeight:'600'}}>LIVE SESSION LEARNING</span>
                  </div>
                  <div style={{fontSize:'0.65rem',color:'#94a3b8',marginBottom:'0.5rem'}}>
                    Connections strengthened this session:
                  </div>
                  <div style={{display:'flex',flexWrap:'wrap',gap:'0.375rem'}}>
                    {[...new Set(liveConnections)].map((conn, i) => (
                      <div key={i} style={{
                        padding:'0.25rem 0.5rem',borderRadius:'0.25rem',
                        background:'rgba(0,255,136,0.15)',border:'1px solid rgba(0,255,136,0.3)',
                        fontSize:'0.6rem',fontFamily:'monospace',color:'#00ff88'
                      }}>
                        {conn.split('-').map(a => AGENTS[a]?.name || a).join(' ↔ ')}
                      </div>
                    ))}
                  </div>
                  <div style={{fontSize:'0.6rem',color:'#64748b',marginTop:'0.5rem'}}>
                    {routingHistory.length} route(s) • {liveConnections.length} learning event(s)
                  </div>
                </div>
              )}

              {/* Activity Log */}
              <div>
                <label style={{display:'block',fontSize:'0.75rem',fontFamily:'monospace',color:'#64748b',textTransform:'uppercase',letterSpacing:'0.05em',marginBottom:'0.5rem'}}>
                  Learning History
                </label>
                <div style={{background:'rgba(2,6,23,0.5)',borderRadius:'0.375rem',padding:'0.5rem',minHeight:'80px',maxHeight:'120px',overflow:'auto'}}>
                  {history.length === 0 ? (
                    <div style={{color:'#475569',fontSize:'0.7rem',fontFamily:'monospace'}}>No activations yet...</div>
                  ) : (
                    history.map((h, i) => (
                      <div key={i} style={{fontSize:'0.65rem',fontFamily:'monospace',color:'#94a3b8',marginBottom:'0.25rem'}}>
                        <span style={{color:'#a855f7'}}>▸</span> {h.scenario}: {h.agents.join(' ↔ ')}
                      </div>
                    ))
                  )}
                </div>
              </div>

              {/* Hebb's Rule Explanation */}
              <div style={{background:'rgba(168,85,247,0.1)',border:'1px solid rgba(168,85,247,0.3)',borderRadius:'0.375rem',padding:'0.75rem'}}>
                <div style={{fontSize:'0.7rem',fontFamily:'monospace',color:'#a855f7',marginBottom:'0.25rem'}}>Hebb's Rule</div>
                <div style={{fontSize:'0.65rem',color:'#94a3b8',lineHeight:1.4}}>
                  When agents co-activate on tasks, their connection weights increase. This models how trust and collaboration pathways strengthen through repeated successful interactions.
                </div>
              </div>
            </div>
          </div>
        </GlowCard>
      );
    };

    // Trust Decay
    const TrustDecay = ({ routingHistory = [], hebbianState }) => {
      const [scenario, setScenario] = useState("default");
      const scenarios = {
        default: { label: "Natural Decay", initial: 100, events: [], hebbianNote: "No agent co-activation" },
        positive: { label: "Positive Reinforcement", initial: 60, events: [{ day: 5, impact: 15, label: "Successful task" }, { day: 12, impact: 20, label: "Protocol adherence" }, { day: 20, impact: 10, label: "Validation passed" }], hebbianNote: "Hebbian pathways strengthened +0.3" },
        negative: { label: "Trust Violation", initial: 90, events: [{ day: 8, impact: -25, label: "Policy violation" }, { day: 15, impact: -15, label: "Inconsistency detected" }], hebbianNote: "Hebbian weights decayed -0.15" },
        recovery: { label: "Recovery Pattern", initial: 40, events: [{ day: 3, impact: 10, label: "Corrective action" }, { day: 8, impact: 15, label: "Audit passed" }, { day: 15, impact: 20, label: "Sustained compliance" }, { day: 22, impact: 10, label: "Trust restored" }], hebbianNote: "Neural pathways rebuilding +0.4" }
      };

      // Calculate live trust based on routing history
      const baseTrust = scenarios[scenario].initial;
      const routingBonus = routingHistory.length * 2; // Each successful route adds trust
      const liveTrust = Math.min(100, baseTrust + routingBonus);

      const data = generateTrustData(scenarios[scenario].initial, scenarios[scenario].events);
      const currentTrust = routingHistory.length > 0 ? liveTrust : data[data.length - 1].trust;

      const getTrustLevel = (trust) => {
        if (trust >= 80) return { label: "High Trust", color: "#00ffcc" };
        if (trust >= 50) return { label: "Moderate Trust", color: "#ffd93d" };
        if (trust >= 25) return { label: "Low Trust", color: "#ff9f43" };
        return { label: "Critical", color: "#ff6b6b" };
      };
      const trustLevel = getTrustLevel(currentTrust);

      // Calculate avg Hebbian strength
      const avgHebbian = hebbianState ?
        Object.values(hebbianState.weights).reduce((a,b) => a+b, 0) / Object.keys(hebbianState.weights).length : 0;

      return (
        <GlowCard glowColor="green" style={{padding:'1.5rem'}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'1.5rem',flexWrap:'wrap',gap:'1rem'}}>
            <div style={{display:'flex',alignItems:'center',gap:'0.75rem'}}>
              <div style={{padding:'0.5rem',borderRadius:'0.5rem',background:'rgba(34,197,94,0.1)'}}>
                <Icon name="shield" size={20} style={{color:'#22c55e'}} />
              </div>
              <div>
                <h2 style={{fontSize:'1.125rem',fontWeight:'600',color:'#fff',margin:0}}>Trust Decay Model</h2>
                <p style={{fontSize:'0.75rem',color:'#64748b',margin:0}}>Dynamic trust evaluation over time</p>
              </div>
            </div>
            <div style={{display:'flex',alignItems:'center',gap:'0.5rem'}}>
              <span style={{fontSize:'0.75rem',color:'#64748b',fontFamily:'monospace'}}>Trust Score:</span>
              <span style={{fontSize:'1.5rem',fontWeight:'700',color:trustLevel.color}}>{currentTrust.toFixed(0)}</span>
              <span style={{padding:'0.25rem 0.5rem',borderRadius:'0.25rem',fontSize:'0.75rem',fontFamily:'monospace',background:`${trustLevel.color}20`,color:trustLevel.color}}>{trustLevel.label}</span>
            </div>
          </div>

          {/* Live session trust indicator */}
          {routingHistory.length > 0 && (
            <div style={{marginBottom:'1rem',padding:'0.75rem',background:'linear-gradient(135deg, rgba(34,197,94,0.1), rgba(168,85,247,0.1))',border:'1px solid rgba(34,197,94,0.3)',borderRadius:'0.5rem'}}>
              <div style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.5rem'}}>
                <div style={{width:'8px',height:'8px',borderRadius:'50%',background:'#22c55e',animation:'pulse-glow 1s ease-in-out infinite'}} />
                <span style={{fontSize:'0.7rem',fontFamily:'monospace',color:'#22c55e',textTransform:'uppercase'}}>Live Session Trust</span>
              </div>
              <div style={{display:'grid',gridTemplateColumns:'repeat(3, 1fr)',gap:'1rem',textAlign:'center'}}>
                <div>
                  <div style={{fontSize:'1.25rem',fontWeight:700,color:'#22c55e'}}>+{routingHistory.length * 2}</div>
                  <div style={{fontSize:'0.6rem',color:'#64748b'}}>Routing Trust</div>
                </div>
                <div>
                  <div style={{fontSize:'1.25rem',fontWeight:700,color:'#a855f7'}}>{(avgHebbian * 100).toFixed(0)}%</div>
                  <div style={{fontSize:'0.6rem',color:'#64748b'}}>Hebbian Strength</div>
                </div>
                <div>
                  <div style={{fontSize:'1.25rem',fontWeight:700,color:'#22d3ee'}}>{routingHistory.length}</div>
                  <div style={{fontSize:'0.6rem',color:'#64748b'}}>Successful Routes</div>
                </div>
              </div>
            </div>
          )}

          <div style={{display:'flex',gap:'0.5rem',marginBottom:'1.5rem',flexWrap:'wrap'}}>
            {Object.entries(scenarios).map(([key, s]) => (
              <button key={key} onClick={() => setScenario(key)} style={{
                padding:'0.375rem 0.75rem',borderRadius:'0.25rem',fontSize:'0.75rem',fontFamily:'monospace',
                transition:'all 0.2s',cursor:'pointer',
                background: scenario === key ? 'rgba(34,197,94,0.2)' : 'rgba(30,41,59,0.5)',
                color: scenario === key ? '#22c55e' : '#64748b',
                border: scenario === key ? '1px solid rgba(34,197,94,0.5)' : '1px solid rgba(51,65,85,0.5)'
              }}>
                {s.label}
              </button>
            ))}
          </div>

          <div style={{marginBottom:'1rem',background:'rgba(2,6,23,0.5)',borderRadius:'0.5rem',padding:'1rem'}}>
            <LineChart data={data} width={600} height={200} />
          </div>

          {scenarios[scenario].events.length > 0 && (
            <div style={{display:'flex',flexWrap:'wrap',gap:'0.5rem',marginBottom:'1rem'}}>
              {scenarios[scenario].events.map((event, i) => (
                <div key={i} style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.375rem 0.75rem',borderRadius:'0.5rem',background:'rgba(30,41,59,0.5)',fontSize:'0.75rem',fontFamily:'monospace'}}>
                  <Icon name="clock" size={12} style={{color:'#64748b'}} />
                  <span style={{color:'#94a3b8'}}>Day {event.day}:</span>
                  <span style={{color: event.impact > 0 ? '#22c55e' : '#ef4444'}}>{event.impact > 0 ? "+" : ""}{event.impact}</span>
                  <span style={{color:'#64748b'}}>{event.label}</span>
                </div>
              ))}
            </div>
          )}

          {/* Hebbian correlation note */}
          <div style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.5rem 0.75rem',borderRadius:'0.375rem',background:'rgba(168,85,247,0.08)',border:'1px solid rgba(168,85,247,0.2)'}}>
            <Icon name="brain" size={14} style={{color:'#a855f7'}} />
            <span style={{fontSize:'0.7rem',fontFamily:'monospace',color:'#a855f7'}}>{scenarios[scenario].hebbianNote}</span>
            <span style={{fontSize:'0.6rem',color:'#64748b',marginLeft:'auto'}}>Trust events correlate with Hebbian pathway changes</span>
          </div>
        </GlowCard>
      );
    };

    // Workflow Demo
    const WorkflowDemo = ({ message = {}, routingHistory = [] }) => {
      const [step, setStep] = useState(0);
      const [isPlaying, setIsPlaying] = useState(false);

      // Use live message data or defaults
      const liveContext = message.context || "Add dark mode toggle";
      const liveMode = message.mode || "Build";
      const livePriority = message.priority || "High";
      const liveAction = message.actionType || "Execute";

      // Get last routing result if available
      const lastRoute = routingHistory[routingHistory.length - 1];
      const primaryAgent = lastRoute ? AGENTS[lastRoute.primary]?.name : "Copilot";
      const secondaryAgent = lastRoute ? AGENTS[lastRoute.secondary]?.name : "Daemon";

      const steps = [
        { title: "1. User Composes ATP Message", description: "Developer structures their intent using ATP signal tags", code: `#Mode: ${liveMode} #Context: ${liveContext.substring(0, 40)} #Priority: ${livePriority} #ActionType: ${liveAction}`, highlight: "cyan" },
        { title: "2. ATP Parser Validates", description: "System parses and validates the structured message", code: `{\n  mode: "${liveMode}",\n  context: "${liveContext.substring(0, 30)}",\n  priority: "${livePriority}",\n  actionType: "${liveAction}",\n  isValid: true\n}`, highlight: "green" },
        { title: "3. Hebbian Agent Router", description: "Keywords + Hebbian weights route to optimal agent", code: `Router.hebbianMatch("${liveContext.substring(0, 25)}")\n→ KeywordScore: 0.4 × keywords[...]\n→ HebbianScore: 0.3 × pathStrength(${primaryAgent.toLowerCase()})\n→ ModeScore: 0.2 × mode("${liveMode}")\n→ Winner: ${primaryAgent} (score: ${lastRoute?.scores?.[lastRoute.primary]?.total?.toFixed(2) || '0.85'})`, highlight: "purple" },
        { title: "4. Agent Processes Request", description: `${primaryAgent} agent executes within defined scope`, code: `${primaryAgent}.handle({\n  action: "${liveAction.toLowerCase()}",\n  target: "${liveContext.substring(0, 20).replace(/\s+/g, '_')}",\n  context: session.current\n})`, highlight: "amber" },
        { title: "5. Response + Hebbian Learn", description: "System returns result, updates trust & strengthens neural pathways", code: `{\n  status: "success",\n  output: "${liveContext.substring(0, 25)} completed",\n  trustDelta: +5,\n  hebbianUpdate: {\n    primary: "${primaryAgent.toLowerCase()}", secondary: "${secondaryAgent.toLowerCase()}",\n    strengthDelta: +0.1  // Neurons that fire together...\n  },\n  auditLog: "${primaryAgent.toLowerCase()}_action_${Date.now().toString().slice(-5)}"\n}`, highlight: "cyan" }
      ];
      const highlightColors = {
        cyan: { border: 'rgba(34,211,238,0.5)', bg: 'rgba(34,211,238,0.05)' },
        green: { border: 'rgba(34,197,94,0.5)', bg: 'rgba(34,197,94,0.05)' },
        purple: { border: 'rgba(168,85,247,0.5)', bg: 'rgba(168,85,247,0.05)' },
        amber: { border: 'rgba(251,191,36,0.5)', bg: 'rgba(251,191,36,0.05)' }
      };

      useEffect(() => {
        if (isPlaying) {
          const timer = setTimeout(() => {
            if (step < steps.length - 1) setStep(step + 1);
            else setIsPlaying(false);
          }, 2500);
          return () => clearTimeout(timer);
        }
      }, [isPlaying, step]);

      return (
        <GlowCard glowColor="amber" style={{padding:'1.5rem'}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'1.5rem',flexWrap:'wrap',gap:'1rem'}}>
            <div style={{display:'flex',alignItems:'center',gap:'0.75rem'}}>
              <div style={{padding:'0.5rem',borderRadius:'0.5rem',background:'rgba(251,191,36,0.1)'}}>
                <Icon name="play" size={20} style={{color:'#fbbf24'}} />
              </div>
              <div>
                <h2 style={{fontSize:'1.125rem',fontWeight:'600',color:'#fff',margin:0}}>Full Workflow Demo</h2>
                <p style={{fontSize:'0.75rem',color:'#64748b',margin:0}}>End-to-end ATP message lifecycle</p>
              </div>
            </div>
            <button onClick={() => { setStep(0); setIsPlaying(true); }} style={{
              display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.5rem 1rem',borderRadius:'0.5rem',
              background:'linear-gradient(90deg, #f59e0b, #d97706)',color:'#fff',fontFamily:'monospace',fontSize:'0.875rem',
              border:'none',cursor:'pointer',boxShadow:'0 4px 20px rgba(251,191,36,0.25)'
            }}>
              <Icon name="play" size={14} />
              {isPlaying ? "Playing..." : "Play Demo"}
            </button>
          </div>

          <div style={{display:'flex',gap:'0.5rem',marginBottom:'1.5rem'}}>
            {steps.map((_, i) => (
              <div key={i} style={{height:'0.25rem',flex:1,borderRadius:'9999px',transition:'all 0.3s',background: i <= step ? '#fbbf24' : '#334155'}} />
            ))}
          </div>

          <div style={{padding:'1.5rem',borderRadius:'0.5rem',border:`2px solid ${highlightColors[steps[step].highlight].border}`,background:highlightColors[steps[step].highlight].bg,transition:'all 0.5s'}}>
            <div style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.75rem'}}>
              <Icon name="sparkles" size={16} style={{color:'#fbbf24'}} />
              <h3 style={{fontWeight:'600',color:'#fff',margin:0}}>{steps[step].title}</h3>
            </div>
            <p style={{fontSize:'0.875rem',color:'#94a3b8',marginBottom:'1rem'}}>{steps[step].description}</p>
            <pre style={{padding:'1rem',borderRadius:'0.5rem',background:'#020617',border:'1px solid rgba(51,65,85,0.5)',fontFamily:'monospace',fontSize:'0.875rem',color:'#cbd5e1',overflow:'auto',margin:0,whiteSpace:'pre-wrap'}}>{steps[step].code}</pre>
          </div>

          <div style={{display:'flex',justifyContent:'space-between',marginTop:'1.5rem'}}>
            <button onClick={() => setStep(Math.max(0, step - 1))} disabled={step === 0} style={{
              padding:'0.5rem 1rem',borderRadius:'0.5rem',fontFamily:'monospace',fontSize:'0.875rem',
              background:'transparent',border:'none',cursor: step === 0 ? 'not-allowed' : 'pointer',
              color: step === 0 ? '#475569' : '#94a3b8'
            }}>← Previous</button>
            <button onClick={() => setStep(Math.min(steps.length - 1, step + 1))} disabled={step === steps.length - 1} style={{
              padding:'0.5rem 1rem',borderRadius:'0.5rem',fontFamily:'monospace',fontSize:'0.875rem',
              background:'transparent',border:'none',cursor: step === steps.length - 1 ? 'not-allowed' : 'pointer',
              color: step === steps.length - 1 ? '#475569' : '#94a3b8'
            }}>Next →</button>
          </div>
        </GlowCard>
      );
    };

    // Technical Architecture - Unified Flow Visualization
    const TechnicalArchitecture = ({ message = {}, routingHistory = [] }) => {
      const [activeStep, setActiveStep] = useState(-1);
      const [isAnimating, setIsAnimating] = useState(false);
      const [hoveredNode, setHoveredNode] = useState(null);

      // Get live context from message or use default
      const liveContext = message.context || "generate schema";
      const liveMode = message.mode || "Build";
      const lastRoute = routingHistory[routingHistory.length - 1];
      const primaryAgentKey = lastRoute?.primary || 'copilot';
      const secondaryAgentKey = lastRoute?.secondary;
      const primaryAgentName = AGENTS[primaryAgentKey]?.name || "Copilot";
      const hebbianWeight = lastRoute?.hebbianUsed ? `${(lastRoute.hebbianUsed * 100).toFixed(0)}%` : '30%';

      // Unified flow steps with node highlighting - USES LIVE DATA
      const flowSteps = [
        { id: 0, node: 'user', label: '1. User Input', desc: `User types: $ codex run "${liveContext.substring(0, 30)}${liveContext.length > 30 ? '...' : ''}"`, color: '#22d3ee' },
        { id: 1, node: 'cli', label: '2. CLI Parse', desc: `codex_cli.py parses args, mode=${liveMode}`, color: '#22d3ee' },
        { id: 2, node: 'kernel', label: '3. Kernel Boot', desc: 'kernel.py loads config, initializes execution context', color: '#a855f7' },
        { id: 3, node: 'router', label: '4. Hebbian Route', desc: `agent_router.py → ${primaryAgentName} (Hebbian: ${hebbianWeight})`, color: '#fbbf24' },
        { id: 4, node: 'kernel', label: '5. Load Agent', desc: `kernel.py loads ${primaryAgentName} agent class`, color: '#a855f7' },
        { id: 5, node: 'agents', label: '6. Agent Execute', desc: `${primaryAgentName} builds LLM prompt with context`, color: '#ff6b6b' },
        { id: 6, node: 'openai', label: '7. LLM Call', desc: 'OpenAI API processes prompt, returns completion', color: '#6c5ce7' },
        { id: 7, node: 'kernel', label: '8. Process Output', desc: 'kernel.py validates output, updates state_kernel.json', color: '#a855f7' },
        { id: 8, node: 'memory', label: '9. Memory + Hebbian', desc: `memory_bus.py writes + hebbianUpdate(${primaryAgentKey}${secondaryAgentKey ? ', ' + secondaryAgentKey : ''})`, color: '#22c55e' },
        { id: 9, node: 'cli', label: '10. Return Result', desc: 'codex_cli.py prints result to user terminal', color: '#22d3ee' },
        { id: 10, node: 'user', label: '11. Complete', desc: `✨ Task Complete - "${liveContext.substring(0, 20)}..." stored in memory`, color: '#00ffcc' }
      ];

      // Architecture nodes with positions
      const nodes = {
        user: { x: 450, y: 35, w: 90, h: 35, label: 'User', sublabel: '(You)', color: '#94a3b8' },
        cli: { x: 450, y: 100, w: 130, h: 35, label: 'codex_cli.py', sublabel: 'CLI Interface', color: '#22d3ee' },
        kernel: { x: 450, y: 200, w: 140, h: 50, label: 'kernel.py', sublabel: 'Core Dispatcher', color: '#a855f7', isMain: true },
        router: { x: 200, y: 200, w: 120, h: 45, label: 'agent_router', sublabel: '.py + .yaml', color: '#fbbf24' },
        agents: { x: 700, y: 200, w: 110, h: 45, label: 'agents/*.py', sublabel: 'Codex, Planner', color: '#ff6b6b' },
        memory: { x: 280, y: 320, w: 120, h: 45, label: 'memory_bus', sublabel: 'Obsidian/Supabase', color: '#22c55e' },
        openai: { x: 620, y: 320, w: 110, h: 45, label: 'OpenAI API', sublabel: 'LLM Compute', color: '#6c5ce7' }
      };

      // Connection paths
      const connections = [
        { from: 'user', to: 'cli', label: '' },
        { from: 'cli', to: 'kernel', label: 'process()' },
        { from: 'kernel', to: 'router', label: 'route()' },
        { from: 'router', to: 'kernel', label: 'return agent', reverse: true },
        { from: 'kernel', to: 'agents', label: 'handle()' },
        { from: 'agents', to: 'openai', label: 'call API' },
        { from: 'openai', to: 'agents', label: 'response', reverse: true },
        { from: 'agents', to: 'kernel', label: 'output', reverse: true },
        { from: 'kernel', to: 'memory', label: 'write()' },
        { from: 'memory', to: 'kernel', label: 'confirm', reverse: true },
        { from: 'kernel', to: 'cli', label: 'result', reverse: true }
      ];

      // Animate through all steps
      useEffect(() => {
        if (isAnimating) {
          const timer = setTimeout(() => {
            if (activeStep < flowSteps.length - 1) {
              setActiveStep(prev => prev + 1);
            } else {
              setIsAnimating(false);
            }
          }, 1000);
          return () => clearTimeout(timer);
        }
      }, [isAnimating, activeStep]);

      const startAnimation = () => {
        setActiveStep(0);
        setIsAnimating(true);
      };

      const resetAnimation = () => {
        setActiveStep(-1);
        setIsAnimating(false);
      };

      const currentStep = activeStep >= 0 ? flowSteps[activeStep] : null;
      const activeNode = currentStep?.node;

      return (
        <GlowCard glowColor="cyan" style={{padding:'1.5rem'}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'1rem',flexWrap:'wrap',gap:'1rem'}}>
            <div style={{display:'flex',alignItems:'center',gap:'0.75rem'}}>
              <div style={{padding:'0.5rem',borderRadius:'0.5rem',background:'rgba(34,211,238,0.1)'}}>
                <Icon name="layers" size={20} style={{color:'#22d3ee'}} />
              </div>
              <div>
                <h2 style={{fontSize:'1.125rem',fontWeight:'600',color:'#fff',margin:0}}>Unified System Architecture</h2>
                <p style={{fontSize:'0.75rem',color:'#64748b',margin:0}}>Complete execution flow from user input to memory storage</p>
              </div>
            </div>
            <div style={{display:'flex',gap:'0.5rem'}}>
              <button onClick={startAnimation} disabled={isAnimating} style={{
                padding:'0.5rem 1rem',borderRadius:'0.375rem',fontSize:'0.75rem',fontFamily:'monospace',
                background: isAnimating ? '#1e293b' : 'linear-gradient(90deg, #0891b2, #0e7490)',
                color: isAnimating ? '#475569' : '#fff',
                border:'none',cursor: isAnimating ? 'not-allowed' : 'pointer',
                boxShadow: isAnimating ? 'none' : '0 4px 15px rgba(34,211,238,0.25)'
              }}>
                {isAnimating ? 'Running...' : '▶ Run Full Flow'}
              </button>
              <button onClick={resetAnimation} style={{
                padding:'0.5rem 0.75rem',borderRadius:'0.375rem',fontSize:'0.75rem',fontFamily:'monospace',
                background:'rgba(30,41,59,0.5)',color:'#94a3b8',border:'1px solid rgba(51,65,85,0.5)',cursor:'pointer'
              }}>
                Reset
              </button>
            </div>
          </div>

          {/* Live Context Banner - shows when user has active message/routing */}
          {(message.context || routingHistory.length > 0) && (
            <div style={{
              background:'linear-gradient(90deg, rgba(34,211,238,0.1), rgba(168,85,247,0.1))',
              border:'1px solid rgba(34,211,238,0.3)',
              borderRadius:'0.5rem',
              padding:'0.75rem 1rem',
              marginBottom:'1rem',
              display:'flex',
              alignItems:'center',
              gap:'1rem',
              flexWrap:'wrap'
            }}>
              <div style={{display:'flex',alignItems:'center',gap:'0.5rem'}}>
                <div style={{width:'8px',height:'8px',borderRadius:'50%',background:'#22d3ee',animation:'pulse 2s infinite'}} />
                <span style={{fontSize:'0.75rem',color:'#22d3ee',fontWeight:'600'}}>LIVE CONTEXT</span>
              </div>
              <div style={{display:'flex',gap:'1rem',flexWrap:'wrap'}}>
                <div style={{fontSize:'0.7rem',color:'#94a3b8'}}>
                  <span style={{color:'#64748b'}}>Task:</span> <span style={{color:'#fff'}}>{liveContext.substring(0, 40)}{liveContext.length > 40 ? '...' : ''}</span>
                </div>
                <div style={{fontSize:'0.7rem',color:'#94a3b8'}}>
                  <span style={{color:'#64748b'}}>Mode:</span> <span style={{color:'#a855f7'}}>{liveMode}</span>
                </div>
                <div style={{fontSize:'0.7rem',color:'#94a3b8'}}>
                  <span style={{color:'#64748b'}}>Agent:</span> <span style={{color:'#fbbf24'}}>{primaryAgentName}</span>
                </div>
                {routingHistory.length > 0 && (
                  <div style={{fontSize:'0.7rem',color:'#94a3b8'}}>
                    <span style={{color:'#64748b'}}>Routes:</span> <span style={{color:'#22c55e'}}>{routingHistory.length}</span>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Main visualization */}
          <div style={{display:'grid',gridTemplateColumns:'1fr 280px',gap:'1rem'}}>
            {/* Architecture diagram */}
            <div style={{background:'rgba(2,6,23,0.5)',borderRadius:'0.5rem',padding:'1rem',position:'relative'}}>
              <svg width="100%" height="400" viewBox="0 0 900 400" preserveAspectRatio="xMidYMid meet">
                <defs>
                  <marker id="arrowFlow" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
                    <polygon points="0 0, 8 3, 0 6" fill="#475569"/>
                  </marker>
                  <marker id="arrowActive" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
                    <polygon points="0 0, 8 3, 0 6" fill="#a855f7"/>
                  </marker>
                  <filter id="glowFilter">
                    <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                    <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
                  </filter>
                </defs>

                {/* Connection lines */}
                <line x1="450" y1="70" x2="450" y2="95" stroke="#475569" strokeWidth="1.5" markerEnd="url(#arrowFlow)"/>
                <line x1="450" y1="135" x2="450" y2="170" stroke="#475569" strokeWidth="1.5" markerEnd="url(#arrowFlow)"/>
                <line x1="380" y1="215" x2="265" y2="215" stroke="#475569" strokeWidth="1.5" markerEnd="url(#arrowFlow)"/>
                <line x1="265" y1="230" x2="380" y2="230" stroke="#475569" strokeWidth="1.5" strokeDasharray="4,2"/>
                <line x1="520" y1="215" x2="645" y2="215" stroke="#475569" strokeWidth="1.5" markerEnd="url(#arrowFlow)"/>
                <line x1="645" y1="230" x2="520" y2="230" stroke="#475569" strokeWidth="1.5" strokeDasharray="4,2"/>
                <line x1="700" y1="250" x2="665" y2="315" stroke="#475569" strokeWidth="1.5" markerEnd="url(#arrowFlow)"/>
                <line x1="620" y1="315" x2="655" y2="250" stroke="#475569" strokeWidth="1.5" strokeDasharray="4,2"/>
                <line x1="400" y1="250" x2="335" y2="315" stroke="#475569" strokeWidth="1.5" markerEnd="url(#arrowFlow)"/>
                <line x1="280" y1="315" x2="345" y2="250" stroke="#475569" strokeWidth="1.5" strokeDasharray="4,2"/>

                {/* Nodes */}
                {Object.entries(nodes).map(([id, node]) => {
                  const isActive = activeNode === id;
                  const isHovered = hoveredNode === id;
                  return (
                    <g key={id}
                       onMouseEnter={() => setHoveredNode(id)}
                       onMouseLeave={() => setHoveredNode(null)}
                       style={{cursor:'pointer'}}>
                      {/* Glow effect for active node */}
                      {isActive && (
                        <rect
                          x={node.x - node.w/2 - 5}
                          y={node.y - 5}
                          width={node.w + 10}
                          height={node.h + 10}
                          rx="8"
                          fill={node.color}
                          opacity="0.15"
                          filter="url(#glowFilter)"
                        />
                      )}
                      {/* Main node */}
                      <rect
                        x={node.x - node.w/2}
                        y={node.y}
                        width={node.w}
                        height={node.h}
                        rx="6"
                        fill={isActive ? `${node.color}30` : 'rgba(30,41,59,0.8)'}
                        stroke={node.color}
                        strokeWidth={isActive ? 3 : node.isMain ? 2 : 1.5}
                        style={{transition:'all 0.3s'}}
                      />
                      {/* Node label */}
                      <text
                        x={node.x}
                        y={node.y + (node.h/2) - (node.sublabel ? 4 : 0)}
                        fill={isActive ? '#fff' : node.color}
                        fontSize={node.isMain ? 12 : 10}
                        fontWeight={node.isMain || isActive ? 600 : 400}
                        fontFamily="monospace"
                        textAnchor="middle"
                      >
                        {node.label}
                      </text>
                      {node.sublabel && (
                        <text
                          x={node.x}
                          y={node.y + (node.h/2) + 10}
                          fill="#64748b"
                          fontSize="8"
                          fontFamily="monospace"
                          textAnchor="middle"
                        >
                          {node.sublabel}
                        </text>
                      )}
                      {/* Step indicator */}
                      {isActive && (
                        <circle
                          cx={node.x + node.w/2 - 8}
                          cy={node.y + 8}
                          r="8"
                          fill={currentStep.color}
                        >
                          <animate attributeName="opacity" values="1;0.5;1" dur="1s" repeatCount="indefinite"/>
                        </circle>
                      )}
                    </g>
                  );
                })}

                {/* Flow labels */}
                <text x="460" y="85" fill="#475569" fontSize="8" fontFamily="monospace">input</text>
                <text x="460" y="155" fill="#475569" fontSize="8" fontFamily="monospace">process()</text>
                <text x="320" y="208" fill="#475569" fontSize="8" fontFamily="monospace">route()</text>
                <text x="580" y="208" fill="#475569" fontSize="8" fontFamily="monospace">handle()</text>
                <text x="680" y="285" fill="#475569" fontSize="8" fontFamily="monospace">API</text>
                <text x="350" y="285" fill="#475569" fontSize="8" fontFamily="monospace">write()</text>

                {/* System title */}
                <text x="450" y="385" fill="#22d3ee" fontSize="11" fontWeight="600" fontFamily="monospace" textAnchor="middle">
                  Artemis-City Kernel Execution Pipeline
                </text>
              </svg>
            </div>

            {/* Step-by-step panel */}
            <div style={{display:'flex',flexDirection:'column',gap:'0.5rem'}}>
              <div style={{fontSize:'0.7rem',fontFamily:'monospace',color:'#64748b',textTransform:'uppercase',letterSpacing:'0.05em',marginBottom:'0.25rem'}}>
                Execution Steps
              </div>
              <div style={{flex:1,overflowY:'auto',maxHeight:'320px',display:'flex',flexDirection:'column',gap:'0.25rem'}}>
                {flowSteps.map((step, i) => {
                  const isActive = activeStep === i;
                  const isPast = activeStep > i;
                  return (
                    <div
                      key={step.id}
                      onClick={() => !isAnimating && setActiveStep(i)}
                      style={{
                        padding:'0.5rem',
                        borderRadius:'0.375rem',
                        background: isActive ? `${step.color}15` : 'rgba(30,41,59,0.3)',
                        border: isActive ? `1px solid ${step.color}` : '1px solid rgba(51,65,85,0.2)',
                        opacity: isPast ? 0.5 : 1,
                        cursor: isAnimating ? 'default' : 'pointer',
                        transition:'all 0.2s'
                      }}
                    >
                      <div style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.125rem'}}>
                        <div style={{
                          width:'16px',height:'16px',borderRadius:'50%',
                          background: isPast ? step.color : isActive ? `${step.color}60` : '#1e293b',
                          display:'flex',alignItems:'center',justifyContent:'center',
                          fontSize:'0.55rem',fontWeight:600,color: isPast ? '#020617' : step.color,
                          border: `1px solid ${step.color}`
                        }}>
                          {isPast ? '✓' : i + 1}
                        </div>
                        <span style={{fontSize:'0.7rem',fontWeight:600,color: isActive ? step.color : '#fff'}}>{step.label}</span>
                      </div>
                      <div style={{fontSize:'0.6rem',color:'#94a3b8',paddingLeft:'1.5rem'}}>{step.desc}</div>
                    </div>
                  );
                })}
              </div>

              {/* Current step detail */}
              {currentStep && (
                <div style={{padding:'0.75rem',background:`${currentStep.color}10`,border:`1px solid ${currentStep.color}40`,borderRadius:'0.375rem',marginTop:'0.5rem'}}>
                  <div style={{fontSize:'0.7rem',fontFamily:'monospace',color:currentStep.color,marginBottom:'0.25rem'}}>
                    Currently: {currentStep.label}
                  </div>
                  <div style={{fontSize:'0.6rem',color:'#94a3b8'}}>{currentStep.desc}</div>
                </div>
              )}

              {/* Legend */}
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0.5rem',marginTop:'auto',paddingTop:'0.5rem',borderTop:'1px solid rgba(51,65,85,0.3)'}}>
                <div style={{display:'flex',alignItems:'center',gap:'0.375rem'}}>
                  <div style={{width:'8px',height:'8px',borderRadius:'50%',background:'#a855f7'}}/>
                  <span style={{fontSize:'0.55rem',color:'#64748b'}}>Kernel</span>
                </div>
                <div style={{display:'flex',alignItems:'center',gap:'0.375rem'}}>
                  <div style={{width:'8px',height:'8px',borderRadius:'50%',background:'#22d3ee'}}/>
                  <span style={{fontSize:'0.55rem',color:'#64748b'}}>CLI</span>
                </div>
                <div style={{display:'flex',alignItems:'center',gap:'0.375rem'}}>
                  <div style={{width:'8px',height:'8px',borderRadius:'50%',background:'#fbbf24'}}/>
                  <span style={{fontSize:'0.55rem',color:'#64748b'}}>Router</span>
                </div>
                <div style={{display:'flex',alignItems:'center',gap:'0.375rem'}}>
                  <div style={{width:'8px',height:'8px',borderRadius:'50%',background:'#ff6b6b'}}/>
                  <span style={{fontSize:'0.55rem',color:'#64748b'}}>Agents</span>
                </div>
                <div style={{display:'flex',alignItems:'center',gap:'0.375rem'}}>
                  <div style={{width:'8px',height:'8px',borderRadius:'50%',background:'#22c55e'}}/>
                  <span style={{fontSize:'0.55rem',color:'#64748b'}}>Memory</span>
                </div>
                <div style={{display:'flex',alignItems:'center',gap:'0.375rem'}}>
                  <div style={{width:'8px',height:'8px',borderRadius:'50%',background:'#6c5ce7'}}/>
                  <span style={{fontSize:'0.55rem',color:'#64748b'}}>LLM</span>
                </div>
              </div>
            </div>
          </div>

          {/* OS Analogy footer */}
          <div style={{marginTop:'1rem',display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(180px, 1fr))',gap:'0.75rem'}}>
            <div style={{padding:'0.75rem',background:'rgba(168,85,247,0.08)',border:'1px solid rgba(168,85,247,0.2)',borderRadius:'0.375rem'}}>
              <div style={{fontSize:'0.65rem',fontFamily:'monospace',color:'#a855f7',marginBottom:'0.25rem'}}>🔧 Kernel = Orchestrator</div>
              <div style={{fontSize:'0.55rem',color:'#94a3b8'}}>Central dispatcher coordinating all subsystems</div>
            </div>
            <div style={{padding:'0.75rem',background:'rgba(255,107,107,0.08)',border:'1px solid rgba(255,107,107,0.2)',borderRadius:'0.375rem'}}>
              <div style={{fontSize:'0.65rem',fontFamily:'monospace',color:'#ff6b6b',marginBottom:'0.25rem'}}>⚙️ Agents = Processes</div>
              <div style={{fontSize:'0.55rem',color:'#94a3b8'}}>Specialized workers handling specific tasks</div>
            </div>
            <div style={{padding:'0.75rem',background:'rgba(34,197,94,0.08)',border:'1px solid rgba(34,197,94,0.2)',borderRadius:'0.375rem'}}>
              <div style={{fontSize:'0.65rem',fontFamily:'monospace',color:'#22c55e',marginBottom:'0.25rem'}}>💾 Memory Bus = Hardware</div>
              <div style={{fontSize:'0.55rem',color:'#94a3b8'}}>Persistent storage abstraction layer</div>
            </div>
            <div style={{padding:'0.75rem',background:'rgba(251,191,36,0.08)',border:'1px solid rgba(251,191,36,0.2)',borderRadius:'0.375rem'}}>
              <div style={{fontSize:'0.65rem',fontFamily:'monospace',color:'#fbbf24',marginBottom:'0.25rem'}}>📡 Router = Syscall</div>
              <div style={{fontSize:'0.55rem',color:'#94a3b8'}}>Command interpreter and dispatch logic</div>
            </div>
          </div>
        </GlowCard>
      );
    };

    // Cost Savings Comparison - ATP vs Legacy Full LLM
    const CostSavings = ({ routingHistory = [] }) => {
      const [scenario, setScenario] = useState('enterprise');
      const [animated, setAnimated] = useState(false);

      const scenarios = {
        startup: { name: 'Startup', requests: 10000, label: '10K req/mo' },
        growth: { name: 'Growth', requests: 100000, label: '100K req/mo' },
        enterprise: { name: 'Enterprise', requests: 1000000, label: '1M req/mo' },
        scale: { name: 'Scale', requests: 10000000, label: '10M req/mo' }
      };

      // Cost assumptions (per 1K tokens)
      const costs = {
        gpt4: { input: 0.03, output: 0.06, name: 'GPT-4', color: '#ef4444' },
        gpt4turbo: { input: 0.01, output: 0.03, name: 'GPT-4 Turbo', color: '#f97316' },
        gpt35: { input: 0.0005, output: 0.0015, name: 'GPT-3.5', color: '#eab308' },
        claude3opus: { input: 0.015, output: 0.075, name: 'Claude 3 Opus', color: '#a855f7' },
        claude3sonnet: { input: 0.003, output: 0.015, name: 'Claude 3 Sonnet', color: '#8b5cf6' }
      };

      // Average tokens per request
      const avgInputTokens = 800;  // Context + prompt
      const avgOutputTokens = 400; // Response

      // ATP efficiency factors
      const atpFactors = {
        routingEfficiency: 0.7,      // 70% requests handled by smaller models
        contextPruning: 0.4,         // 40% reduction in input tokens via smart context
        cachedResponses: 0.15,       // 15% requests served from memory/cache
        hebbianRouting: 0.1          // 10% better routing via learned paths
      };

      const currentScenario = scenarios[scenario];
      const requests = currentScenario.requests;

      // Legacy cost calculation (all requests to GPT-4)
      const legacyCost = {
        input: (requests * avgInputTokens / 1000) * costs.gpt4.input,
        output: (requests * avgOutputTokens / 1000) * costs.gpt4.output
      };
      legacyCost.total = legacyCost.input + legacyCost.output;

      // ATP cost calculation (smart routing)
      const atpBreakdown = {
        // 15% cached (zero cost)
        cached: requests * atpFactors.cachedResponses,
        // 70% to smaller models (GPT-3.5 equivalent)
        smallModel: requests * atpFactors.routingEfficiency * (1 - atpFactors.cachedResponses),
        // 30% to large models (GPT-4) - complex tasks only
        largeModel: requests * (1 - atpFactors.routingEfficiency) * (1 - atpFactors.cachedResponses)
      };

      // Reduced tokens due to context pruning
      const prunedInputTokens = avgInputTokens * (1 - atpFactors.contextPruning);

      const atpCost = {
        cached: 0,
        smallModel: (atpBreakdown.smallModel * prunedInputTokens / 1000) * costs.gpt35.input +
                    (atpBreakdown.smallModel * avgOutputTokens / 1000) * costs.gpt35.output,
        largeModel: (atpBreakdown.largeModel * prunedInputTokens / 1000) * costs.gpt4.input +
                    (atpBreakdown.largeModel * avgOutputTokens / 1000) * costs.gpt4.output
      };
      atpCost.total = atpCost.smallModel + atpCost.largeModel;

      const savings = legacyCost.total - atpCost.total;
      const savingsPercent = (savings / legacyCost.total) * 100;

      const formatCurrency = (val) => {
        if (val >= 1000000) return `$${(val / 1000000).toFixed(2)}M`;
        if (val >= 1000) return `$${(val / 1000).toFixed(1)}K`;
        return `$${val.toFixed(2)}`;
      };

      useEffect(() => {
        setAnimated(false);
        const timer = setTimeout(() => setAnimated(true), 100);
        return () => clearTimeout(timer);
      }, [scenario]);

      return (
        <GlowCard glowColor="green" style={{padding:'1.5rem'}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'1.5rem',flexWrap:'wrap',gap:'1rem'}}>
            <div style={{display:'flex',alignItems:'center',gap:'0.75rem'}}>
              <div style={{padding:'0.5rem',borderRadius:'0.5rem',background:'rgba(34,197,94,0.1)'}}>
                <Icon name="zap" size={20} style={{color:'#22c55e'}} />
              </div>
              <div>
                <h2 style={{fontSize:'1.125rem',fontWeight:'600',color:'#fff',margin:0}}>ATP Cost Savings</h2>
                <p style={{fontSize:'0.75rem',color:'#64748b',margin:0}}>vs Legacy Full LLM Architecture</p>
              </div>
            </div>
            <div style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.5rem 1rem',borderRadius:'0.5rem',background:'rgba(34,197,94,0.15)',border:'1px solid rgba(34,197,94,0.3)'}}>
              <span style={{fontSize:'1.5rem',fontWeight:'700',color:'#22c55e'}}>{savingsPercent.toFixed(0)}%</span>
              <span style={{fontSize:'0.75rem',color:'#94a3b8'}}>savings</span>
            </div>
          </div>

          {/* Scenario selector */}
          <div style={{display:'flex',gap:'0.5rem',marginBottom:'1.5rem',flexWrap:'wrap'}}>
            {Object.entries(scenarios).map(([key, s]) => (
              <button key={key} onClick={() => setScenario(key)} style={{
                padding:'0.5rem 1rem',borderRadius:'0.375rem',fontSize:'0.75rem',fontFamily:'monospace',
                transition:'all 0.2s',cursor:'pointer',
                background: scenario === key ? 'rgba(34,197,94,0.2)' : 'rgba(30,41,59,0.5)',
                color: scenario === key ? '#22c55e' : '#64748b',
                border: scenario === key ? '1px solid rgba(34,197,94,0.5)' : '1px solid rgba(51,65,85,0.5)'
              }}>
                <div style={{fontWeight:600}}>{s.name}</div>
                <div style={{fontSize:'0.65rem',opacity:0.7}}>{s.label}</div>
              </button>
            ))}
          </div>

          {/* Cost comparison bars */}
          <div style={{display:'grid',gap:'1.5rem',gridTemplateColumns:'1fr 1fr',marginBottom:'1.5rem'}}>
            {/* Legacy */}
            <div style={{padding:'1rem',background:'rgba(239,68,68,0.05)',border:'1px solid rgba(239,68,68,0.2)',borderRadius:'0.5rem'}}>
              <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'0.75rem'}}>
                <span style={{fontSize:'0.8rem',fontWeight:600,color:'#ef4444'}}>Legacy Full LLM</span>
                <span style={{fontSize:'1.25rem',fontWeight:700,color:'#ef4444'}}>{formatCurrency(legacyCost.total)}</span>
              </div>
              <div style={{height:'12px',background:'rgba(239,68,68,0.1)',borderRadius:'0.25rem',overflow:'hidden',marginBottom:'0.5rem'}}>
                <div style={{
                  height:'100%',background:'linear-gradient(90deg, #ef4444, #dc2626)',borderRadius:'0.25rem',
                  width: animated ? '100%' : '0%',transition:'width 1s ease-out'
                }}/>
              </div>
              <div style={{fontSize:'0.65rem',color:'#94a3b8'}}>
                All {(requests/1000).toFixed(0)}K requests → GPT-4 @ {avgInputTokens}+{avgOutputTokens} tokens
              </div>
            </div>

            {/* ATP */}
            <div style={{padding:'1rem',background:'rgba(34,197,94,0.05)',border:'1px solid rgba(34,197,94,0.2)',borderRadius:'0.5rem'}}>
              <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'0.75rem'}}>
                <span style={{fontSize:'0.8rem',fontWeight:600,color:'#22c55e'}}>ATP Optimized</span>
                <span style={{fontSize:'1.25rem',fontWeight:700,color:'#22c55e'}}>{formatCurrency(atpCost.total)}</span>
              </div>
              <div style={{height:'12px',background:'rgba(34,197,94,0.1)',borderRadius:'0.25rem',overflow:'hidden',marginBottom:'0.5rem'}}>
                <div style={{
                  height:'100%',background:'linear-gradient(90deg, #22c55e, #16a34a)',borderRadius:'0.25rem',
                  width: animated ? `${(atpCost.total / legacyCost.total) * 100}%` : '0%',transition:'width 1s ease-out'
                }}/>
              </div>
              <div style={{fontSize:'0.65rem',color:'#94a3b8'}}>
                Smart routing + context pruning + Hebbian caching
              </div>
            </div>
          </div>

          {/* Savings highlight */}
          <div style={{padding:'1rem',background:'linear-gradient(135deg, rgba(34,197,94,0.1), rgba(34,211,238,0.1))',border:'1px solid rgba(34,197,94,0.3)',borderRadius:'0.5rem',textAlign:'center',marginBottom:'1.5rem'}}>
            <div style={{fontSize:'0.7rem',color:'#64748b',textTransform:'uppercase',letterSpacing:'0.05em',marginBottom:'0.25rem'}}>Monthly Savings</div>
            <div style={{fontSize:'2rem',fontWeight:700,color:'#22c55e'}}>{formatCurrency(savings)}</div>
            <div style={{fontSize:'0.75rem',color:'#94a3b8'}}>
              {formatCurrency(savings * 12)}/year at {currentScenario.label}
            </div>
          </div>

          {/* ATP efficiency breakdown */}
          <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(140px, 1fr))',gap:'0.75rem',marginBottom:'1rem'}}>
            <div style={{padding:'0.75rem',background:'rgba(30,41,59,0.5)',borderRadius:'0.375rem',textAlign:'center'}}>
              <div style={{fontSize:'1.25rem',fontWeight:700,color:'#22d3ee'}}>{(atpFactors.routingEfficiency * 100).toFixed(0)}%</div>
              <div style={{fontSize:'0.6rem',color:'#64748b'}}>Routed to smaller models</div>
              <div style={{fontSize:'0.55rem',color:'#475569',marginTop:'0.25rem'}}>via Hebbian agent matching</div>
            </div>
            <div style={{padding:'0.75rem',background:'rgba(30,41,59,0.5)',borderRadius:'0.375rem',textAlign:'center'}}>
              <div style={{fontSize:'1.25rem',fontWeight:700,color:'#a855f7'}}>{(atpFactors.contextPruning * 100).toFixed(0)}%</div>
              <div style={{fontSize:'0.6rem',color:'#64748b'}}>Context reduction</div>
              <div style={{fontSize:'0.55rem',color:'#475569',marginTop:'0.25rem'}}>via semantic memory</div>
            </div>
            <div style={{padding:'0.75rem',background:'rgba(30,41,59,0.5)',borderRadius:'0.375rem',textAlign:'center'}}>
              <div style={{fontSize:'1.25rem',fontWeight:700,color:'#fbbf24'}}>{(atpFactors.cachedResponses * 100).toFixed(0)}%</div>
              <div style={{fontSize:'0.6rem',color:'#64748b'}}>Cached responses</div>
              <div style={{fontSize:'0.55rem',color:'#475569',marginTop:'0.25rem'}}>via vector memory</div>
            </div>
            <div style={{padding:'0.75rem',background:'rgba(30,41,59,0.5)',borderRadius:'0.375rem',textAlign:'center'}}>
              <div style={{fontSize:'1.25rem',fontWeight:700,color:'#22c55e'}}>{(atpFactors.hebbianRouting * 100).toFixed(0)}%</div>
              <div style={{fontSize:'0.6rem',color:'#64748b'}}>Routing improvement</div>
              <div style={{fontSize:'0.55rem',color:'#475569',marginTop:'0.25rem'}}>via learned pathways</div>
            </div>
          </div>

          {/* How ATP saves costs */}
          <div style={{background:'rgba(2,6,23,0.5)',borderRadius:'0.5rem',padding:'1rem'}}>
            <div style={{fontSize:'0.7rem',fontFamily:'monospace',color:'#64748b',textTransform:'uppercase',letterSpacing:'0.05em',marginBottom:'0.75rem'}}>
              How ATP Reduces Costs
            </div>
            <div style={{display:'grid',gap:'0.5rem'}}>
              <div style={{display:'flex',alignItems:'flex-start',gap:'0.5rem'}}>
                <Icon name="brain" size={14} style={{color:'#a855f7',marginTop:'2px',flexShrink:0}} />
                <div>
                  <span style={{fontSize:'0.7rem',fontWeight:600,color:'#fff'}}>Hebbian Agent Routing</span>
                  <span style={{fontSize:'0.65rem',color:'#64748b'}}> — Learned pathways route simple tasks to smaller, cheaper models (GPT-3.5)</span>
                </div>
              </div>
              <div style={{display:'flex',alignItems:'flex-start',gap:'0.5rem'}}>
                <Icon name="database" size={14} style={{color:'#22c55e',marginTop:'2px',flexShrink:0}} />
                <div>
                  <span style={{fontSize:'0.7rem',fontWeight:600,color:'#fff'}}>Vector Memory Cache</span>
                  <span style={{fontSize:'0.65rem',color:'#64748b'}}> — Similar queries served from semantic cache, zero LLM cost</span>
                </div>
              </div>
              <div style={{display:'flex',alignItems:'flex-start',gap:'0.5rem'}}>
                <Icon name="layers" size={14} style={{color:'#22d3ee',marginTop:'2px',flexShrink:0}} />
                <div>
                  <span style={{fontSize:'0.7rem',fontWeight:600,color:'#fff'}}>Smart Context Pruning</span>
                  <span style={{fontSize:'0.65rem',color:'#64748b'}}> — ATP tags + memory reduce input tokens by 40%</span>
                </div>
              </div>
              <div style={{display:'flex',alignItems:'flex-start',gap:'0.5rem'}}>
                <Icon name="shield" size={14} style={{color:'#fbbf24',marginTop:'2px',flexShrink:0}} />
                <div>
                  <span style={{fontSize:'0.7rem',fontWeight:600,color:'#fff'}}>Trust-Based Escalation</span>
                  <span style={{fontSize:'0.65rem',color:'#64748b'}}> — Only critical/complex requests escalate to expensive models</span>
                </div>
              </div>
            </div>
          </div>

          {/* Comparison table */}
          <div style={{marginTop:'1rem',overflowX:'auto'}}>
            <table style={{width:'100%',borderCollapse:'collapse',fontSize:'0.7rem'}}>
              <thead>
                <tr style={{borderBottom:'1px solid rgba(51,65,85,0.5)'}}>
                  <th style={{textAlign:'left',padding:'0.5rem',color:'#64748b',fontWeight:500}}>Metric</th>
                  <th style={{textAlign:'right',padding:'0.5rem',color:'#ef4444',fontWeight:500}}>Legacy</th>
                  <th style={{textAlign:'right',padding:'0.5rem',color:'#22c55e',fontWeight:500}}>ATP</th>
                  <th style={{textAlign:'right',padding:'0.5rem',color:'#22d3ee',fontWeight:500}}>Improvement</th>
                </tr>
              </thead>
              <tbody>
                <tr style={{borderBottom:'1px solid rgba(51,65,85,0.3)'}}>
                  <td style={{padding:'0.5rem',color:'#94a3b8'}}>Avg tokens/request</td>
                  <td style={{padding:'0.5rem',color:'#fff',textAlign:'right'}}>{avgInputTokens + avgOutputTokens}</td>
                  <td style={{padding:'0.5rem',color:'#fff',textAlign:'right'}}>{Math.round(prunedInputTokens + avgOutputTokens)}</td>
                  <td style={{padding:'0.5rem',color:'#22c55e',textAlign:'right'}}>-{((1 - (prunedInputTokens + avgOutputTokens)/(avgInputTokens + avgOutputTokens)) * 100).toFixed(0)}%</td>
                </tr>
                <tr style={{borderBottom:'1px solid rgba(51,65,85,0.3)'}}>
                  <td style={{padding:'0.5rem',color:'#94a3b8'}}>GPT-4 calls</td>
                  <td style={{padding:'0.5rem',color:'#fff',textAlign:'right'}}>{(requests/1000).toFixed(0)}K</td>
                  <td style={{padding:'0.5rem',color:'#fff',textAlign:'right'}}>{(atpBreakdown.largeModel/1000).toFixed(0)}K</td>
                  <td style={{padding:'0.5rem',color:'#22c55e',textAlign:'right'}}>-{((1 - atpBreakdown.largeModel/requests) * 100).toFixed(0)}%</td>
                </tr>
                <tr style={{borderBottom:'1px solid rgba(51,65,85,0.3)'}}>
                  <td style={{padding:'0.5rem',color:'#94a3b8'}}>Cached (free)</td>
                  <td style={{padding:'0.5rem',color:'#fff',textAlign:'right'}}>0</td>
                  <td style={{padding:'0.5rem',color:'#fff',textAlign:'right'}}>{(atpBreakdown.cached/1000).toFixed(0)}K</td>
                  <td style={{padding:'0.5rem',color:'#22c55e',textAlign:'right'}}>+{(atpFactors.cachedResponses * 100).toFixed(0)}%</td>
                </tr>
                <tr>
                  <td style={{padding:'0.5rem',color:'#94a3b8',fontWeight:600}}>Monthly Cost</td>
                  <td style={{padding:'0.5rem',color:'#ef4444',textAlign:'right',fontWeight:600}}>{formatCurrency(legacyCost.total)}</td>
                  <td style={{padding:'0.5rem',color:'#22c55e',textAlign:'right',fontWeight:600}}>{formatCurrency(atpCost.total)}</td>
                  <td style={{padding:'0.5rem',color:'#22c55e',textAlign:'right',fontWeight:600}}>-{savingsPercent.toFixed(0)}%</td>
                </tr>
              </tbody>
            </table>
          </div>

          {/* Live Demo Stats */}
          {routingHistory.length > 0 && (
            <div style={{marginTop:'1.5rem',padding:'1rem',background:'linear-gradient(135deg, rgba(34,211,238,0.1), rgba(168,85,247,0.1))',border:'1px solid rgba(34,211,238,0.3)',borderRadius:'0.5rem'}}>
              <div style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.75rem'}}>
                <div style={{width:'8px',height:'8px',borderRadius:'50%',background:'#22c55e',animation:'pulse-glow 1s ease-in-out infinite'}} />
                <span style={{fontSize:'0.75rem',fontFamily:'monospace',color:'#22d3ee',textTransform:'uppercase',letterSpacing:'0.05em'}}>Live Demo Session</span>
              </div>
              <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(120px, 1fr))',gap:'1rem'}}>
                <div style={{textAlign:'center'}}>
                  <div style={{fontSize:'1.5rem',fontWeight:700,color:'#22d3ee'}}>{routingHistory.length}</div>
                  <div style={{fontSize:'0.6rem',color:'#64748b'}}>Routes Processed</div>
                </div>
                <div style={{textAlign:'center'}}>
                  <div style={{fontSize:'1.5rem',fontWeight:700,color:'#a855f7'}}>{(routingHistory.length * 0.7).toFixed(0)}</div>
                  <div style={{fontSize:'0.6rem',color:'#64748b'}}>→ Small Models</div>
                </div>
                <div style={{textAlign:'center'}}>
                  <div style={{fontSize:'1.5rem',fontWeight:700,color:'#22c55e'}}>${(routingHistory.length * 0.03).toFixed(2)}</div>
                  <div style={{fontSize:'0.6rem',color:'#64748b'}}>Session Savings</div>
                </div>
                <div style={{textAlign:'center'}}>
                  <div style={{fontSize:'1.5rem',fontWeight:700,color:'#fbbf24'}}>{Math.floor(routingHistory.length * 0.15)}</div>
                  <div style={{fontSize:'0.6rem',color:'#64748b'}}>Cache Hits</div>
                </div>
              </div>
              <div style={{marginTop:'0.75rem',fontSize:'0.6rem',color:'#475569',textAlign:'center'}}>
                Try the Message Builder → Route multiple messages → Watch Hebbian weights strengthen!
              </div>
            </div>
          )}
        </GlowCard>
      );
    };

    // Hero
    const Hero = () => (
      <div style={{textAlign:'center',marginBottom:'3rem'}}>
        <div style={{display:'inline-flex',alignItems:'center',gap:'0.5rem',padding:'0.5rem 1rem',borderRadius:'9999px',background:'rgba(0,255,204,0.1)',border:'1px solid rgba(0,255,204,0.3)',marginBottom:'1.5rem'}}>
          <Icon name="globe" size={16} style={{color:'#00ffcc'}} />
          <span style={{color:'#00ffcc',fontFamily:'monospace',fontSize:'0.875rem'}}>Artemis City v1.0.0 — Living Agent Ecosystem</span>
        </div>
        <h1 style={{fontSize:'2.5rem',fontWeight:'700',color:'#fff',marginBottom:'1rem',lineHeight:1.2}}>
          Welcome to <span style={{background:'linear-gradient(90deg, #00ffcc, #22d3ee, #a855f7)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent'}}>Artemis City</span>
        </h1>
        <p style={{fontSize:'1.125rem',color:'#94a3b8',maxWidth:'42rem',margin:'0 auto'}}>
          Where agents aren't just code—they're <span style={{color:'#00ffcc',fontWeight:'600'}}>citizens</span> of a thriving ecosystem. Mail delivery, archives, clearances, and neural pathways power a living city.
        </p>
      </div>
    );

    // Notification Toast Component
    const Toast = ({ message, type, onClose }) => {
      const colors = {
        success: { bg: 'rgba(34,197,94,0.15)', border: 'rgba(34,197,94,0.5)', text: '#22c55e' },
        info: { bg: 'rgba(34,211,238,0.15)', border: 'rgba(34,211,238,0.5)', text: '#22d3ee' },
        hebbian: { bg: 'rgba(168,85,247,0.15)', border: 'rgba(168,85,247,0.5)', text: '#a855f7' },
        warning: { bg: 'rgba(251,191,36,0.15)', border: 'rgba(251,191,36,0.5)', text: '#fbbf24' }
      };
      const c = colors[type] || colors.info;

      useEffect(() => {
        const timer = setTimeout(onClose, 4000);
        return () => clearTimeout(timer);
      }, [onClose]);

      return (
        <div style={{
          padding:'0.75rem 1rem',borderRadius:'0.5rem',
          background:c.bg,border:`1px solid ${c.border}`,
          display:'flex',alignItems:'center',gap:'0.5rem',
          animation:'slideIn 0.3s ease-out',
          boxShadow:'0 4px 20px rgba(0,0,0,0.3)'
        }}>
          <Icon name={type === 'hebbian' ? 'brain' : type === 'success' ? 'checkCircle' : 'zap'} size={16} style={{color:c.text}} />
          <span style={{fontSize:'0.8rem',color:c.text,fontFamily:'monospace'}}>{message}</span>
          <button onClick={onClose} style={{marginLeft:'auto',background:'none',border:'none',color:'#64748b',cursor:'pointer',fontSize:'1rem'}}>×</button>
        </div>
      );
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // LIVING CITY - Main Visualization Component
    // ═══════════════════════════════════════════════════════════════════════════

    const LivingCity = ({ routingHistory = [], hebbianState, message }) => {
      const [mailQueue, setMailQueue] = useState([]);
      const [cityStats, setCityStats] = useState({
        totalMail: 0,
        deliveredMail: 0,
        pendingMail: 0,
        archiveEntries: 0
      });
      const [selectedCitizen, setSelectedCitizen] = useState(null);
      const [animatingMail, setAnimatingMail] = useState(null);

      // Generate mail from routing history
      useEffect(() => {
        const newMail = routingHistory.map((route, i) => ({
          id: `MAIL-${Date.now()}-${i}`,
          from: route.primary,
          to: route.secondary || 'archives',
          subject: route.context?.substring(0, 30) + '...',
          priority: route.mode === 'Review' ? 'urgent' : 'normal',
          status: 'delivered',
          timestamp: route.timestamp
        }));
        setMailQueue(newMail);
        setCityStats(prev => ({
          ...prev,
          totalMail: newMail.length,
          deliveredMail: newMail.length,
          archiveEntries: Math.floor(newMail.length * 0.7)
        }));
      }, [routingHistory]);

      // Simulate mail delivery animation
      const sendMail = (from, to) => {
        const newMail = {
          id: `MAIL-${Date.now()}`,
          from, to,
          subject: 'Inter-Citizen Communication',
          priority: 'normal',
          status: 'in-transit'
        };
        setAnimatingMail({ from, to });
        setTimeout(() => {
          setAnimatingMail(null);
          setMailQueue(prev => [...prev, { ...newMail, status: 'delivered' }]);
          setCityStats(prev => ({
            ...prev,
            totalMail: prev.totalMail + 1,
            deliveredMail: prev.deliveredMail + 1
          }));
        }, 1500);
      };

      // City map node positions
      const cityNodes = {
        artemis: { x: 450, y: 60, building: 'City Hall' },
        packrat: { x: 200, y: 180, building: 'Post Office' },
        copilot: { x: 700, y: 180, building: 'Info Desk' },
        daemon: { x: 450, y: 300, building: 'Ops Center' },
        archives: { x: 450, y: 180, building: 'Archives' }
      };

      return (
        <div style={{display:'grid',gap:'1.5rem',gridTemplateColumns:'1fr 320px'}}>
          {/* Main City Visualization */}
          <GlowCard glowColor="cyan" style={{padding:'1.5rem'}}>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'1rem',flexWrap:'wrap',gap:'1rem'}}>
              <div style={{display:'flex',alignItems:'center',gap:'0.75rem'}}>
                <div style={{padding:'0.5rem',borderRadius:'0.5rem',background:'rgba(0,255,204,0.1)'}}>
                  <Icon name="globe" size={24} style={{color:'#00ffcc'}} />
                </div>
                <div>
                  <h2 style={{fontSize:'1.25rem',fontWeight:'700',color:'#fff',margin:0}}>Artemis City</h2>
                  <p style={{fontSize:'0.75rem',color:'#64748b',margin:0}}>Where agents are citizens of a thriving ecosystem</p>
                </div>
              </div>
              <div style={{display:'flex',gap:'0.5rem'}}>
                <div style={{padding:'0.375rem 0.75rem',borderRadius:'0.25rem',background:'rgba(34,197,94,0.1)',border:'1px solid rgba(34,197,94,0.3)'}}>
                  <span style={{fontSize:'0.7rem',color:'#22c55e',fontFamily:'monospace'}}>Population: {Object.keys(AGENTS).length} Citizens</span>
                </div>
                <div style={{padding:'0.375rem 0.75rem',borderRadius:'0.25rem',background:'rgba(251,191,36,0.1)',border:'1px solid rgba(251,191,36,0.3)'}}>
                  <span style={{fontSize:'0.7rem',color:'#fbbf24',fontFamily:'monospace'}}>Status: Thriving</span>
                </div>
              </div>
            </div>

            {/* Interactive City Map */}
            <div style={{background:'rgba(2,6,23,0.6)',borderRadius:'0.5rem',padding:'1rem',position:'relative',minHeight:'380px'}}>
              <svg width="100%" height="380" viewBox="0 0 900 380" preserveAspectRatio="xMidYMid meet">
                <defs>
                  <filter id="cityGlow">
                    <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                    <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
                  </filter>
                  <linearGradient id="roadGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stopColor="#1e293b"/>
                    <stop offset="50%" stopColor="#334155"/>
                    <stop offset="100%" stopColor="#1e293b"/>
                  </linearGradient>
                  <marker id="mailArrow" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
                    <polygon points="0 0, 8 3, 0 6" fill="#ffd93d"/>
                  </marker>
                </defs>

                {/* City Roads */}
                <path d="M200,180 L450,180 L700,180" stroke="url(#roadGradient)" strokeWidth="20" fill="none" opacity="0.5"/>
                <path d="M450,60 L450,300" stroke="url(#roadGradient)" strokeWidth="20" fill="none" opacity="0.5"/>
                <line x1="200" y1="180" x2="450" y2="60" stroke="#1e293b" strokeWidth="8" strokeDasharray="10,5"/>
                <line x1="700" y1="180" x2="450" y2="60" stroke="#1e293b" strokeWidth="8" strokeDasharray="10,5"/>
                <line x1="200" y1="180" x2="450" y2="300" stroke="#1e293b" strokeWidth="8" strokeDasharray="10,5"/>
                <line x1="700" y1="180" x2="450" y2="300" stroke="#1e293b" strokeWidth="8" strokeDasharray="10,5"/>

                {/* Mail Animation */}
                {animatingMail && (
                  <g>
                    <circle r="8" fill="#ffd93d" filter="url(#cityGlow)">
                      <animateMotion
                        dur="1.5s"
                        path={`M${cityNodes[animatingMail.from].x},${cityNodes[animatingMail.from].y} L${cityNodes[animatingMail.to].x},${cityNodes[animatingMail.to].y}`}
                        fill="freeze"
                      />
                    </circle>
                    <text fontSize="10" fill="#ffd93d" fontFamily="monospace">
                      <animateMotion
                        dur="1.5s"
                        path={`M${cityNodes[animatingMail.from].x},${cityNodes[animatingMail.from].y - 15} L${cityNodes[animatingMail.to].x},${cityNodes[animatingMail.to].y - 15}`}
                        fill="freeze"
                      />
                      ✉️
                    </text>
                  </g>
                )}

                {/* City Buildings / Citizens */}
                {Object.entries(AGENTS).map(([key, agent]) => {
                  const pos = cityNodes[key];
                  const isSelected = selectedCitizen === key;
                  const clearance = getClearanceLevel(agent.clearance);
                  const mailCount = mailQueue.filter(m => m.from === key || m.to === key).length;

                  return (
                    <g key={key} onClick={() => setSelectedCitizen(isSelected ? null : key)} style={{cursor:'pointer'}}>
                      {/* Building glow */}
                      {isSelected && (
                        <rect x={pos.x - 55} y={pos.y - 10} width="110" height="75" rx="8"
                          fill={agent.color} opacity="0.15" filter="url(#cityGlow)"/>
                      )}

                      {/* Building */}
                      <rect x={pos.x - 50} y={pos.y - 5} width="100" height="70" rx="6"
                        fill={isSelected ? `${agent.color}30` : 'rgba(30,41,59,0.9)'}
                        stroke={agent.color} strokeWidth={isSelected ? 3 : 2}/>

                      {/* Building Header */}
                      <rect x={pos.x - 50} y={pos.y - 5} width="100" height="20" rx="6"
                        fill={agent.color} opacity="0.3"/>

                      {/* Citizen Name */}
                      <text x={pos.x} y={pos.y + 8} fill="#fff" fontSize="11" fontWeight="700"
                        textAnchor="middle" fontFamily="system-ui">{agent.name}</text>

                      {/* Role */}
                      <text x={pos.x} y={pos.y + 24} fill={agent.color} fontSize="9" fontWeight="500"
                        textAnchor="middle" fontFamily="monospace">{agent.role}</text>

                      {/* Office */}
                      <text x={pos.x} y={pos.y + 38} fill="#64748b" fontSize="8"
                        textAnchor="middle" fontFamily="monospace">{agent.office}</text>

                      {/* Clearance Badge */}
                      <rect x={pos.x - 25} y={pos.y + 45} width="50" height="14" rx="3"
                        fill={clearance.color} opacity="0.2"/>
                      <text x={pos.x} y={pos.y + 55} fill={clearance.color} fontSize="8" fontWeight="600"
                        textAnchor="middle" fontFamily="monospace">{clearance.label}</text>

                      {/* Mail indicator */}
                      {mailCount > 0 && (
                        <g>
                          <circle cx={pos.x + 40} cy={pos.y} r="10" fill="#ffd93d"/>
                          <text x={pos.x + 40} y={pos.y + 4} fill="#020617" fontSize="9" fontWeight="700"
                            textAnchor="middle">{mailCount}</text>
                        </g>
                      )}
                    </g>
                  );
                })}

                {/* Central Archives Building */}
                <g onClick={() => setSelectedCitizen(selectedCitizen === 'archives' ? null : 'archives')} style={{cursor:'pointer'}}>
                  <rect x="400" y="140" width="100" height="50" rx="6"
                    fill={selectedCitizen === 'archives' ? 'rgba(34,197,94,0.3)' : 'rgba(30,41,59,0.9)'}
                    stroke="#22c55e" strokeWidth={selectedCitizen === 'archives' ? 3 : 2} strokeDasharray="5,3"/>
                  <text x="450" y="160" fill="#22c55e" fontSize="10" fontWeight="600"
                    textAnchor="middle" fontFamily="monospace">CITY ARCHIVES</text>
                  <text x="450" y="175" fill="#64748b" fontSize="8"
                    textAnchor="middle" fontFamily="monospace">{cityStats.archiveEntries} entries</text>
                </g>

                {/* City Title */}
                <text x="450" y="355" fill="#475569" fontSize="11" textAnchor="middle" fontFamily="monospace">
                  ─── Click citizens to view details • Mail routes shown on interaction ───
                </text>
              </svg>
            </div>

            {/* Quick Actions */}
            <div style={{display:'flex',gap:'0.5rem',marginTop:'1rem',flexWrap:'wrap'}}>
              <button onClick={() => sendMail('artemis', 'packrat')} style={{
                padding:'0.5rem 0.75rem',borderRadius:'0.375rem',fontSize:'0.7rem',fontFamily:'monospace',
                background:'rgba(0,255,204,0.1)',border:'1px solid rgba(0,255,204,0.3)',color:'#00ffcc',cursor:'pointer'
              }}>
                <Icon name="mail" size={12} style={{marginRight:'0.25rem',verticalAlign:'middle'}} />
                Mayor → Post Office
              </button>
              <button onClick={() => sendMail('packrat', 'copilot')} style={{
                padding:'0.5rem 0.75rem',borderRadius:'0.375rem',fontSize:'0.7rem',fontFamily:'monospace',
                background:'rgba(251,191,36,0.1)',border:'1px solid rgba(251,191,36,0.3)',color:'#fbbf24',cursor:'pointer'
              }}>
                <Icon name="truck" size={12} style={{marginRight:'0.25rem',verticalAlign:'middle'}} />
                Postal Delivery
              </button>
              <button onClick={() => sendMail('copilot', 'daemon')} style={{
                padding:'0.5rem 0.75rem',borderRadius:'0.375rem',fontSize:'0.7rem',fontFamily:'monospace',
                background:'rgba(255,107,107,0.1)',border:'1px solid rgba(255,107,107,0.3)',color:'#ff6b6b',cursor:'pointer'
              }}>
                <Icon name="activity" size={12} style={{marginRight:'0.25rem',verticalAlign:'middle'}} />
                Status Request
              </button>
              <button onClick={() => sendMail('daemon', 'artemis')} style={{
                padding:'0.5rem 0.75rem',borderRadius:'0.375rem',fontSize:'0.7rem',fontFamily:'monospace',
                background:'rgba(108,92,231,0.1)',border:'1px solid rgba(108,92,231,0.3)',color:'#6c5ce7',cursor:'pointer'
              }}>
                <Icon name="inbox" size={12} style={{marginRight:'0.25rem',verticalAlign:'middle'}} />
                Report to Mayor
              </button>
            </div>
          </GlowCard>

          {/* Right Sidebar - City Dashboard */}
          <div style={{display:'flex',flexDirection:'column',gap:'1rem'}}>
            {/* City Stats */}
            <GlowCard glowColor="green" style={{padding:'1rem'}}>
              <div style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.75rem'}}>
                <Icon name="activity" size={16} style={{color:'#22c55e'}} />
                <span style={{fontSize:'0.8rem',fontWeight:'600',color:'#fff'}}>City Statistics</span>
              </div>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0.5rem'}}>
                <div style={{padding:'0.5rem',background:'rgba(0,255,204,0.1)',borderRadius:'0.375rem',textAlign:'center'}}>
                  <div style={{fontSize:'1.25rem',fontWeight:'700',color:'#00ffcc'}}>{cityStats.totalMail}</div>
                  <div style={{fontSize:'0.6rem',color:'#64748b'}}>Total Mail</div>
                </div>
                <div style={{padding:'0.5rem',background:'rgba(34,197,94,0.1)',borderRadius:'0.375rem',textAlign:'center'}}>
                  <div style={{fontSize:'1.25rem',fontWeight:'700',color:'#22c55e'}}>{cityStats.deliveredMail}</div>
                  <div style={{fontSize:'0.6rem',color:'#64748b'}}>Delivered</div>
                </div>
                <div style={{padding:'0.5rem',background:'rgba(251,191,36,0.1)',borderRadius:'0.375rem',textAlign:'center'}}>
                  <div style={{fontSize:'1.25rem',fontWeight:'700',color:'#fbbf24'}}>{cityStats.archiveEntries}</div>
                  <div style={{fontSize:'0.6rem',color:'#64748b'}}>Archived</div>
                </div>
                <div style={{padding:'0.5rem',background:'rgba(168,85,247,0.1)',borderRadius:'0.375rem',textAlign:'center'}}>
                  <div style={{fontSize:'1.25rem',fontWeight:'700',color:'#a855f7'}}>{Object.keys(AGENTS).length}</div>
                  <div style={{fontSize:'0.6rem',color:'#64748b'}}>Citizens</div>
                </div>
              </div>
            </GlowCard>

            {/* Selected Citizen Details */}
            {selectedCitizen && selectedCitizen !== 'archives' && AGENTS[selectedCitizen] && (
              <GlowCard glowColor={selectedCitizen === 'artemis' ? 'cyan' : selectedCitizen === 'copilot' ? 'red' : selectedCitizen === 'packrat' ? 'yellow' : 'purple'} style={{padding:'1rem'}}>
                <div style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.75rem'}}>
                  <div style={{width:'32px',height:'32px',borderRadius:'50%',background:`${AGENTS[selectedCitizen].color}30`,
                    display:'flex',alignItems:'center',justifyContent:'center'}}>
                    <Icon name={AGENTS[selectedCitizen].icon} size={18} style={{color:AGENTS[selectedCitizen].color}} />
                  </div>
                  <div>
                    <div style={{fontSize:'0.9rem',fontWeight:'600',color:'#fff'}}>{AGENTS[selectedCitizen].name}</div>
                    <div style={{fontSize:'0.65rem',color:AGENTS[selectedCitizen].color}}>{AGENTS[selectedCitizen].role}</div>
                  </div>
                </div>
                <div style={{fontSize:'0.7rem',color:'#94a3b8',marginBottom:'0.75rem'}}>{AGENTS[selectedCitizen].description}</div>
                <div style={{marginBottom:'0.75rem'}}>
                  <div style={{fontSize:'0.65rem',color:'#64748b',marginBottom:'0.25rem'}}>OFFICE</div>
                  <div style={{fontSize:'0.75rem',color:'#fff',fontFamily:'monospace'}}>{AGENTS[selectedCitizen].office}</div>
                </div>
                <div style={{marginBottom:'0.75rem'}}>
                  <div style={{fontSize:'0.65rem',color:'#64748b',marginBottom:'0.25rem'}}>CLEARANCE</div>
                  <div style={{display:'flex',alignItems:'center',gap:'0.5rem'}}>
                    <div style={{flex:1,height:'6px',background:'rgba(51,65,85,0.5)',borderRadius:'3px',overflow:'hidden'}}>
                      <div style={{width:`${AGENTS[selectedCitizen].clearance * 100}%`,height:'100%',
                        background:getClearanceLevel(AGENTS[selectedCitizen].clearance).color,borderRadius:'3px'}} />
                    </div>
                    <span style={{fontSize:'0.7rem',color:getClearanceLevel(AGENTS[selectedCitizen].clearance).color,fontFamily:'monospace'}}>
                      {getClearanceLevel(AGENTS[selectedCitizen].clearance).label}
                    </span>
                  </div>
                </div>
                <div>
                  <div style={{fontSize:'0.65rem',color:'#64748b',marginBottom:'0.375rem'}}>DUTIES</div>
                  <div style={{display:'flex',flexDirection:'column',gap:'0.25rem'}}>
                    {AGENTS[selectedCitizen].duties.map((duty, i) => (
                      <div key={i} style={{fontSize:'0.65rem',color:'#94a3b8',display:'flex',alignItems:'center',gap:'0.375rem'}}>
                        <span style={{color:AGENTS[selectedCitizen].color}}>▸</span> {duty}
                      </div>
                    ))}
                  </div>
                </div>
              </GlowCard>
            )}

            {/* Mail Log */}
            <GlowCard glowColor="yellow" style={{padding:'1rem',maxHeight:'200px',overflow:'auto'}}>
              <div style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.75rem'}}>
                <Icon name="inbox" size={16} style={{color:'#fbbf24'}} />
                <span style={{fontSize:'0.8rem',fontWeight:'600',color:'#fff'}}>Postal Log</span>
                <span style={{fontSize:'0.6rem',color:'#64748b',marginLeft:'auto'}}>{mailQueue.length} items</span>
              </div>
              {mailQueue.length === 0 ? (
                <div style={{fontSize:'0.7rem',color:'#475569',textAlign:'center',padding:'1rem'}}>
                  No mail activity yet.<br/>Use the Message Builder to send mail!
                </div>
              ) : (
                <div style={{display:'flex',flexDirection:'column',gap:'0.375rem'}}>
                  {mailQueue.slice(-5).reverse().map((mail, i) => (
                    <div key={i} style={{padding:'0.375rem',background:'rgba(30,41,59,0.5)',borderRadius:'0.25rem',fontSize:'0.65rem'}}>
                      <div style={{display:'flex',alignItems:'center',gap:'0.375rem',marginBottom:'0.125rem'}}>
                        <span style={{color:AGENTS[mail.from]?.color || '#22c55e'}}>{AGENTS[mail.from]?.name || 'Archives'}</span>
                        <span style={{color:'#475569'}}>→</span>
                        <span style={{color:AGENTS[mail.to]?.color || '#22c55e'}}>{AGENTS[mail.to]?.name || 'Archives'}</span>
                        <span style={{marginLeft:'auto',padding:'0.125rem 0.25rem',borderRadius:'0.125rem',
                          background: mail.status === 'delivered' ? 'rgba(34,197,94,0.2)' : 'rgba(251,191,36,0.2)',
                          color: mail.status === 'delivered' ? '#22c55e' : '#fbbf24',fontSize:'0.5rem'}}>
                          {mail.status}
                        </span>
                      </div>
                      <div style={{color:'#64748b',whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}}>
                        {mail.subject}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </GlowCard>

            {/* Archive Structure */}
            <GlowCard glowColor="green" style={{padding:'1rem'}}>
              <div style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.75rem'}}>
                <Icon name="archive" size={16} style={{color:'#22c55e'}} />
                <span style={{fontSize:'0.8rem',fontWeight:'600',color:'#fff'}}>Archive Structure</span>
              </div>
              <div style={{fontFamily:'monospace',fontSize:'0.65rem',color:'#64748b',lineHeight:1.6}}>
                <div>📁 City Archives/</div>
                <div style={{paddingLeft:'1rem'}}>├── 📬 Postal/</div>
                <div style={{paddingLeft:'2rem'}}>│   └── Agents/</div>
                {Object.keys(AGENTS).map((key, i) => (
                  <div key={key} style={{paddingLeft:'3rem',color:AGENTS[key].color}}>
                    │       {i === Object.keys(AGENTS).length - 1 ? '└──' : '├──'} {key}/
                  </div>
                ))}
                <div style={{paddingLeft:'1rem'}}>├── 📖 Archives/</div>
                <div style={{paddingLeft:'2rem',color:'#94a3b8'}}>│   ├── Reflections/</div>
                <div style={{paddingLeft:'2rem',color:'#94a3b8'}}>│   ├── Reports/</div>
                <div style={{paddingLeft:'2rem',color:'#94a3b8'}}>│   └── Policies/</div>
                <div style={{paddingLeft:'1rem'}}>└── 📜 History/</div>
              </div>
            </GlowCard>
          </div>
        </div>
      );
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // Memory Bus - Vault Integration & Context Management
    // ═══════════════════════════════════════════════════════════════════════════

    const MemoryBusSection = ({ routingHistory, hebbianState }) => {
      const [activeComponent, setActiveComponent] = useState('overview');
      const [memoryLog, setMemoryLog] = useState([
        { id: 1, timestamp: '2025-01-20T10:30:00', agent: 'artemis', operation: 'read', path: 'Daily/2025-01-20.md', success: true, trust: 0.95 },
        { id: 2, timestamp: '2025-01-20T10:31:15', agent: 'packrat', operation: 'write', path: 'Agents/Context/packrat_mail.md', success: true, trust: 0.85 },
        { id: 3, timestamp: '2025-01-20T10:32:00', agent: 'copilot', operation: 'search', path: 'query: ATP protocol', success: true, trust: 0.80 },
        { id: 4, timestamp: '2025-01-20T10:33:30', agent: 'daemon', operation: 'read', path: 'Config/settings.md', success: true, trust: 0.85 },
        { id: 5, timestamp: '2025-01-20T10:35:00', agent: 'external', operation: 'delete', path: 'Archives/secret.md', success: false, trust: 0.25 }
      ]);
      const [busStatus, setBusStatus] = useState({
        mcp_connected: true,
        vault_connected: true,
        total_operations: 247,
        cache_hits: 89,
        avg_latency: 45
      });

      // Trust levels with permissions
      const trustLevels = [
        { level: 'FULL', range: '0.9-1.0', color: '#22c55e', ops: ['read', 'write', 'delete', 'search', 'tag', 'update', 'frontmatter'] },
        { level: 'HIGH', range: '0.7-0.9', color: '#3b82f6', ops: ['read', 'write', 'search', 'tag', 'update', 'frontmatter'] },
        { level: 'MEDIUM', range: '0.5-0.7', color: '#fbbf24', ops: ['read', 'write', 'search', 'tag'] },
        { level: 'LOW', range: '0.3-0.5', color: '#f97316', ops: ['read', 'search'] },
        { level: 'UNTRUSTED', range: '0.0-0.3', color: '#ef4444', ops: [] }
      ];

      // Memory client operations
      const clientOps = [
        { name: 'get_context', desc: 'Read note content', method: 'POST', path: '/api/getContext' },
        { name: 'append_context', desc: 'Append to note', method: 'POST', path: '/api/appendContext' },
        { name: 'update_note', desc: 'Replace note', method: 'POST', path: '/api/updateNote' },
        { name: 'search_notes', desc: 'Search vault', method: 'POST', path: '/api/searchNotes' },
        { name: 'list_notes', desc: 'List folder', method: 'POST', path: '/api/listNotes' },
        { name: 'delete_note', desc: 'Delete note', method: 'POST', path: '/api/deleteNote' },
        { name: 'manage_tags', desc: 'Tag operations', method: 'POST', path: '/api/manageTags' },
        { name: 'search_replace', desc: 'Find & replace', method: 'POST', path: '/api/searchReplace' }
      ];

      const components = [
        { id: 'overview', label: 'Overview', icon: 'activity' },
        { id: 'client', label: 'Memory Client', icon: 'database' },
        { id: 'trust', label: 'Trust Interface', icon: 'shield' },
        { id: 'loader', label: 'Context Loader', icon: 'inbox' },
        { id: 'log', label: 'Operation Log', icon: 'clock' }
      ];

      return (
        <div style={{display:'grid',gap:'1.5rem'}}>
          {/* Header */}
          <GlowCard glowColor="purple" style={{padding:'1.5rem'}}>
            <div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginBottom:'1rem'}}>
              <div style={{padding:'0.625rem',borderRadius:'0.5rem',background:'linear-gradient(135deg, rgba(168,85,247,0.2), rgba(34,211,238,0.2))'}}>
                <Icon name="database" size={24} style={{color:'#a855f7'}} />
              </div>
              <div>
                <h2 style={{fontSize:'1.25rem',fontWeight:'600',color:'#fff',margin:0}}>Memory Bus Integration</h2>
                <p style={{fontSize:'0.8rem',color:'#64748b',margin:0}}>Unified interface connecting Artemis City to Obsidian Vault via MCP Server</p>
              </div>
              <div style={{marginLeft:'auto',display:'flex',gap:'0.5rem'}}>
                <div style={{display:'flex',alignItems:'center',gap:'0.375rem',padding:'0.375rem 0.75rem',borderRadius:'0.25rem',background: busStatus.mcp_connected ? 'rgba(34,197,94,0.1)' : 'rgba(239,68,68,0.1)',border: busStatus.mcp_connected ? '1px solid rgba(34,197,94,0.3)' : '1px solid rgba(239,68,68,0.3)'}}>
                  <div style={{width:'6px',height:'6px',borderRadius:'50%',background: busStatus.mcp_connected ? '#22c55e' : '#ef4444',animation:'pulse 2s infinite'}} />
                  <span style={{fontSize:'0.65rem',fontFamily:'monospace',color: busStatus.mcp_connected ? '#22c55e' : '#ef4444'}}>MCP</span>
                </div>
                <div style={{display:'flex',alignItems:'center',gap:'0.375rem',padding:'0.375rem 0.75rem',borderRadius:'0.25rem',background: busStatus.vault_connected ? 'rgba(168,85,247,0.1)' : 'rgba(239,68,68,0.1)',border: busStatus.vault_connected ? '1px solid rgba(168,85,247,0.3)' : '1px solid rgba(239,68,68,0.3)'}}>
                  <div style={{width:'6px',height:'6px',borderRadius:'50%',background: busStatus.vault_connected ? '#a855f7' : '#ef4444',animation:'pulse 2s infinite'}} />
                  <span style={{fontSize:'0.65rem',fontFamily:'monospace',color: busStatus.vault_connected ? '#a855f7' : '#ef4444'}}>Vault</span>
                </div>
              </div>
            </div>

            {/* Component Tabs */}
            <div style={{display:'flex',gap:'0.5rem',flexWrap:'wrap'}}>
              {components.map(comp => (
                <button
                  key={comp.id}
                  onClick={() => setActiveComponent(comp.id)}
                  style={{
                    display:'flex',alignItems:'center',gap:'0.375rem',
                    padding:'0.5rem 0.875rem',borderRadius:'0.375rem',
                    fontSize:'0.75rem',fontFamily:'monospace',
                    background: activeComponent === comp.id ? 'linear-gradient(135deg, #a855f7, #7c3aed)' : 'rgba(30,41,59,0.5)',
                    color: activeComponent === comp.id ? '#fff' : '#94a3b8',
                    border: activeComponent === comp.id ? 'none' : '1px solid rgba(51,65,85,0.5)',
                    cursor:'pointer',transition:'all 0.2s'
                  }}
                >
                  <Icon name={comp.icon} size={14} />
                  {comp.label}
                </button>
              ))}
            </div>
          </GlowCard>

          {/* Overview Panel */}
          {activeComponent === 'overview' && (
            <div style={{display:'grid',gap:'1.5rem',gridTemplateColumns:'repeat(auto-fit, minmax(300px, 1fr))'}}>
              {/* Architecture Diagram */}
              <GlowCard glowColor="cyan" style={{padding:'1.25rem'}}>
                <h3 style={{fontSize:'0.85rem',fontFamily:'monospace',color:'#22d3ee',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                  <Icon name="mapPin" size={14} style={{marginRight:'0.5rem',verticalAlign:'middle'}} />
                  Architecture Flow
                </h3>
                <div style={{fontFamily:'monospace',fontSize:'0.6rem',lineHeight:'1.6',color:'#94a3b8',background:'#020617',padding:'1rem',borderRadius:'0.375rem',overflow:'auto'}}>
                  <pre style={{margin:0}}>{`
┌─────────────────────────────────────────────────────────┐
│                  Artemis City Agents                     │
│    ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  │
│    │ Artemis │  │ PackRat │  │ Copilot │  │  Daemon │  │
│    │ (Mayor) │  │(Postmstr)│  │ (Assist)│  │(Manager)│  │
│    └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  │
│         └──────────┬─┴───────────┴─┬───────────┘       │
│                    ▼               ▼                    │
│  ┌─────────────────────────────────────────────────┐   │
│  │             MEMORY BUS (Unified Interface)       │   │
│  │  ┌──────────┐  ┌─────────────┐  ┌────────────┐ │   │
│  │  │  Memory  │  │    Trust    │  │  Context   │ │   │
│  │  │  Client  │◄─┤  Interface  │──► Loader     │ │   │
│  │  └────┬─────┘  └──────┬──────┘  └─────┬──────┘ │   │
│  └───────┼───────────────┼───────────────┼────────┘   │
└──────────┼───────────────┼───────────────┼────────────┘
           │ REST API      │ Access        │ Load
           ▼ (Bearer)      │ Control       │ Context
┌──────────────────────────┴───────────────┴────────────┐
│           MCP Server (Artemis Agentic Memory)          │
│  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────────┐  │
│  │ Express│──►│  Auth  │──►│ Router │──►│   Tools    │  │
│  └────────┘  └────────┘  └────────┘  └──────┬─────┘  │
└─────────────────────────────────────────────┼─────────┘
                                              ▼
                                    ┌─────────────────┐
                                    │ Obsidian Vault  │
                                    │  (Knowledge)    │
                                    └─────────────────┘
`}</pre>
                </div>
              </GlowCard>

              {/* Stats Panel */}
              <GlowCard glowColor="green" style={{padding:'1.25rem'}}>
                <h3 style={{fontSize:'0.85rem',fontFamily:'monospace',color:'#22c55e',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                  <Icon name="activity" size={14} style={{marginRight:'0.5rem',verticalAlign:'middle'}} />
                  Bus Statistics
                </h3>
                <div style={{display:'grid',gap:'0.75rem'}}>
                  <div style={{display:'flex',justifyContent:'space-between',padding:'0.75rem',background:'rgba(30,41,59,0.5)',borderRadius:'0.375rem'}}>
                    <span style={{fontSize:'0.75rem',color:'#94a3b8'}}>Total Operations</span>
                    <span style={{fontSize:'0.9rem',fontFamily:'monospace',color:'#22c55e',fontWeight:600}}>{busStatus.total_operations}</span>
                  </div>
                  <div style={{display:'flex',justifyContent:'space-between',padding:'0.75rem',background:'rgba(30,41,59,0.5)',borderRadius:'0.375rem'}}>
                    <span style={{fontSize:'0.75rem',color:'#94a3b8'}}>Cache Hits</span>
                    <span style={{fontSize:'0.9rem',fontFamily:'monospace',color:'#3b82f6',fontWeight:600}}>{busStatus.cache_hits} ({Math.round(busStatus.cache_hits/busStatus.total_operations*100)}%)</span>
                  </div>
                  <div style={{display:'flex',justifyContent:'space-between',padding:'0.75rem',background:'rgba(30,41,59,0.5)',borderRadius:'0.375rem'}}>
                    <span style={{fontSize:'0.75rem',color:'#94a3b8'}}>Avg Latency</span>
                    <span style={{fontSize:'0.9rem',fontFamily:'monospace',color:'#fbbf24',fontWeight:600}}>{busStatus.avg_latency}ms</span>
                  </div>
                  <div style={{display:'flex',justifyContent:'space-between',padding:'0.75rem',background:'rgba(30,41,59,0.5)',borderRadius:'0.375rem'}}>
                    <span style={{fontSize:'0.75rem',color:'#94a3b8'}}>Agent Trust (Avg)</span>
                    <span style={{fontSize:'0.9rem',fontFamily:'monospace',color:'#a855f7',fontWeight:600}}>
                      {(Object.values(AGENTS).reduce((sum, a) => sum + a.clearance, 0) / Object.keys(AGENTS).length * 100).toFixed(0)}%
                    </span>
                  </div>
                </div>
              </GlowCard>
            </div>
          )}

          {/* Memory Client Panel */}
          {activeComponent === 'client' && (
            <div style={{display:'grid',gap:'1.5rem',gridTemplateColumns:'repeat(auto-fit, minmax(280px, 1fr))'}}>
              <GlowCard glowColor="cyan" style={{padding:'1.25rem'}}>
                <h3 style={{fontSize:'0.85rem',fontFamily:'monospace',color:'#22d3ee',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                  <Icon name="database" size={14} style={{marginRight:'0.5rem',verticalAlign:'middle'}} />
                  MCP Operations (8)
                </h3>
                <div style={{display:'grid',gap:'0.5rem'}}>
                  {clientOps.map((op, i) => (
                    <div key={i} style={{display:'flex',alignItems:'center',gap:'0.75rem',padding:'0.625rem',background:'rgba(30,41,59,0.5)',borderRadius:'0.375rem',border:'1px solid rgba(34,211,238,0.1)'}}>
                      <span style={{fontSize:'0.55rem',padding:'0.125rem 0.375rem',borderRadius:'0.125rem',background: op.method === 'POST' ? 'rgba(251,191,36,0.2)' : 'rgba(34,197,94,0.2)',color: op.method === 'POST' ? '#fbbf24' : '#22c55e',fontFamily:'monospace'}}>{op.method}</span>
                      <div style={{flex:1}}>
                        <div style={{fontSize:'0.75rem',color:'#fff',fontFamily:'monospace'}}>{op.name}()</div>
                        <div style={{fontSize:'0.6rem',color:'#64748b'}}>{op.desc}</div>
                      </div>
                      <span style={{fontSize:'0.55rem',color:'#475569',fontFamily:'monospace'}}>{op.path}</span>
                    </div>
                  ))}
                </div>
              </GlowCard>

              <GlowCard glowColor="purple" style={{padding:'1.25rem'}}>
                <h3 style={{fontSize:'0.85rem',fontFamily:'monospace',color:'#a855f7',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                  <Icon name="code" size={14} style={{marginRight:'0.5rem',verticalAlign:'middle'}} />
                  Python SDK Example
                </h3>
                <pre style={{background:'#020617',borderRadius:'0.375rem',padding:'0.75rem',margin:0,fontSize:'0.6rem',fontFamily:'monospace',color:'#e2e8f0',overflow:'auto',maxHeight:'300px'}}>
{`from integration import MemoryBus, get_memory_bus

# Initialize the bus
bus = get_memory_bus(
    base_url="http://localhost:3000",
    api_key="your_mcp_api_key"
)

# Trust-aware read operation
response = bus.read(
    agent_id="artemis",
    path="Daily/2025-01-20.md"
)

if response.success:
    print(f"Content: {response.data['content']}")
else:
    print(f"Error: {response.error}")

# Store agent context
bus.store_agent_context(
    agent_id="packrat",
    content="Mail delivered to Archives",
    folder="Agents/Context"
)

# Search with trust verification
entries = bus.load_context(
    agent_id="copilot",
    query="ATP protocol",
    limit=5
)

for entry in entries:
    print(f"📄 {entry.path}: {entry.get_summary()}")`}
                </pre>
              </GlowCard>
            </div>
          )}

          {/* Trust Interface Panel */}
          {activeComponent === 'trust' && (
            <div style={{display:'grid',gap:'1.5rem',gridTemplateColumns:'repeat(auto-fit, minmax(300px, 1fr))'}}>
              <GlowCard glowColor="amber" style={{padding:'1.25rem'}}>
                <h3 style={{fontSize:'0.85rem',fontFamily:'monospace',color:'#fbbf24',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                  <Icon name="shield" size={14} style={{marginRight:'0.5rem',verticalAlign:'middle'}} />
                  Trust Levels & Permissions
                </h3>
                <div style={{display:'grid',gap:'0.625rem'}}>
                  {trustLevels.map((level, i) => (
                    <div key={i} style={{padding:'0.75rem',background:'rgba(30,41,59,0.5)',borderRadius:'0.375rem',borderLeft:`3px solid ${level.color}`}}>
                      <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'0.5rem'}}>
                        <span style={{fontSize:'0.8rem',fontWeight:600,color:level.color}}>{level.level}</span>
                        <span style={{fontSize:'0.65rem',fontFamily:'monospace',color:'#64748b'}}>{level.range}</span>
                      </div>
                      <div style={{display:'flex',flexWrap:'wrap',gap:'0.25rem'}}>
                        {level.ops.length > 0 ? level.ops.map((op, j) => (
                          <span key={j} style={{fontSize:'0.55rem',padding:'0.125rem 0.375rem',borderRadius:'0.125rem',background:`${level.color}20`,color:level.color,fontFamily:'monospace'}}>{op}</span>
                        )) : (
                          <span style={{fontSize:'0.55rem',color:'#64748b',fontStyle:'italic'}}>No operations allowed</span>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </GlowCard>

              <GlowCard glowColor="green" style={{padding:'1.25rem'}}>
                <h3 style={{fontSize:'0.85rem',fontFamily:'monospace',color:'#22c55e',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                  <Icon name="users" size={14} style={{marginRight:'0.5rem',verticalAlign:'middle'}} />
                  Agent Trust Scores
                </h3>
                <div style={{display:'grid',gap:'0.625rem'}}>
                  {Object.entries(AGENTS).map(([key, agent]) => {
                    const trustPercent = agent.clearance * 100;
                    const level = trustPercent >= 90 ? trustLevels[0] : trustPercent >= 70 ? trustLevels[1] : trustPercent >= 50 ? trustLevels[2] : trustPercent >= 30 ? trustLevels[3] : trustLevels[4];
                    return (
                      <div key={key} style={{padding:'0.625rem',background:'rgba(30,41,59,0.5)',borderRadius:'0.375rem'}}>
                        <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'0.5rem'}}>
                          <div style={{display:'flex',alignItems:'center',gap:'0.5rem'}}>
                            <Icon name={agent.icon} size={14} style={{color:agent.color}} />
                            <span style={{fontSize:'0.75rem',color:'#fff'}}>{agent.name}</span>
                            <span style={{fontSize:'0.55rem',padding:'0.125rem 0.375rem',borderRadius:'0.125rem',background:`${level.color}20`,color:level.color}}>{level.level}</span>
                          </div>
                          <span style={{fontSize:'0.75rem',fontFamily:'monospace',color:level.color,fontWeight:600}}>{trustPercent.toFixed(0)}%</span>
                        </div>
                        <div style={{height:'4px',background:'rgba(51,65,85,0.5)',borderRadius:'2px',overflow:'hidden'}}>
                          <div style={{height:'100%',width:`${trustPercent}%`,background:`linear-gradient(90deg, ${agent.color}, ${level.color})`,borderRadius:'2px',transition:'width 0.5s'}} />
                        </div>
                      </div>
                    );
                  })}
                </div>

                <div style={{marginTop:'1rem',padding:'0.75rem',background:'rgba(251,191,36,0.05)',borderRadius:'0.375rem',border:'1px solid rgba(251,191,36,0.2)'}}>
                  <div style={{fontSize:'0.7rem',color:'#fbbf24',marginBottom:'0.5rem',fontWeight:600}}>Trust Decay Model</div>
                  <div style={{fontSize:'0.6rem',color:'#94a3b8',fontFamily:'monospace'}}>
                    score × (1 - 0.01)<sup>days</sup>
                    <div style={{marginTop:'0.25rem',color:'#64748b'}}>Default: 1% decay per day without activity</div>
                  </div>
                </div>
              </GlowCard>
            </div>
          )}

          {/* Context Loader Panel */}
          {activeComponent === 'loader' && (
            <div style={{display:'grid',gap:'1.5rem',gridTemplateColumns:'repeat(auto-fit, minmax(280px, 1fr))'}}>
              <GlowCard glowColor="cyan" style={{padding:'1.25rem'}}>
                <h3 style={{fontSize:'0.85rem',fontFamily:'monospace',color:'#22d3ee',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                  <Icon name="inbox" size={14} style={{marginRight:'0.5rem',verticalAlign:'middle'}} />
                  Context Loader Features
                </h3>
                <div style={{display:'grid',gap:'0.5rem'}}>
                  {[
                    { name: 'load_note(path)', desc: 'Load single note as ContextEntry', color: '#22d3ee' },
                    { name: 'search_context(query)', desc: 'Search vault with relevance scoring', color: '#a855f7' },
                    { name: 'load_folder_context(folder)', desc: 'Load all notes from folder', color: '#22c55e' },
                    { name: 'load_agent_history(agent)', desc: 'Load agent historical context', color: '#fbbf24' },
                    { name: 'load_tagged_context(tag)', desc: 'Load notes with specific tag', color: '#f97316' },
                    { name: 'get_related_context(path)', desc: 'Find related notes by keywords', color: '#ec4899' },
                    { name: 'filter_by_date_range()', desc: 'Filter entries by date range', color: '#06b6d4' },
                    { name: 'get_context_summary()', desc: 'Generate summary from entries', color: '#8b5cf6' }
                  ].map((fn, i) => (
                    <div key={i} style={{display:'flex',alignItems:'center',gap:'0.75rem',padding:'0.625rem',background:'rgba(30,41,59,0.5)',borderRadius:'0.375rem',borderLeft:`3px solid ${fn.color}`}}>
                      <div style={{flex:1}}>
                        <div style={{fontSize:'0.7rem',color:'#fff',fontFamily:'monospace'}}>{fn.name}</div>
                        <div style={{fontSize:'0.55rem',color:'#64748b'}}>{fn.desc}</div>
                      </div>
                    </div>
                  ))}
                </div>
              </GlowCard>

              <GlowCard glowColor="purple" style={{padding:'1.25rem'}}>
                <h3 style={{fontSize:'0.85rem',fontFamily:'monospace',color:'#a855f7',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                  <Icon name="archive" size={14} style={{marginRight:'0.5rem',verticalAlign:'middle'}} />
                  ContextEntry Structure
                </h3>
                <pre style={{background:'#020617',borderRadius:'0.375rem',padding:'0.75rem',margin:0,fontSize:'0.6rem',fontFamily:'monospace',color:'#e2e8f0',overflow:'auto'}}>
{`@dataclass
class ContextEntry:
    path: str          # "Daily/2025-01-20.md"
    content: str       # Note body text
    metadata: Dict     # YAML frontmatter
    tags: List[str]    # ["artemis", "atp"]
    created: str       # ISO timestamp
    modified: str      # ISO timestamp
    relevance: float   # 0.0-1.0 score

    def get_summary(max_len=100) -> str:
        """Truncated preview of content"""

    def to_dict() -> Dict:
        """Serialize to dictionary"""

# Example usage:
entry = loader.load_note("Daily/2025-01-20.md")
print(entry.get_summary())
# "Today's synthesis: ATP integration..."

for tag in entry.tags:
    print(f"🏷️ {tag}")`}
                </pre>
              </GlowCard>
            </div>
          )}

          {/* Operation Log Panel */}
          {activeComponent === 'log' && (
            <GlowCard glowColor="cyan" style={{padding:'1.25rem'}}>
              <h3 style={{fontSize:'0.85rem',fontFamily:'monospace',color:'#22d3ee',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                <Icon name="clock" size={14} style={{marginRight:'0.5rem',verticalAlign:'middle'}} />
                Recent Operations (Audit Log)
              </h3>
              <div style={{overflowX:'auto'}}>
                <table style={{width:'100%',borderCollapse:'collapse',fontSize:'0.7rem',fontFamily:'monospace'}}>
                  <thead>
                    <tr style={{borderBottom:'1px solid rgba(51,65,85,0.5)'}}>
                      <th style={{padding:'0.5rem',textAlign:'left',color:'#64748b',fontWeight:500}}>Timestamp</th>
                      <th style={{padding:'0.5rem',textAlign:'left',color:'#64748b',fontWeight:500}}>Agent</th>
                      <th style={{padding:'0.5rem',textAlign:'left',color:'#64748b',fontWeight:500}}>Operation</th>
                      <th style={{padding:'0.5rem',textAlign:'left',color:'#64748b',fontWeight:500}}>Path/Query</th>
                      <th style={{padding:'0.5rem',textAlign:'left',color:'#64748b',fontWeight:500}}>Trust</th>
                      <th style={{padding:'0.5rem',textAlign:'center',color:'#64748b',fontWeight:500}}>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {memoryLog.map((log, i) => {
                      const agent = AGENTS[log.agent] || { color: '#64748b', name: log.agent };
                      return (
                        <tr key={log.id} style={{borderBottom:'1px solid rgba(51,65,85,0.3)'}}>
                          <td style={{padding:'0.5rem',color:'#475569'}}>{log.timestamp.split('T')[1].substring(0,8)}</td>
                          <td style={{padding:'0.5rem'}}>
                            <span style={{color:agent.color}}>{agent.name || log.agent}</span>
                          </td>
                          <td style={{padding:'0.5rem'}}>
                            <span style={{padding:'0.125rem 0.375rem',borderRadius:'0.125rem',background: log.operation === 'read' ? 'rgba(34,197,94,0.15)' : log.operation === 'write' ? 'rgba(251,191,36,0.15)' : log.operation === 'search' ? 'rgba(168,85,247,0.15)' : 'rgba(239,68,68,0.15)',color: log.operation === 'read' ? '#22c55e' : log.operation === 'write' ? '#fbbf24' : log.operation === 'search' ? '#a855f7' : '#ef4444'}}>{log.operation}</span>
                          </td>
                          <td style={{padding:'0.5rem',color:'#94a3b8',maxWidth:'200px',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{log.path}</td>
                          <td style={{padding:'0.5rem',color: log.trust >= 0.7 ? '#22c55e' : log.trust >= 0.5 ? '#fbbf24' : '#ef4444'}}>{(log.trust * 100).toFixed(0)}%</td>
                          <td style={{padding:'0.5rem',textAlign:'center'}}>
                            {log.success ? (
                              <span style={{color:'#22c55e'}}>✓</span>
                            ) : (
                              <span style={{color:'#ef4444',cursor:'help'}} title="Access denied - insufficient trust">✗</span>
                            )}
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </GlowCard>
          )}
        </div>
      );
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // LLM API - Connect External LLMs to Artemis City
    // ═══════════════════════════════════════════════════════════════════════════

    const LLMApiSection = ({ routingHistory, hebbianState }) => {
      const [activeEndpoint, setActiveEndpoint] = useState('send-mail');
      const [testResponse, setTestResponse] = useState(null);
      const [isLoading, setIsLoading] = useState(false);

      // API Endpoints definition
      const endpoints = {
        'send-mail': {
          method: 'POST',
          path: '/api/v1/postal/send',
          description: 'Send mail between citizens or to archives',
          params: ['sender', 'recipient', 'subject', 'content', 'priority'],
          example: {
            sender: 'artemis',
            recipient: 'packrat',
            subject: 'New Postal Route Request',
            content: 'Please establish route to Sandbox District',
            priority: 'urgent'
          }
        },
        'route-message': {
          method: 'POST',
          path: '/api/v1/router/route',
          description: 'Route a message using Hebbian-weighted agent selection',
          params: ['context', 'mode', 'priority', 'action_type'],
          example: {
            context: 'Review the quarterly governance report',
            mode: 'Review',
            priority: 'High',
            action_type: 'Execute'
          }
        },
        'get-citizen': {
          method: 'GET',
          path: '/api/v1/citizens/{citizen_id}',
          description: 'Get citizen details including clearance and duties',
          params: ['citizen_id'],
          example: { citizen_id: 'artemis' }
        },
        'check-clearance': {
          method: 'GET',
          path: '/api/v1/trust/clearance/{citizen_id}',
          description: 'Check clearance level and permissions for a citizen',
          params: ['citizen_id'],
          example: { citizen_id: 'packrat' }
        },
        'query-archives': {
          method: 'POST',
          path: '/api/v1/archives/search',
          description: 'Search city archives with semantic query',
          params: ['query', 'section', 'requester'],
          example: {
            query: 'governance policy decisions',
            section: 'Policies',
            requester: 'copilot'
          }
        },
        'hebbian-weights': {
          method: 'GET',
          path: '/api/v1/neural/weights',
          description: 'Get current Hebbian connection weights between citizens',
          params: [],
          example: {}
        },
        'update-hebbian': {
          method: 'POST',
          path: '/api/v1/neural/strengthen',
          description: 'Strengthen neural pathway between two citizens',
          params: ['citizen_a', 'citizen_b', 'delta'],
          example: {
            citizen_a: 'artemis',
            citizen_b: 'copilot',
            delta: 0.1
          }
        },
        'city-status': {
          method: 'GET',
          path: '/api/v1/city/status',
          description: 'Get overall city health and statistics',
          params: [],
          example: {}
        }
      };

      const simulateApiCall = (endpoint) => {
        setIsLoading(true);
        setTestResponse(null);

        setTimeout(() => {
          const responses = {
            'send-mail': {
              success: true,
              tracking_id: `ART-${Date.now().toString(36).toUpperCase()}`,
              delivery_status: 'delivered',
              timestamp: new Date().toISOString()
            },
            'route-message': {
              success: true,
              primary_agent: 'artemis',
              secondary_agent: 'copilot',
              confidence: 0.87,
              hebbian_influence: 0.3,
              routing_breakdown: {
                keywords: 0.4,
                hebbian: 0.3,
                mode: 0.2,
                priority: 0.1
              }
            },
            'get-citizen': {
              citizen_id: 'artemis',
              name: 'Artemis',
              role: 'Mayor',
              office: 'City Hall',
              clearance: 0.95,
              clearance_level: 'FULL',
              duties: ['Policy decisions', 'Dispute resolution', 'City planning']
            },
            'check-clearance': {
              citizen_id: 'packrat',
              clearance_score: 0.85,
              clearance_level: 'HIGH',
              permissions: ['read', 'write', 'search', 'tag', 'update'],
              can_access_archives: true
            },
            'query-archives': {
              success: true,
              results: [
                { path: 'Archives/Policies/ATP_Protocol_v1.md', relevance: 0.92 },
                { path: 'Archives/Policies/Clearance_Guidelines.md', relevance: 0.85 }
              ],
              total_results: 2
            },
            'hebbian-weights': {
              weights: hebbianState?.weights || {},
              strongest_connection: 'artemis-copilot',
              average_strength: 0.45
            },
            'update-hebbian': {
              success: true,
              connection: 'artemis-copilot',
              previous_weight: 0.5,
              new_weight: 0.6,
              delta: 0.1
            },
            'city-status': {
              status: 'thriving',
              population: 4,
              total_mail_processed: routingHistory.length,
              archive_entries: Math.floor(routingHistory.length * 0.7),
              average_clearance: 0.86,
              neural_connections: Object.keys(hebbianState?.weights || {}).length
            }
          };
          setTestResponse(responses[endpoint]);
          setIsLoading(false);
        }, 800);
      };

      const currentEndpoint = endpoints[activeEndpoint];

      return (
        <div style={{display:'grid',gap:'1.5rem',gridTemplateColumns:'320px 1fr'}}>
          {/* Left Sidebar - Endpoints List */}
          <div style={{display:'flex',flexDirection:'column',gap:'0.5rem'}}>
            <GlowCard glowColor="purple" style={{padding:'1rem'}}>
              <div style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'1rem'}}>
                <Icon name="cpu" size={18} style={{color:'#a855f7'}} />
                <span style={{fontSize:'0.9rem',fontWeight:'600',color:'#fff'}}>API Endpoints</span>
              </div>

              <div style={{display:'flex',flexDirection:'column',gap:'0.375rem'}}>
                {Object.entries(endpoints).map(([key, ep]) => (
                  <button
                    key={key}
                    onClick={() => setActiveEndpoint(key)}
                    style={{
                      padding:'0.5rem 0.75rem',borderRadius:'0.375rem',textAlign:'left',
                      background: activeEndpoint === key ? 'rgba(168,85,247,0.2)' : 'rgba(30,41,59,0.5)',
                      border: activeEndpoint === key ? '1px solid rgba(168,85,247,0.5)' : '1px solid rgba(51,65,85,0.3)',
                      cursor:'pointer',transition:'all 0.2s'
                    }}
                  >
                    <div style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.25rem'}}>
                      <span style={{
                        fontSize:'0.55rem',padding:'0.125rem 0.375rem',borderRadius:'0.25rem',fontFamily:'monospace',fontWeight:'600',
                        background: ep.method === 'GET' ? 'rgba(34,197,94,0.2)' : 'rgba(251,191,36,0.2)',
                        color: ep.method === 'GET' ? '#22c55e' : '#fbbf24'
                      }}>{ep.method}</span>
                      <span style={{fontSize:'0.7rem',color: activeEndpoint === key ? '#a855f7' : '#fff',fontFamily:'monospace'}}>{key}</span>
                    </div>
                    <div style={{fontSize:'0.6rem',color:'#64748b'}}>{ep.description.substring(0, 40)}...</div>
                  </button>
                ))}
              </div>
            </GlowCard>

            {/* Quick Stats */}
            <GlowCard glowColor="cyan" style={{padding:'1rem'}}>
              <div style={{fontSize:'0.7rem',color:'#64748b',marginBottom:'0.5rem'}}>API STATISTICS</div>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0.5rem'}}>
                <div style={{textAlign:'center',padding:'0.5rem',background:'rgba(34,211,238,0.1)',borderRadius:'0.25rem'}}>
                  <div style={{fontSize:'1.25rem',fontWeight:'700',color:'#22d3ee'}}>{routingHistory.length}</div>
                  <div style={{fontSize:'0.55rem',color:'#64748b'}}>Requests</div>
                </div>
                <div style={{textAlign:'center',padding:'0.5rem',background:'rgba(34,197,94,0.1)',borderRadius:'0.25rem'}}>
                  <div style={{fontSize:'1.25rem',fontWeight:'700',color:'#22c55e'}}>99.9%</div>
                  <div style={{fontSize:'0.55rem',color:'#64748b'}}>Uptime</div>
                </div>
              </div>
            </GlowCard>
          </div>

          {/* Main Content - Endpoint Details */}
          <GlowCard glowColor="purple" style={{padding:'1.5rem'}}>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'1.5rem',flexWrap:'wrap',gap:'1rem'}}>
              <div style={{display:'flex',alignItems:'center',gap:'0.75rem'}}>
                <div style={{padding:'0.5rem',borderRadius:'0.5rem',background:'rgba(168,85,247,0.1)'}}>
                  <Icon name="cpu" size={24} style={{color:'#a855f7'}} />
                </div>
                <div>
                  <h2 style={{fontSize:'1.25rem',fontWeight:'700',color:'#fff',margin:0}}>Artemis City LLM API</h2>
                  <p style={{fontSize:'0.75rem',color:'#64748b',margin:0}}>Connect your LLM to the living city ecosystem</p>
                </div>
              </div>
              <div style={{display:'flex',gap:'0.5rem'}}>
                <div style={{padding:'0.375rem 0.75rem',borderRadius:'0.25rem',background:'rgba(34,197,94,0.1)',border:'1px solid rgba(34,197,94,0.3)'}}>
                  <span style={{fontSize:'0.7rem',color:'#22c55e',fontFamily:'monospace'}}>v1.0.0</span>
                </div>
                <div style={{padding:'0.375rem 0.75rem',borderRadius:'0.25rem',background:'rgba(168,85,247,0.1)',border:'1px solid rgba(168,85,247,0.3)'}}>
                  <span style={{fontSize:'0.7rem',color:'#a855f7',fontFamily:'monospace'}}>REST + WebSocket</span>
                </div>
              </div>
            </div>

            {/* Endpoint Details */}
            <div style={{display:'grid',gap:'1rem'}}>
              {/* Endpoint Header */}
              <div style={{background:'rgba(2,6,23,0.6)',borderRadius:'0.5rem',padding:'1rem'}}>
                <div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginBottom:'0.75rem'}}>
                  <span style={{
                    fontSize:'0.7rem',padding:'0.25rem 0.5rem',borderRadius:'0.25rem',fontFamily:'monospace',fontWeight:'600',
                    background: currentEndpoint.method === 'GET' ? 'rgba(34,197,94,0.2)' : 'rgba(251,191,36,0.2)',
                    color: currentEndpoint.method === 'GET' ? '#22c55e' : '#fbbf24'
                  }}>{currentEndpoint.method}</span>
                  <code style={{fontSize:'0.9rem',color:'#22d3ee',fontFamily:'monospace'}}>{currentEndpoint.path}</code>
                </div>
                <p style={{fontSize:'0.8rem',color:'#94a3b8',margin:0}}>{currentEndpoint.description}</p>
              </div>

              {/* Parameters */}
              {currentEndpoint.params.length > 0 && (
                <div>
                  <div style={{fontSize:'0.75rem',color:'#64748b',marginBottom:'0.5rem',fontFamily:'monospace'}}>PARAMETERS</div>
                  <div style={{display:'flex',flexWrap:'wrap',gap:'0.375rem'}}>
                    {currentEndpoint.params.map(param => (
                      <span key={param} style={{
                        padding:'0.25rem 0.5rem',borderRadius:'0.25rem',
                        background:'rgba(34,211,238,0.1)',border:'1px solid rgba(34,211,238,0.3)',
                        fontSize:'0.7rem',fontFamily:'monospace',color:'#22d3ee'
                      }}>{param}</span>
                    ))}
                  </div>
                </div>
              )}

              {/* Example Request */}
              <div>
                <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'0.5rem'}}>
                  <span style={{fontSize:'0.75rem',color:'#64748b',fontFamily:'monospace'}}>EXAMPLE REQUEST</span>
                  <button
                    onClick={() => simulateApiCall(activeEndpoint)}
                    disabled={isLoading}
                    style={{
                      padding:'0.375rem 0.75rem',borderRadius:'0.375rem',fontSize:'0.7rem',fontFamily:'monospace',
                      background: isLoading ? '#1e293b' : 'linear-gradient(90deg, #a855f7, #7c3aed)',
                      color: isLoading ? '#475569' : '#fff',
                      border:'none',cursor: isLoading ? 'not-allowed' : 'pointer'
                    }}
                  >
                    {isLoading ? 'Testing...' : '▶ Test Endpoint'}
                  </button>
                </div>
                <pre style={{
                  background:'#020617',borderRadius:'0.5rem',padding:'1rem',margin:0,
                  fontSize:'0.75rem',fontFamily:'monospace',color:'#e2e8f0',
                  overflow:'auto',maxHeight:'150px',border:'1px solid rgba(51,65,85,0.5)'
                }}>
{`curl -X ${currentEndpoint.method} \\
  https://api.artemis-city.dev${currentEndpoint.path} \\
  -H "Authorization: Bearer <API_KEY>" \\
  -H "Content-Type: application/json" \\
  -d '${JSON.stringify(currentEndpoint.example, null, 2)}'`}
                </pre>
              </div>

              {/* Response */}
              {testResponse && (
                <div>
                  <div style={{fontSize:'0.75rem',color:'#64748b',marginBottom:'0.5rem',fontFamily:'monospace'}}>RESPONSE</div>
                  <pre style={{
                    background:'rgba(34,197,94,0.1)',borderRadius:'0.5rem',padding:'1rem',margin:0,
                    fontSize:'0.75rem',fontFamily:'monospace',color:'#22c55e',
                    overflow:'auto',maxHeight:'200px',border:'1px solid rgba(34,197,94,0.3)'
                  }}>
{JSON.stringify(testResponse, null, 2)}
                  </pre>
                </div>
              )}

              {/* Python SDK Example */}
              <div>
                <div style={{fontSize:'0.75rem',color:'#64748b',marginBottom:'0.5rem',fontFamily:'monospace'}}>PYTHON SDK</div>
                <pre style={{
                  background:'#020617',borderRadius:'0.5rem',padding:'1rem',margin:0,
                  fontSize:'0.7rem',fontFamily:'monospace',color:'#e2e8f0',
                  overflow:'auto',maxHeight:'180px',border:'1px solid rgba(51,65,85,0.5)'
                }}>
{activeEndpoint === 'send-mail' ? `from artemis_city import PostOffice

post_office = PostOffice(api_key="your_key")

# Send mail between citizens
response = post_office.send_mail(
    sender="artemis",
    recipient="packrat",
    subject="New Postal Route Request",
    content="Please establish route to Sandbox District",
    priority="urgent"
)

print(f"Mail #{response.tracking_id} - {response.status}")` :
activeEndpoint === 'route-message' ? `from artemis_city import Router

router = Router(api_key="your_key")

# Route message with Hebbian-weighted selection
result = router.route(
    context="Review the quarterly governance report",
    mode="Review",
    priority="High"
)

print(f"Primary: {result.primary_agent}")
print(f"Confidence: {result.confidence:.2f}")
print(f"Hebbian Influence: {result.hebbian_influence:.0%}")` :
activeEndpoint === 'query-archives' ? `from artemis_city import Archives

archives = Archives(api_key="your_key")

# Search archives semantically
results = archives.search(
    query="governance policy decisions",
    section="Policies",
    requester="copilot"
)

for doc in results:
    print(f"📄 {doc.path} (relevance: {doc.relevance:.2f})")` :
activeEndpoint === 'hebbian-weights' ? `from artemis_city import NeuralNetwork

neural = NeuralNetwork(api_key="your_key")

# Get current Hebbian weights
weights = neural.get_weights()

print(f"Strongest: {weights.strongest_connection}")
print(f"Average: {weights.average_strength:.2f}")

# View all connections
for conn, weight in weights.items():
    print(f"  {conn}: {weight:.3f}")` :
`from artemis_city import City

city = City(api_key="your_key")

# Get city status
status = city.get_status()
print(f"Status: {status.status}")
print(f"Population: {status.population} citizens")
print(f"Mail Processed: {status.total_mail_processed}")`}
                </pre>
              </div>

              {/* LLM Integration Example */}
              <div style={{background:'linear-gradient(135deg, rgba(168,85,247,0.1), rgba(34,211,238,0.1))',borderRadius:'0.5rem',padding:'1rem',border:'1px solid rgba(168,85,247,0.3)'}}>
                <div style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.75rem'}}>
                  <Icon name="brain" size={16} style={{color:'#a855f7'}} />
                  <span style={{fontSize:'0.8rem',fontWeight:'600',color:'#fff'}}>LLM Tool Integration</span>
                </div>
                <pre style={{
                  background:'#020617',borderRadius:'0.375rem',padding:'0.75rem',margin:0,
                  fontSize:'0.65rem',fontFamily:'monospace',color:'#e2e8f0',
                  overflow:'auto',maxHeight:'150px'
                }}>
{`# OpenAI Function Calling / Claude Tool Use
{
  "name": "artemis_city_${activeEndpoint.replace('-', '_')}",
  "description": "${currentEndpoint.description}",
  "parameters": {
    "type": "object",
    "properties": {
${currentEndpoint.params.map(p => `      "${p}": { "type": "string", "description": "${p} parameter" }`).join(',\n')}
    },
    "required": [${currentEndpoint.params.map(p => `"${p}"`).join(', ')}]
  }
}`}
                </pre>
              </div>
            </div>
          </GlowCard>
        </div>
      );
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // Setup Guide - Installation & Configuration
    // ═══════════════════════════════════════════════════════════════════════════

    const SetupGuide = () => {
      const [activeStep, setActiveStep] = useState('prerequisites');
      const [verifyStatus, setVerifyStatus] = useState({
        mcp: null,
        vault: null,
        env: null,
        python: null
      });

      const steps = [
        { id: 'prerequisites', label: 'Prerequisites', icon: 'package' },
        { id: 'secrets', label: 'Setup Secrets', icon: 'shield' },
        { id: 'verify', label: 'Verify Setup', icon: 'checkCircle' },
        { id: 'quickstart', label: 'Quick Start', icon: 'play' }
      ];

      const runVerification = () => {
        // Simulate verification checks
        setVerifyStatus({ mcp: 'checking', vault: 'checking', env: 'checking', python: 'checking' });

        setTimeout(() => setVerifyStatus(prev => ({ ...prev, env: 'pass' })), 500);
        setTimeout(() => setVerifyStatus(prev => ({ ...prev, python: 'pass' })), 1000);
        setTimeout(() => setVerifyStatus(prev => ({ ...prev, mcp: 'pass' })), 1500);
        setTimeout(() => setVerifyStatus(prev => ({ ...prev, vault: 'warn' })), 2000);
      };

      const statusIcon = (status) => {
        if (status === 'checking') return <div style={{width:'12px',height:'12px',border:'2px solid #fbbf24',borderTopColor:'transparent',borderRadius:'50%',animation:'spin 1s linear infinite'}} />;
        if (status === 'pass') return <Icon name="checkCircle" size={16} style={{color:'#22c55e'}} />;
        if (status === 'fail') return <Icon name="alertTriangle" size={16} style={{color:'#ef4444'}} />;
        if (status === 'warn') return <Icon name="alertTriangle" size={16} style={{color:'#fbbf24'}} />;
        return <div style={{width:'12px',height:'12px',borderRadius:'50%',background:'#475569'}} />;
      };

      return (
        <div style={{display:'grid',gap:'1.5rem'}}>
          {/* Header */}
          <GlowCard glowColor="green" style={{padding:'1.5rem'}}>
            <div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginBottom:'1rem'}}>
              <div style={{padding:'0.625rem',borderRadius:'0.5rem',background:'linear-gradient(135deg, rgba(34,197,94,0.2), rgba(34,211,238,0.2))'}}>
                <Icon name="settings" size={24} style={{color:'#22c55e'}} />
              </div>
              <div>
                <h2 style={{fontSize:'1.25rem',fontWeight:'600',color:'#fff',margin:0}}>Setup Guide</h2>
                <p style={{fontSize:'0.8rem',color:'#64748b',margin:0}}>Configure Artemis City for development or production</p>
              </div>
            </div>

            {/* Step Tabs */}
            <div style={{display:'flex',gap:'0.5rem',flexWrap:'wrap'}}>
              {steps.map((step, i) => (
                <button
                  key={step.id}
                  onClick={() => setActiveStep(step.id)}
                  style={{
                    display:'flex',alignItems:'center',gap:'0.375rem',
                    padding:'0.5rem 0.875rem',borderRadius:'0.375rem',
                    fontSize:'0.75rem',fontFamily:'monospace',
                    background: activeStep === step.id ? 'linear-gradient(135deg, #22c55e, #16a34a)' : 'rgba(30,41,59,0.5)',
                    color: activeStep === step.id ? '#fff' : '#94a3b8',
                    border: activeStep === step.id ? 'none' : '1px solid rgba(51,65,85,0.5)',
                    cursor:'pointer',transition:'all 0.2s'
                  }}
                >
                  <span style={{fontSize:'0.65rem',color: activeStep === step.id ? '#fff' : '#64748b',marginRight:'0.25rem'}}>{i + 1}.</span>
                  <Icon name={step.icon} size={14} />
                  {step.label}
                </button>
              ))}
            </div>
          </GlowCard>

          {/* Prerequisites */}
          {activeStep === 'prerequisites' && (
            <div style={{display:'grid',gap:'1.5rem',gridTemplateColumns:'repeat(auto-fit, minmax(300px, 1fr))'}}>
              <GlowCard glowColor="cyan" style={{padding:'1.25rem'}}>
                <h3 style={{fontSize:'0.85rem',fontFamily:'monospace',color:'#22d3ee',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                  <Icon name="package" size={14} style={{marginRight:'0.5rem',verticalAlign:'middle'}} />
                  Required Software
                </h3>
                <div style={{display:'grid',gap:'0.625rem'}}>
                  {[
                    { name: 'Python 3.10+', desc: 'Core runtime for Artemis agents', cmd: 'python3 --version' },
                    { name: 'Node.js 18+', desc: 'MCP Server runtime', cmd: 'node --version' },
                    { name: 'Obsidian', desc: 'Knowledge base application', cmd: 'Open Obsidian app' },
                    { name: 'Local REST API Plugin', desc: 'Obsidian plugin for API access', cmd: 'Settings → Community Plugins' },
                    { name: 'Git', desc: 'Version control', cmd: 'git --version' }
                  ].map((req, i) => (
                    <div key={i} style={{padding:'0.75rem',background:'rgba(30,41,59,0.5)',borderRadius:'0.375rem',borderLeft:'3px solid #22d3ee'}}>
                      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.25rem'}}>
                        <span style={{fontSize:'0.8rem',color:'#fff',fontWeight:500}}>{req.name}</span>
                      </div>
                      <div style={{fontSize:'0.65rem',color:'#64748b',marginBottom:'0.375rem'}}>{req.desc}</div>
                      <code style={{fontSize:'0.6rem',color:'#94a3b8',background:'rgba(0,0,0,0.3)',padding:'0.125rem 0.375rem',borderRadius:'0.25rem'}}>{req.cmd}</code>
                    </div>
                  ))}
                </div>
              </GlowCard>

              <GlowCard glowColor="purple" style={{padding:'1.25rem'}}>
                <h3 style={{fontSize:'0.85rem',fontFamily:'monospace',color:'#a855f7',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                  <Icon name="archive" size={14} style={{marginRight:'0.5rem',verticalAlign:'middle'}} />
                  Project Structure
                </h3>
                <pre style={{background:'#020617',borderRadius:'0.375rem',padding:'0.75rem',margin:0,fontSize:'0.6rem',fontFamily:'monospace',color:'#94a3b8',overflow:'auto'}}>
{`Artemis-City/
├── .env                    # Root environment (generated)
├── setup_secrets.sh        # Security setup script
├── verify_setup.sh         # Verification script
├── pyproject.toml          # Python project config
│
├── MCP/
│   └── src/
│       └── integration/
│           └── memory_bus.py   # Memory Bus module
│
├── app/
│   └── Artemis Agentic Memory Layer/
│       ├── .env            # MCP Server config (generated)
│       ├── package.json
│       └── src/
│           └── index.ts    # MCP Server entry
│
├── agents/
│   ├── artemis.py          # Mayor agent
│   ├── packrat.py          # Postmaster agent
│   └── copilot.py          # Assistant agent
│
└── docs/
    ├── MEMORY_INTEGRATION.md
    └── LIVING_CITY.md`}
                </pre>
              </GlowCard>
            </div>
          )}

          {/* Setup Secrets */}
          {activeStep === 'secrets' && (
            <div style={{display:'grid',gap:'1.5rem'}}>
              <GlowCard glowColor="amber" style={{padding:'1.25rem'}}>
                <h3 style={{fontSize:'0.85rem',fontFamily:'monospace',color:'#fbbf24',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                  <Icon name="shield" size={14} style={{marginRight:'0.5rem',verticalAlign:'middle'}} />
                  setup_secrets.sh
                </h3>
                <p style={{fontSize:'0.75rem',color:'#94a3b8',marginBottom:'1rem'}}>
                  This script generates secure <code style={{color:'#fbbf24'}}>.env</code> files with random API keys. Run it once to configure your environment.
                </p>
                <pre style={{background:'#020617',borderRadius:'0.375rem',padding:'1rem',margin:'0 0 1rem',fontSize:'0.65rem',fontFamily:'monospace',color:'#e2e8f0',overflow:'auto',maxHeight:'300px'}}>
{`#!/bin/bash
# Artemis City - Secure Environment Setup

# Navigate to project root
cd /path/to/Artemis-City

# Make executable (first time only)
chmod +x setup_secrets.sh

# Run the setup
./setup_secrets.sh

# Expected output:
# ============================================
#   🏛️  ARTEMIS CITY - SECRETS SETUP  🏛️
# ============================================
#
# Step 1: Generating secure API keys...
# ✓ MCP API Key generated
#
# Step 2: Creating root .env file...
# ✓ Root .env created with secure permissions (600)
#
# Step 3: Creating Memory Layer .env file...
# ✓ Memory Layer .env created
#
# Step 4: Verifying .gitignore protection...
# ✓ .env already protected in .gitignore
#
# ============================================
#   ✓ SETUP COMPLETE!
# ============================================`}
                </pre>

                <div style={{padding:'0.75rem',background:'rgba(239,68,68,0.1)',borderRadius:'0.375rem',border:'1px solid rgba(239,68,68,0.3)'}}>
                  <div style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.5rem'}}>
                    <Icon name="alertTriangle" size={14} style={{color:'#ef4444'}} />
                    <span style={{fontSize:'0.75rem',fontWeight:600,color:'#ef4444'}}>Security Warning</span>
                  </div>
                  <ul style={{margin:0,paddingLeft:'1.25rem',fontSize:'0.7rem',color:'#f87171'}}>
                    <li>NEVER commit .env files to git</li>
                    <li>NEVER share your API keys</li>
                    <li>Rotate keys immediately if exposed</li>
                    <li>Files are created with 600 permissions (owner only)</li>
                  </ul>
                </div>
              </GlowCard>

              <div style={{display:'grid',gap:'1.5rem',gridTemplateColumns:'repeat(auto-fit, minmax(280px, 1fr))'}}>
                <GlowCard glowColor="cyan" style={{padding:'1.25rem'}}>
                  <h3 style={{fontSize:'0.85rem',fontFamily:'monospace',color:'#22d3ee',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                    Root .env (Generated)
                  </h3>
                  <pre style={{background:'#020617',borderRadius:'0.375rem',padding:'0.75rem',margin:0,fontSize:'0.6rem',fontFamily:'monospace',color:'#e2e8f0',overflow:'auto'}}>
{`# ARTEMIS CITY - ENVIRONMENT
# Generated by setup_secrets.sh

# MCP Server
MCP_BASE_URL=http://localhost:3000
MCP_API_KEY=<auto-generated-64-char-hex>

# Obsidian (manual setup required)
OBSIDIAN_BASE_URL=http://localhost:27124
OBSIDIAN_API_KEY=<your_obsidian_api_key>

# Optional
PORT=3000
MCP_LOG_LEVEL=INFO`}
                  </pre>
                </GlowCard>

                <GlowCard glowColor="purple" style={{padding:'1.25rem'}}>
                  <h3 style={{fontSize:'0.85rem',fontFamily:'monospace',color:'#a855f7',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                    Get Obsidian API Key
                  </h3>
                  <div style={{display:'grid',gap:'0.5rem'}}>
                    {[
                      { step: 1, text: 'Open Obsidian application' },
                      { step: 2, text: 'Go to Settings (gear icon)' },
                      { step: 3, text: 'Navigate to Community Plugins' },
                      { step: 4, text: 'Find "Local REST API" plugin' },
                      { step: 5, text: 'Enable the plugin if disabled' },
                      { step: 6, text: 'Click "Copy API Key" button' },
                      { step: 7, text: 'Paste into .env files' }
                    ].map((item) => (
                      <div key={item.step} style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.5rem',background:'rgba(30,41,59,0.5)',borderRadius:'0.25rem'}}>
                        <span style={{width:'20px',height:'20px',borderRadius:'50%',background:'rgba(168,85,247,0.2)',color:'#a855f7',fontSize:'0.65rem',display:'flex',alignItems:'center',justifyContent:'center',fontWeight:600}}>{item.step}</span>
                        <span style={{fontSize:'0.7rem',color:'#e2e8f0'}}>{item.text}</span>
                      </div>
                    ))}
                  </div>
                </GlowCard>
              </div>
            </div>
          )}

          {/* Verify Setup */}
          {activeStep === 'verify' && (
            <div style={{display:'grid',gap:'1.5rem',gridTemplateColumns:'repeat(auto-fit, minmax(300px, 1fr))'}}>
              <GlowCard glowColor="cyan" style={{padding:'1.25rem'}}>
                <h3 style={{fontSize:'0.85rem',fontFamily:'monospace',color:'#22d3ee',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                  <Icon name="terminal" size={14} style={{marginRight:'0.5rem',verticalAlign:'middle'}} />
                  verify_setup.sh
                </h3>
                <p style={{fontSize:'0.75rem',color:'#94a3b8',marginBottom:'1rem'}}>
                  Run the verification script to check all components are configured correctly.
                </p>
                <pre style={{background:'#020617',borderRadius:'0.375rem',padding:'0.75rem',margin:'0 0 1rem',fontSize:'0.6rem',fontFamily:'monospace',color:'#e2e8f0',overflow:'auto'}}>
{`# Make executable and run
chmod +x verify_setup.sh
./verify_setup.sh

# Or run directly
bash verify_setup.sh`}
                </pre>

                <button
                  onClick={runVerification}
                  style={{
                    width:'100%',padding:'0.75rem',borderRadius:'0.375rem',
                    background:'linear-gradient(135deg, #22d3ee, #06b6d4)',
                    color:'#020617',fontWeight:600,fontSize:'0.8rem',
                    border:'none',cursor:'pointer',display:'flex',
                    alignItems:'center',justifyContent:'center',gap:'0.5rem'
                  }}
                >
                  <Icon name="play" size={16} />
                  Simulate Verification
                </button>
              </GlowCard>

              <GlowCard glowColor="green" style={{padding:'1.25rem'}}>
                <h3 style={{fontSize:'0.85rem',fontFamily:'monospace',color:'#22c55e',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                  <Icon name="checkCircle" size={14} style={{marginRight:'0.5rem',verticalAlign:'middle'}} />
                  Verification Status
                </h3>
                <div style={{display:'grid',gap:'0.625rem'}}>
                  {[
                    { key: 'env', label: 'Environment Files', desc: '.env files exist and have correct permissions' },
                    { key: 'python', label: 'Python Environment', desc: 'Python 3.10+ with required packages' },
                    { key: 'mcp', label: 'MCP Server', desc: 'Server running on localhost:3000' },
                    { key: 'vault', label: 'Obsidian Vault', desc: 'Local REST API accessible' }
                  ].map((check) => (
                    <div key={check.key} style={{display:'flex',alignItems:'center',gap:'0.75rem',padding:'0.75rem',background:'rgba(30,41,59,0.5)',borderRadius:'0.375rem'}}>
                      {statusIcon(verifyStatus[check.key])}
                      <div style={{flex:1}}>
                        <div style={{fontSize:'0.75rem',color:'#fff',fontWeight:500}}>{check.label}</div>
                        <div style={{fontSize:'0.6rem',color:'#64748b'}}>{check.desc}</div>
                      </div>
                      <span style={{fontSize:'0.6rem',fontFamily:'monospace',color: verifyStatus[check.key] === 'pass' ? '#22c55e' : verifyStatus[check.key] === 'warn' ? '#fbbf24' : verifyStatus[check.key] === 'fail' ? '#ef4444' : '#64748b'}}>
                        {verifyStatus[check.key] === 'pass' ? 'PASS' : verifyStatus[check.key] === 'warn' ? 'WARN' : verifyStatus[check.key] === 'fail' ? 'FAIL' : verifyStatus[check.key] === 'checking' ? '...' : '—'}
                      </span>
                    </div>
                  ))}
                </div>

                {verifyStatus.vault === 'warn' && (
                  <div style={{marginTop:'1rem',padding:'0.75rem',background:'rgba(251,191,36,0.1)',borderRadius:'0.375rem',border:'1px solid rgba(251,191,36,0.3)'}}>
                    <div style={{fontSize:'0.7rem',color:'#fbbf24',fontWeight:600,marginBottom:'0.375rem'}}>Warning: Vault Connection</div>
                    <div style={{fontSize:'0.65rem',color:'#94a3b8'}}>
                      Obsidian may not be running or Local REST API plugin is disabled. Check that Obsidian is open and the plugin is enabled.
                    </div>
                  </div>
                )}
              </GlowCard>
            </div>
          )}

          {/* Quick Start */}
          {activeStep === 'quickstart' && (
            <div style={{display:'grid',gap:'1.5rem'}}>
              <GlowCard glowColor="purple" style={{padding:'1.25rem'}}>
                <h3 style={{fontSize:'0.85rem',fontFamily:'monospace',color:'#a855f7',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                  <Icon name="play" size={14} style={{marginRight:'0.5rem',verticalAlign:'middle'}} />
                  Quick Start Commands
                </h3>
                <div style={{display:'grid',gap:'1rem'}}>
                  {[
                    { step: '1. Clone & Setup', cmd: 'git clone <repo> && cd Artemis-City && ./setup_secrets.sh' },
                    { step: '2. Install Dependencies', cmd: 'pip install -e . && cd "app/Artemis Agentic Memory Layer" && npm install' },
                    { step: '3. Configure Obsidian', cmd: '# Open Obsidian → Settings → Local REST API → Copy API Key → Paste in .env' },
                    { step: '4. Start MCP Server', cmd: 'cd "app/Artemis Agentic Memory Layer" && npm run dev' },
                    { step: '5. Verify Setup', cmd: './verify_setup.sh' },
                    { step: '6. Run Artemis', cmd: 'python -m agents.artemis' }
                  ].map((item, i) => (
                    <div key={i} style={{padding:'0.75rem',background:'rgba(30,41,59,0.5)',borderRadius:'0.375rem',borderLeft:'3px solid #a855f7'}}>
                      <div style={{fontSize:'0.75rem',color:'#a855f7',fontWeight:600,marginBottom:'0.375rem'}}>{item.step}</div>
                      <pre style={{margin:0,fontSize:'0.65rem',fontFamily:'monospace',color:'#e2e8f0',whiteSpace:'pre-wrap'}}>{item.cmd}</pre>
                    </div>
                  ))}
                </div>
              </GlowCard>

              <div style={{display:'grid',gap:'1.5rem',gridTemplateColumns:'repeat(auto-fit, minmax(280px, 1fr))'}}>
                <GlowCard glowColor="cyan" style={{padding:'1.25rem'}}>
                  <h3 style={{fontSize:'0.85rem',fontFamily:'monospace',color:'#22d3ee',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                    <Icon name="terminal" size={14} style={{marginRight:'0.5rem',verticalAlign:'middle'}} />
                    Test Memory Bus
                  </h3>
                  <pre style={{background:'#020617',borderRadius:'0.375rem',padding:'0.75rem',margin:0,fontSize:'0.6rem',fontFamily:'monospace',color:'#e2e8f0',overflow:'auto'}}>
{`# Python test
python -c "
from MCP.src.integration import get_memory_bus

bus = get_memory_bus()
health = bus.check_health()
print(f'MCP: {\"✓\" if health.success else \"✗\"}')

report = bus.get_trust_report()
print(f'Agents: {report[\"total_entities\"]}')
"

# Expected output:
# MCP: ✓
# Agents: 4`}
                  </pre>
                </GlowCard>

                <GlowCard glowColor="green" style={{padding:'1.25rem'}}>
                  <h3 style={{fontSize:'0.85rem',fontFamily:'monospace',color:'#22c55e',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                    <Icon name="helpCircle" size={14} style={{marginRight:'0.5rem',verticalAlign:'middle'}} />
                    Troubleshooting
                  </h3>
                  <div style={{display:'grid',gap:'0.5rem'}}>
                    {[
                      { issue: 'Connection refused', fix: 'Start MCP server: npm run dev' },
                      { issue: 'HTTP 401', fix: 'Check MCP_API_KEY matches in both .env files' },
                      { issue: 'Vault not found', fix: 'Open Obsidian, enable Local REST API plugin' },
                      { issue: 'Permission denied', fix: 'Run: chmod +x setup_secrets.sh' },
                      { issue: 'Module not found', fix: 'Run: pip install -e .' }
                    ].map((item, i) => (
                      <div key={i} style={{padding:'0.5rem',background:'rgba(30,41,59,0.5)',borderRadius:'0.25rem',fontSize:'0.65rem'}}>
                        <span style={{color:'#ef4444'}}>{item.issue}</span>
                        <span style={{color:'#64748b'}}> → </span>
                        <span style={{color:'#22c55e'}}>{item.fix}</span>
                      </div>
                    ))}
                  </div>
                </GlowCard>
              </div>
            </div>
          )}
        </div>
      );
    };

    // =========================================================================
    // Agent Registry Section
    // =========================================================================
    const AgentRegistrySection = () => {
      const [activePanel, setActivePanel] = useState('registry');
      const [selectedAgent, setSelectedAgent] = useState(null);
      const [newAgent, setNewAgent] = useState({
        name: '',
        semanticRole: '',
        accessScope: 'Read-only',
        energySignature: 'Low-compute',
        linkedProtocols: [],
        driftCountermeasures: '',
        trustThresholds: ''
      });

      // Pre-defined Artemis City agents
      const agents = [
        {
          id: 'artemis',
          name: 'Artemis',
          version: 'v1.0',
          semanticRole: 'Mayor protocol, governance. Primary orchestrator and context integrator.',
          accessScope: 'Full access to all communication channels, agent coordination, and system governance',
          energySignature: 'Moderate-compute, continuous monitoring of city state',
          linkedProtocols: ['ATP (Artemis Transmission Protocol)', 'Trust Decay Model', 'Hebbian Learning'],
          driftCountermeasures: 'Regular semantic alignment checks, purpose validation on each routing decision',
          trustThresholds: 'Trust level review on: failed routing decisions, permission violations, anomalous behavior patterns',
          trustLevel: 0.95,
          status: 'active',
          color: '#00ffcc'
        },
        {
          id: 'packrat',
          name: 'Pack Rat',
          version: 'v1.0',
          semanticRole: 'Postmaster role, safe courier. Memory interface and context delivery.',
          accessScope: 'Read/Write access to Obsidian vault, memory operations, context retrieval',
          energySignature: 'Low-compute, event-driven on memory requests',
          linkedProtocols: ['Memory Bus Protocol', 'MCP Operations', 'Trust Interface'],
          driftCountermeasures: 'Audit trail logging, content validation before delivery',
          trustThresholds: 'Review on: memory corruption detected, unauthorized access attempts, delivery failures',
          trustLevel: 0.85,
          status: 'active',
          color: '#a855f7'
        },
        {
          id: 'copilot',
          name: 'Copilot',
          version: 'v1.0',
          semanticRole: 'Assistant role, elastic augmentation. User-facing interaction and task execution.',
          accessScope: 'Read access to context, write access to user outputs, tool execution',
          energySignature: 'High-compute on-demand, scales with user requests',
          linkedProtocols: ['ATP', 'LLM API Protocol', 'Cost Optimization'],
          driftCountermeasures: 'Output validation, user feedback integration, periodic role alignment',
          trustThresholds: 'Review on: repeated user corrections, scope boundary violations, cost threshold exceeded',
          trustLevel: 0.80,
          status: 'active',
          color: '#22d3ee'
        },
        {
          id: 'daemon',
          name: 'Daemon',
          version: 'v1.0',
          semanticRole: 'City Manager, system anchor. Background operations and maintenance.',
          accessScope: 'System-level access for maintenance, logging, health monitoring',
          energySignature: 'Low-compute, continuous background operations',
          linkedProtocols: ['Health Check Protocol', 'Logging System', 'Auto-recovery'],
          driftCountermeasures: 'Strict operation boundaries, automated rollback on anomalies',
          trustThresholds: 'Review on: system resource abuse, unauthorized file modifications, health check failures',
          trustLevel: 0.85,
          status: 'active',
          color: '#fbbf24'
        }
      ];

      const getTrustColor = (level) => {
        if (level >= 0.9) return '#00ffcc';
        if (level >= 0.7) return '#22d3ee';
        if (level >= 0.5) return '#fbbf24';
        if (level >= 0.3) return '#fb923c';
        return '#ef4444';
      };

      const panels = [
        { id: 'registry', label: 'Agent Registry', icon: 'users' },
        { id: 'template', label: 'Agent Template', icon: 'clipboard' },
        { id: 'builder', label: 'Create Agent', icon: 'sparkles' },
        { id: 'protocol', label: 'ATP Protocol', icon: 'fileText' }
      ];

      return (
        <div>
          <GlowCard glowColor="purple">
            <div style={{display:'flex',alignItems:'center',gap:'1rem',marginBottom:'1.5rem'}}>
              <Icon name="userCircle" size={32} style={{color:'#a855f7'}} />
              <div>
                <h2 style={{margin:0,fontSize:'1.25rem',fontFamily:'monospace',color:'#f8fafc'}}>
                  Agent Registry & Templates
                </h2>
                <p style={{margin:'0.25rem 0 0',fontSize:'0.75rem',color:'#64748b'}}>
                  Define, manage, and document Artemis City agents
                </p>
              </div>
            </div>

            {/* Sub-navigation */}
            <div style={{display:'flex',gap:'0.5rem',marginBottom:'1.5rem',flexWrap:'wrap'}}>
              {panels.map(panel => (
                <button key={panel.id} onClick={() => setActivePanel(panel.id)} style={{
                  display:'flex',alignItems:'center',gap:'0.375rem',
                  padding:'0.375rem 0.75rem',borderRadius:'0.375rem',
                  fontSize:'0.7rem',fontFamily:'monospace',
                  background: activePanel === panel.id ? 'rgba(168,85,247,0.2)' : 'rgba(30,41,59,0.5)',
                  color: activePanel === panel.id ? '#a855f7' : '#94a3b8',
                  border: activePanel === panel.id ? '1px solid rgba(168,85,247,0.5)' : '1px solid rgba(51,65,85,0.5)',
                  cursor:'pointer',transition:'all 0.2s'
                }}>
                  <Icon name={panel.icon} size={12} />
                  {panel.label}
                </button>
              ))}
            </div>

            {/* Agent Registry Panel */}
            {activePanel === 'registry' && (
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem'}}>
                {/* Agent Cards */}
                <div style={{display:'flex',flexDirection:'column',gap:'0.75rem'}}>
                  <h3 style={{fontSize:'0.8rem',fontFamily:'monospace',color:'#94a3b8',margin:'0 0 0.5rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                    Active Citizens ({agents.length})
                  </h3>
                  {agents.map(agent => (
                    <div key={agent.id} onClick={() => setSelectedAgent(agent)} style={{
                      padding:'0.875rem',borderRadius:'0.5rem',cursor:'pointer',
                      background: selectedAgent?.id === agent.id ? 'rgba(168,85,247,0.15)' : 'rgba(30,41,59,0.5)',
                      border: selectedAgent?.id === agent.id ? `1px solid ${agent.color}` : '1px solid rgba(51,65,85,0.5)',
                      transition:'all 0.2s'
                    }}>
                      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.5rem'}}>
                        <div style={{display:'flex',alignItems:'center',gap:'0.5rem'}}>
                          <div style={{width:'8px',height:'8px',borderRadius:'50%',background:agent.color,boxShadow:`0 0 8px ${agent.color}`}} />
                          <span style={{fontSize:'0.85rem',fontFamily:'monospace',color:'#f8fafc',fontWeight:'bold'}}>{agent.name}</span>
                          <span style={{fontSize:'0.6rem',padding:'0.125rem 0.375rem',background:'rgba(100,116,139,0.3)',borderRadius:'0.25rem',color:'#94a3b8'}}>{agent.version}</span>
                        </div>
                        <div style={{display:'flex',alignItems:'center',gap:'0.375rem'}}>
                          <div style={{width:'6px',height:'6px',borderRadius:'50%',background:getTrustColor(agent.trustLevel)}} />
                          <span style={{fontSize:'0.65rem',color:getTrustColor(agent.trustLevel)}}>{Math.round(agent.trustLevel * 100)}%</span>
                        </div>
                      </div>
                      <p style={{margin:0,fontSize:'0.65rem',color:'#64748b',lineHeight:1.4}}>{agent.semanticRole.split('.')[0]}</p>
                    </div>
                  ))}
                </div>

                {/* Agent Detail Panel */}
                <div>
                  {selectedAgent ? (
                    <GlowCard glowColor={selectedAgent.color === '#00ffcc' ? 'cyan' : selectedAgent.color === '#a855f7' ? 'purple' : selectedAgent.color === '#fbbf24' ? 'amber' : 'cyan'} style={{padding:'1rem'}}>
                      <div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginBottom:'1rem'}}>
                        <div style={{width:'40px',height:'40px',borderRadius:'50%',background:`${selectedAgent.color}22`,border:`2px solid ${selectedAgent.color}`,display:'flex',alignItems:'center',justifyContent:'center'}}>
                          <Icon name="user" size={20} style={{color:selectedAgent.color}} />
                        </div>
                        <div>
                          <h3 style={{margin:0,fontSize:'1rem',fontFamily:'monospace',color:selectedAgent.color}}>{selectedAgent.name}</h3>
                          <span style={{fontSize:'0.65rem',color:'#64748b'}}>{selectedAgent.version} • Trust: {Math.round(selectedAgent.trustLevel * 100)}%</span>
                        </div>
                      </div>

                      <div style={{display:'grid',gap:'0.75rem',fontSize:'0.65rem'}}>
                        <div>
                          <span style={{color:'#64748b',textTransform:'uppercase',letterSpacing:'0.05em'}}>Semantic Role</span>
                          <p style={{margin:'0.25rem 0 0',color:'#e2e8f0'}}>{selectedAgent.semanticRole}</p>
                        </div>
                        <div>
                          <span style={{color:'#64748b',textTransform:'uppercase',letterSpacing:'0.05em'}}>Access Scope</span>
                          <p style={{margin:'0.25rem 0 0',color:'#e2e8f0'}}>{selectedAgent.accessScope}</p>
                        </div>
                        <div>
                          <span style={{color:'#64748b',textTransform:'uppercase',letterSpacing:'0.05em'}}>Energy Signature</span>
                          <p style={{margin:'0.25rem 0 0',color:'#e2e8f0'}}>{selectedAgent.energySignature}</p>
                        </div>
                        <div>
                          <span style={{color:'#64748b',textTransform:'uppercase',letterSpacing:'0.05em'}}>Linked Protocols</span>
                          <div style={{display:'flex',flexWrap:'wrap',gap:'0.375rem',marginTop:'0.25rem'}}>
                            {selectedAgent.linkedProtocols.map((p, i) => (
                              <span key={i} style={{padding:'0.25rem 0.5rem',background:'rgba(168,85,247,0.2)',borderRadius:'0.25rem',color:'#a855f7',fontSize:'0.6rem'}}>{p}</span>
                            ))}
                          </div>
                        </div>
                        <div>
                          <span style={{color:'#64748b',textTransform:'uppercase',letterSpacing:'0.05em'}}>Drift Countermeasures</span>
                          <p style={{margin:'0.25rem 0 0',color:'#e2e8f0'}}>{selectedAgent.driftCountermeasures}</p>
                        </div>
                        <div>
                          <span style={{color:'#64748b',textTransform:'uppercase',letterSpacing:'0.05em'}}>Trust Threshold Triggers</span>
                          <p style={{margin:'0.25rem 0 0',color:'#e2e8f0'}}>{selectedAgent.trustThresholds}</p>
                        </div>
                      </div>
                    </GlowCard>
                  ) : (
                    <div style={{display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',height:'100%',padding:'2rem',textAlign:'center',color:'#475569'}}>
                      <Icon name="user" size={48} style={{opacity:0.3,marginBottom:'1rem'}} />
                      <p style={{margin:0,fontSize:'0.75rem'}}>Select an agent to view details</p>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Agent Template Panel */}
            {activePanel === 'template' && (
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem'}}>
                <GlowCard glowColor="cyan" style={{padding:'1rem'}}>
                  <h3 style={{fontSize:'0.8rem',fontFamily:'monospace',color:'#22d3ee',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                    <Icon name="clipboard" size={14} style={{marginRight:'0.5rem',verticalAlign:'middle'}} />
                    Agent Card Template
                  </h3>
                  <pre style={{background:'#020617',borderRadius:'0.375rem',padding:'0.75rem',margin:0,fontSize:'0.55rem',fontFamily:'monospace',color:'#e2e8f0',overflow:'auto',maxHeight:'400px'}}>
{`# Agent Template

**Agent Name:** [Unique identifier]

**System Access Scope:** [Boundaries of access
to system resources, data, and other agents]

**Semantic Role:** [Primary function and
purpose within the Codex]

**Energy Signature:** [Computational/resource
footprint - Low/Moderate/High-compute]

**Linked Protocols:** [Communication, data
handling, operational protocols]

**Drift Countermeasures:** [Mechanisms to
prevent deviation from intended role]

**Trust Threshold Triggers:** [Conditions that
initiate trust re-evaluation]

---

## Why Agent Cards Matter

✓ Memory: Know what each agent was
  originally supposed to do

✓ Modularity: Swap/rebuild agents without
  breaking the system

✓ Security: Clear boundaries on what an
  agent can and can't do

✓ Version Control: Track changes over time

✓ Futureproofing: Remember what you built
  and why`}
                  </pre>
                </GlowCard>

                <GlowCard glowColor="green" style={{padding:'1rem'}}>
                  <h3 style={{fontSize:'0.8rem',fontFamily:'monospace',color:'#22c55e',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                    <Icon name="sparkles" size={14} style={{marginRight:'0.5rem',verticalAlign:'middle'}} />
                    Prompt Template
                  </h3>
                  <pre style={{background:'#020617',borderRadius:'0.375rem',padding:'0.75rem',margin:0,fontSize:'0.55rem',fontFamily:'monospace',color:'#e2e8f0',overflow:'auto',maxHeight:'400px'}}>
{`You are [ROLE NAME], part of [PROJECT NAME].

🧠 Role:
- You are [role description]
- You act [calmly/urgently/reflectively]

✅ Mission:
- You handle [specific task set]
- You do NOT [prohibited tasks]
- Your purpose is [core goal]

📋 Output Standards:
- Always respond in [format] format
- Be [succinct/verbose/bullet-pointed]
- Cite assumptions if any arise

🚨 Escalation Rules:
- If ambiguous: [ask clarifying questions]
- If outside scope: [flag and halt]

🧠 Memory Handling:
- Remember previous outputs
- Keep logs for reflection every [X] actions

✨ Reflection Trigger:
- After major outputs, summarize what was
  attempted and whether assumptions were
  necessary

---

Three Layers of Agent Design:

| Layer     | Meaning                    |
|-----------|----------------------------|
| Identity  | Who is this agent?         |
| Mission   | What tasks are allowed?    |
| Process   | How does it interact?      |`}
                  </pre>
                </GlowCard>
              </div>
            )}

            {/* Create Agent Panel */}
            {activePanel === 'builder' && (
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem'}}>
                <div style={{display:'flex',flexDirection:'column',gap:'0.75rem'}}>
                  <div>
                    <label style={{display:'block',fontSize:'0.65rem',fontFamily:'monospace',color:'#64748b',textTransform:'uppercase',marginBottom:'0.375rem'}}>Agent Name</label>
                    <input type="text" value={newAgent.name} onChange={e => setNewAgent({...newAgent, name: e.target.value})} placeholder="e.g., Sentinel" style={{
                      width:'100%',padding:'0.5rem',borderRadius:'0.375rem',
                      background:'rgba(30,41,59,0.5)',border:'1px solid rgba(51,65,85,0.5)',
                      color:'#f8fafc',fontSize:'0.75rem',fontFamily:'monospace'
                    }} />
                  </div>
                  <div>
                    <label style={{display:'block',fontSize:'0.65rem',fontFamily:'monospace',color:'#64748b',textTransform:'uppercase',marginBottom:'0.375rem'}}>Semantic Role</label>
                    <textarea value={newAgent.semanticRole} onChange={e => setNewAgent({...newAgent, semanticRole: e.target.value})} placeholder="Primary function and purpose..." rows={3} style={{
                      width:'100%',padding:'0.5rem',borderRadius:'0.375rem',
                      background:'rgba(30,41,59,0.5)',border:'1px solid rgba(51,65,85,0.5)',
                      color:'#f8fafc',fontSize:'0.75rem',fontFamily:'monospace',resize:'vertical'
                    }} />
                  </div>
                  <div>
                    <label style={{display:'block',fontSize:'0.65rem',fontFamily:'monospace',color:'#64748b',textTransform:'uppercase',marginBottom:'0.375rem'}}>Access Scope</label>
                    <select value={newAgent.accessScope} onChange={e => setNewAgent({...newAgent, accessScope: e.target.value})} style={{
                      width:'100%',padding:'0.5rem',borderRadius:'0.375rem',
                      background:'rgba(30,41,59,0.5)',border:'1px solid rgba(51,65,85,0.5)',
                      color:'#f8fafc',fontSize:'0.75rem',fontFamily:'monospace'
                    }}>
                      <option value="Read-only">Read-only access</option>
                      <option value="Read-Write">Read/Write access</option>
                      <option value="Full">Full system access</option>
                      <option value="Sandboxed">Sandboxed (isolated)</option>
                    </select>
                  </div>
                  <div>
                    <label style={{display:'block',fontSize:'0.65rem',fontFamily:'monospace',color:'#64748b',textTransform:'uppercase',marginBottom:'0.375rem'}}>Energy Signature</label>
                    <select value={newAgent.energySignature} onChange={e => setNewAgent({...newAgent, energySignature: e.target.value})} style={{
                      width:'100%',padding:'0.5rem',borderRadius:'0.375rem',
                      background:'rgba(30,41,59,0.5)',border:'1px solid rgba(51,65,85,0.5)',
                      color:'#f8fafc',fontSize:'0.75rem',fontFamily:'monospace'
                    }}>
                      <option value="Low-compute">Low-compute (event-driven)</option>
                      <option value="Moderate-compute">Moderate-compute (periodic)</option>
                      <option value="High-compute">High-compute (continuous)</option>
                      <option value="On-demand">On-demand (scales dynamically)</option>
                    </select>
                  </div>
                  <div>
                    <label style={{display:'block',fontSize:'0.65rem',fontFamily:'monospace',color:'#64748b',textTransform:'uppercase',marginBottom:'0.375rem'}}>Drift Countermeasures</label>
                    <textarea value={newAgent.driftCountermeasures} onChange={e => setNewAgent({...newAgent, driftCountermeasures: e.target.value})} placeholder="Mechanisms to prevent deviation..." rows={2} style={{
                      width:'100%',padding:'0.5rem',borderRadius:'0.375rem',
                      background:'rgba(30,41,59,0.5)',border:'1px solid rgba(51,65,85,0.5)',
                      color:'#f8fafc',fontSize:'0.75rem',fontFamily:'monospace',resize:'vertical'
                    }} />
                  </div>
                </div>

                {/* Preview */}
                <GlowCard glowColor="amber" style={{padding:'1rem'}}>
                  <h3 style={{fontSize:'0.8rem',fontFamily:'monospace',color:'#fbbf24',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                    <Icon name="fileText" size={14} style={{marginRight:'0.5rem',verticalAlign:'middle'}} />
                    Generated Agent Card
                  </h3>
                  <pre style={{background:'#020617',borderRadius:'0.375rem',padding:'0.75rem',margin:0,fontSize:'0.55rem',fontFamily:'monospace',color:'#e2e8f0',overflow:'auto',maxHeight:'350px'}}>
{`# Agent: ${newAgent.name || '[Name]'}

**Version:** v1.0
**Status:** Draft

---

## System Access Scope
${newAgent.accessScope || '[Not specified]'}

## Semantic Role
${newAgent.semanticRole || '[Not specified]'}

## Energy Signature
${newAgent.energySignature || '[Not specified]'}

## Linked Protocols
- ATP (Artemis Transmission Protocol)
- Trust Decay Model

## Drift Countermeasures
${newAgent.driftCountermeasures || '[Not specified]'}

## Trust Threshold Triggers
- Violation of system access scope
- Failure to adhere to linked protocols
- Request for elevated privileges

---
Created: ${new Date().toISOString().split('T')[0]}
Author: Artemis City Framework`}
                  </pre>
                  <button style={{
                    marginTop:'0.75rem',padding:'0.5rem 1rem',
                    background:'linear-gradient(90deg, rgba(251,191,36,0.3), rgba(251,191,36,0.1))',
                    border:'1px solid rgba(251,191,36,0.5)',borderRadius:'0.375rem',
                    color:'#fbbf24',fontSize:'0.7rem',fontFamily:'monospace',cursor:'pointer',
                    display:'flex',alignItems:'center',gap:'0.5rem'
                  }}>
                    <Icon name="send" size={14} />
                    Export Agent Card
                  </button>
                </GlowCard>
              </div>
            )}

            {/* ATP Protocol Panel */}
            {activePanel === 'protocol' && (
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem'}}>
                <GlowCard glowColor="cyan" style={{padding:'1rem'}}>
                  <h3 style={{fontSize:'0.8rem',fontFamily:'monospace',color:'#22d3ee',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                    <Icon name="send" size={14} style={{marginRight:'0.5rem',verticalAlign:'middle'}} />
                    ATP Core Signal Tags
                  </h3>
                  <div style={{display:'grid',gap:'0.5rem'}}>
                    {[
                      { tag: '#Mode:', meaning: 'Overall intent (Build, Review, Organize, Capture, Synthesize, Commit)', color: '#00ffcc' },
                      { tag: '#Context:', meaning: 'Brief mission goal or purpose for the action', color: '#22d3ee' },
                      { tag: '#Priority:', meaning: 'Urgency level (Critical, High, Normal, Low)', color: '#ef4444' },
                      { tag: '#ActionType:', meaning: 'Expected response (Summarize, Scaffold, Execute, Reflect)', color: '#a855f7' },
                      { tag: '#TargetZone:', meaning: 'Project/folder area this work applies to', color: '#fbbf24' },
                      { tag: '#SpecialNotes:', meaning: 'Unusual instructions, warnings, or exceptions', color: '#64748b' }
                    ].map((item, i) => (
                      <div key={i} style={{display:'flex',alignItems:'flex-start',gap:'0.5rem',padding:'0.5rem',background:'rgba(30,41,59,0.5)',borderRadius:'0.25rem'}}>
                        <code style={{color:item.color,fontSize:'0.65rem',flexShrink:0,fontWeight:'bold'}}>{item.tag}</code>
                        <span style={{fontSize:'0.6rem',color:'#94a3b8'}}>{item.meaning}</span>
                      </div>
                    ))}
                  </div>
                </GlowCard>

                <GlowCard glowColor="purple" style={{padding:'1rem'}}>
                  <h3 style={{fontSize:'0.8rem',fontFamily:'monospace',color:'#a855f7',margin:'0 0 1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>
                    <Icon name="terminal" size={14} style={{marginRight:'0.5rem',verticalAlign:'middle'}} />
                    ATP Example Entry
                  </h3>
                  <pre style={{background:'#020617',borderRadius:'0.375rem',padding:'0.75rem',margin:0,fontSize:'0.6rem',fontFamily:'monospace',color:'#e2e8f0',overflow:'auto'}}>
{`[[Mode]]: Build
[[Context]]: Initial Codex CLI Trigger Script
[[Priority]]: High
[[ActionType]]: Scaffold
[[TargetZone]]: /Projects/Codex_Experiments/
[[SpecialNotes]]: Must be Git-safe compatible

---

Building a Python trigger that allows
Codex to repackage files after a push.`}
                  </pre>
                  <div style={{marginTop:'1rem',padding:'0.75rem',background:'rgba(30,41,59,0.3)',borderRadius:'0.375rem',borderLeft:'3px solid #a855f7'}}>
                    <h4 style={{margin:'0 0 0.5rem',fontSize:'0.7rem',color:'#a855f7'}}>Interpretation Rules</h4>
                    <ul style={{margin:0,padding:'0 0 0 1rem',fontSize:'0.6rem',color:'#94a3b8',lineHeight:1.6}}>
                      <li><strong>Mode</strong> drives the behavior</li>
                      <li><strong>Context</strong> anchors purpose</li>
                      <li><strong>Priority</strong> guides response speed</li>
                      <li><strong>ActionType</strong> defines output format</li>
                      <li><strong>TargetZone</strong> ensures correct organization</li>
                    </ul>
                  </div>
                </GlowCard>
              </div>
            )}
          </GlowCard>
        </div>
      );
    };

    // Routing History Panel
    const RoutingHistory = ({ history, onReplay }) => {
      if (history.length === 0) return null;

      return (
        <div style={{
          position:'fixed',bottom:'1rem',left:'1rem',width:'280px',
          background:'rgba(15,23,42,0.95)',backdropFilter:'blur(12px)',
          border:'1px solid rgba(51,65,85,0.5)',borderRadius:'0.5rem',
          padding:'0.75rem',zIndex:100,maxHeight:'200px',overflow:'auto'
        }}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'0.5rem'}}>
            <span style={{fontSize:'0.7rem',fontFamily:'monospace',color:'#64748b',textTransform:'uppercase'}}>Routing History</span>
            <span style={{fontSize:'0.6rem',color:'#475569'}}>{history.length} routes</span>
          </div>
          {history.slice(-5).reverse().map((h, i) => (
            <div key={i} onClick={() => onReplay(h)} style={{
              padding:'0.5rem',marginBottom:'0.25rem',borderRadius:'0.25rem',
              background:'rgba(30,41,59,0.5)',cursor:'pointer',
              border:'1px solid transparent',transition:'all 0.2s'
            }}
            onMouseEnter={e => e.target.style.borderColor = 'rgba(34,211,238,0.3)'}
            onMouseLeave={e => e.target.style.borderColor = 'transparent'}
            >
              <div style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.25rem'}}>
                {/* Manual/Auto indicator */}
                <span style={{
                  fontSize:'0.5rem',padding:'0.125rem 0.25rem',borderRadius:'0.125rem',
                  background: h.isManual ? 'rgba(168,85,247,0.2)' : 'rgba(251,191,36,0.2)',
                  color: h.isManual ? '#a855f7' : '#fbbf24'
                }}>
                  {h.isManual ? 'M' : 'A'}
                </span>
                <span style={{fontSize:'0.65rem',color:AGENTS[h.primary]?.color || '#fff',fontWeight:600}}>{AGENTS[h.primary]?.name}</span>
                <span style={{fontSize:'0.5rem',color:'#475569'}}>→</span>
                <span style={{fontSize:'0.6rem',color:AGENTS[h.secondary]?.color || '#64748b'}}>{AGENTS[h.secondary]?.name}</span>
              </div>
              <div style={{fontSize:'0.55rem',color:'#64748b',whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}}>
                {h.context.substring(0, 40)}...
              </div>
            </div>
          ))}
        </div>
      );
    };

    // Stats Bar
    const StatsBar = ({ routingHistory, hebbianState, totalSavings, message }) => {
      const totalRoutes = routingHistory.length;
      const cachedRoutes = Math.floor(totalRoutes * 0.15);
      const avgStrength = Object.values(hebbianState.weights).reduce((a,b) => a+b, 0) / Object.keys(hebbianState.weights).length;
      const hasLiveContext = message?.context && message.context.length > 0;

      return (
        <div style={{
          display:'flex',gap:'1rem',justifyContent:'center',marginBottom:'1.5rem',flexWrap:'wrap',alignItems:'center'
        }}>
          {/* Cross-Panel Sync Indicator */}
          <div style={{
            display:'flex',alignItems:'center',gap:'0.5rem',
            padding:'0.375rem 0.75rem',borderRadius:'0.25rem',
            background: hasLiveContext ? 'rgba(0,255,136,0.1)' : 'rgba(100,116,139,0.1)',
            border: hasLiveContext ? '1px solid rgba(0,255,136,0.3)' : '1px solid rgba(100,116,139,0.2)'
          }}>
            <div style={{
              width:'6px',height:'6px',borderRadius:'50%',
              background: hasLiveContext ? '#00ff88' : '#64748b',
              animation: hasLiveContext ? 'pulse 2s infinite' : 'none'
            }} />
            <span style={{fontSize:'0.7rem',fontFamily:'monospace',color: hasLiveContext ? '#00ff88' : '#64748b'}}>
              {hasLiveContext ? 'All Panels Synced' : 'Awaiting Input'}
            </span>
          </div>
          <div style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.375rem 0.75rem',borderRadius:'0.25rem',background:'rgba(34,211,238,0.1)',border:'1px solid rgba(34,211,238,0.2)'}}>
            <Icon name="zap" size={14} style={{color:'#22d3ee'}} />
            <span style={{fontSize:'0.7rem',fontFamily:'monospace',color:'#22d3ee'}}>{totalRoutes} routes</span>
          </div>
          <div style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.375rem 0.75rem',borderRadius:'0.25rem',background:'rgba(168,85,247,0.1)',border:'1px solid rgba(168,85,247,0.2)'}}>
            <Icon name="brain" size={14} style={{color:'#a855f7'}} />
            <span style={{fontSize:'0.7rem',fontFamily:'monospace',color:'#a855f7'}}>{(avgStrength * 100).toFixed(0)}% avg strength</span>
          </div>
          <div style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.375rem 0.75rem',borderRadius:'0.25rem',background:'rgba(34,197,94,0.1)',border:'1px solid rgba(34,197,94,0.2)'}}>
            <Icon name="database" size={14} style={{color:'#22c55e'}} />
            <span style={{fontSize:'0.7rem',fontFamily:'monospace',color:'#22c55e'}}>{cachedRoutes} cached</span>
          </div>
          {totalSavings > 0 && (
            <div style={{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.375rem 0.75rem',borderRadius:'0.25rem',background:'rgba(251,191,36,0.1)',border:'1px solid rgba(251,191,36,0.2)'}}>
              <span style={{fontSize:'0.7rem',fontFamily:'monospace',color:'#fbbf24'}}>~${totalSavings.toFixed(2)} saved</span>
            </div>
          )}
        </div>
      );
    };

    // Main App
    function ATPPrototype() {
      const [activeTab, setActiveTab] = useState("city"); // Default to Living City view
      const [message, setMessage] = useState({
        mode: "Build",
        context: "",
        priority: "Normal",
        actionType: "Execute",
        targetZone: "",
        specialNotes: "",
        agentMode: "auto",      // "auto" = router decides, "manual" = user selects
        selectedAgent: null     // null for auto, or agent key like "copilot"
      });

      // Shared Hebbian state for cross-component learning
      const hebbianState = useHebbianWeights();

      // Routing history for demo
      const [routingHistory, setRoutingHistory] = useState([]);

      // Notifications
      const [toasts, setToasts] = useState([]);

      // Cost tracking
      const [totalSavings, setTotalSavings] = useState(0);

      const addToast = (message, type = 'info') => {
        const id = Date.now();
        setToasts(prev => [...prev, { id, message, type }]);
      };

      const removeToast = (id) => {
        setToasts(prev => prev.filter(t => t.id !== id));
      };

      const handleSend = (msg) => {
        addToast(`ATP Message sent: #${msg.mode} "${msg.context.substring(0, 30)}..."`, 'info');
        setActiveTab("routing");
      };

      // Callback when routing completes - strengthens Hebbian connections
      const handleRouteComplete = (primaryAgent, secondaryAgent, isManual = false) => {
        if (primaryAgent && secondaryAgent) {
          // Strengthen Hebbian connections (lower rate for manual to avoid gaming)
          hebbianState.hebbianUpdate(primaryAgent, secondaryAgent, isManual ? 0.05 : 0.1);

          // Add to history
          setRoutingHistory(prev => [...prev, {
            primary: primaryAgent,
            secondary: secondaryAgent,
            context: message.context,
            mode: message.mode,
            timestamp: Date.now(),
            isManual,
            hebbianUsed: isManual ? 0 : 0.3 // Track Hebbian influence
          }]);

          // Calculate savings (simplified: ~$0.02 per routed request vs $0.05 legacy)
          setTotalSavings(prev => prev + 0.03);

          // Show notifications
          const routeType = isManual ? 'Manual' : 'Auto';
          addToast(`${routeType} → ${AGENTS[primaryAgent].name}`, isManual ? 'info' : 'success');
          setTimeout(() => {
            const learnRate = isManual ? '+0.05' : '+0.1';
            addToast(`Hebbian: ${AGENTS[primaryAgent].name.split(' ')[0]}↔${AGENTS[secondaryAgent].name.split(' ')[0]} ${learnRate}`, 'hebbian');
          }, 500);
        }
      };

      // Replay a previous routing
      const handleReplay = (historyItem) => {
        setMessage(prev => ({
          ...prev,
          context: historyItem.context,
          mode: historyItem.mode
        }));
        setActiveTab("routing");
        addToast(`Replaying: "${historyItem.context.substring(0, 25)}..."`, 'info');
      };

      return (
        <div style={{minHeight:'100vh',position:'relative'}}>
          <style>{`
            @keyframes slideIn {
              from { transform: translateX(100%); opacity: 0; }
              to { transform: translateX(0); opacity: 1; }
            }
          `}</style>
          <CyberBackground />

          {/* Toast notifications */}
          <div style={{position:'fixed',top:'1rem',right:'1rem',zIndex:1000,display:'flex',flexDirection:'column',gap:'0.5rem'}}>
            {toasts.map(toast => (
              <Toast key={toast.id} message={toast.message} type={toast.type} onClose={() => removeToast(toast.id)} />
            ))}
          </div>

          {/* Routing history panel */}
          <RoutingHistory history={routingHistory} onReplay={handleReplay} />

          <div style={{position:'relative',zIndex:10,maxWidth:'72rem',margin:'0 auto',padding:'3rem 1rem'}}>
            <Hero />

            {/* Live stats bar */}
            {routingHistory.length > 0 && (
              <StatsBar routingHistory={routingHistory} hebbianState={hebbianState} totalSavings={totalSavings} message={message} />
            )}

            <NavTabs activeTab={activeTab} setActiveTab={setActiveTab} />
            <div>
              {activeTab === "city" && <LivingCity routingHistory={routingHistory} hebbianState={hebbianState} message={message} />}
              {activeTab === "builder" && <MessageBuilder message={message} setMessage={setMessage} onSend={handleSend} />}
              {activeTab === "routing" && <AgentRouting message={message} hebbianState={hebbianState} onRouteComplete={handleRouteComplete} />}
              {activeTab === "hebbian" && <HebbianLearning hebbianState={hebbianState} routingHistory={routingHistory} />}
              {activeTab === "trust" && <TrustDecay routingHistory={routingHistory} hebbianState={hebbianState} />}
              {activeTab === "memory" && <MemoryBusSection routingHistory={routingHistory} hebbianState={hebbianState} />}
              {activeTab === "workflow" && <WorkflowDemo message={message} routingHistory={routingHistory} />}
              {activeTab === "architecture" && <TechnicalArchitecture message={message} routingHistory={routingHistory} />}
              {activeTab === "costs" && <CostSavings routingHistory={routingHistory} />}
              {activeTab === "api" && <LLMApiSection routingHistory={routingHistory} hebbianState={hebbianState} />}
              {activeTab === "agents" && <AgentRegistrySection />}
              {activeTab === "setup" && <SetupGuide />}
            </div>
            <div style={{marginTop:'3rem',textAlign:'center',fontSize:'0.75rem',color:'#475569',fontFamily:'monospace'}}>
              <p style={{margin:'0.25rem 0'}}>Authored by Prinston (Apollo) Palmer • Systems Architect</p>
              <p style={{margin:'0.25rem 0'}}>With Claude (Anthropic) • AI Development Partner</p>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<ATPPrototype />, document.getElementById('root'));
  </script>
</body>
</html>
